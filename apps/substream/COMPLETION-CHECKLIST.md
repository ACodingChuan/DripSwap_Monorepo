# Substreams è¿ç§»å®Œæˆæƒ…å†µæ ¸å¯¹æ¸…å•

## ğŸ“‹ æ–‡æ¡£è¦æ±‚å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒè¦æ±‚

#### 1. âœ… V2 çŠ¶æ€æœºåœ¨ Substreams ä¸­çš„å®ç°ç­–ç•¥ï¼ˆ2.3èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- è¯´æ˜å¦‚ä½•é€šè¿‡ Store æ¨¡å—æ¨¡æ‹ŸçŠ¶æ€ä¼ é€’
- è§£é‡Š Transfer â†’ Mint/Burn çš„åŒé˜¶æ®µæäº¤é€»è¾‘
- å¤„ç† Sync äº‹ä»¶çš„çŠ¶æ€ä¼ æ’­é“¾

**å®ç°æƒ…å†µ**ï¼š
- âœ… å·²åœ¨æ–‡æ¡£ä¸­è¯¦ç»†æè¿°çŠ¶æ€æœºå®ç°ç­–ç•¥ï¼ˆ2.3èŠ‚ï¼‰
- âœ… å·²å®ç° `map_extract_data_types` æå–æ‰€æœ‰äº‹ä»¶
- âœ… å·²å®ç° Store æ¨¡å—çš„å®Œæ•´ä¾èµ–é“¾
- âœ… ä»£ç å·²ç¼–è¯‘é€šè¿‡ï¼ˆPhase 2 å®Œæˆï¼‰

---

#### 2. âœ… 18å¼ è¡¨çš„å®Œæ•´æ˜ å°„è¯´æ˜ï¼ˆ2.4èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- æ ¸å¿ƒå®ä½“è¡¨ï¼ˆ6å¼ ï¼‰
- äº‹ä»¶è¡¨ï¼ˆ3å¼ ï¼‰
- æ—¶åºèšåˆè¡¨ï¼ˆ6å¼ ï¼‰
- ç´¢å¼•è¡¨ï¼ˆ1å¼ ï¼‰
- Bridge ç›¸å…³è¡¨ï¼ˆ2å¼ ï¼‰

**å®ç°æƒ…å†µ**ï¼š
- âœ… æ–‡æ¡£ä¸­è¯¦ç»†åˆ—å‡ºæ‰€æœ‰18å¼ è¡¨ï¼ˆ2.4èŠ‚ï¼‰
- âœ… æ‰€æœ‰è¡¨æ ‡æ³¨ä¸º"å®Œå…¨å…¼å®¹"
- âœ… Schema å®šä¹‰å®Œæ•´ï¼ˆ`schema.graphql` å’Œ `schema.sql`ï¼‰
- âœ… ä»£ç ä¸­å®ç°äº†æ‰€æœ‰è¡¨çš„ EntityChanges è¾“å‡ºï¼ˆ`db.rs`ï¼‰

**è¡¨ç»“æ„æ¸…å•**ï¼š
1. âœ… `uniswap_factory_stream`
2. âœ… `tokens_stream`
3. âœ… `pairs_stream`
4. âœ… `bundle_stream` ï¼ˆå« roundId å­—æ®µï¼‰
5. âœ… `transactions_stream`
6. âœ… `users_stream`
7. âœ… `mints_stream`
8. âœ… `burns_stream`
9. âœ… `swaps_stream`
10. âœ… `uniswap_day_data_stream`
11. âœ… `pair_day_data_stream`
12. âœ… `pair_hour_data_stream`
13. âœ… `token_day_data_stream`
14. âœ… `token_hour_data_stream`
15. âœ… `token_minute_data_stream`
16. âœ… `pair_token_lookup_stream`
17. âœ… `bridge_transfers_stream`
18. âœ… `bridge_config_events_stream`

---

#### 3. âœ… ETH/USD ä»·æ ¼é€šè¿‡ Oracle é“¾ä¸ŠæŸ¥è¯¢ï¼ˆ2.5èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- ä¸ä½¿ç”¨æ·±åº¦æ± å­å¹³å‡ä»·
- ä½¿ç”¨ Chainlink é£æ ¼çš„ Oracle
- å‚è€ƒ `apps/subgraph/uniswap/src/common/pricing.ts`

**å®ç°æƒ…å†µ**ï¼š
- âœ… æ–‡æ¡£ä¸­è¯¦ç»†æè¿° Oracle æŸ¥è¯¢ç­–ç•¥ï¼ˆ2.5èŠ‚ï¼‰
- âœ… **ä»£ç å·²å®ç°**ï¼šChainlink Oracle `latestRoundData()` + `decimals`ï¼Œå¤±è´¥å›é€€ WETH/USDC æ± ä»·
- âœ… **Oracle åœ°å€å·²é…ç½®**ï¼šSepolia / Scroll Sepolia

---

#### 4. âœ… Bundle æ–°å¢ RoundId å­—æ®µï¼ˆ2.4èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
```graphql
type Bundle {
  id: ID!
  ethPrice: BigDecimal!
  roundId: BigInt!  # æ–°å¢å­—æ®µ
}
```

**å®ç°æƒ…å†µ**ï¼š
- âœ… æ–‡æ¡£ä¸­å·²è¯´æ˜ï¼ˆ2.4.1èŠ‚ï¼‰
- âœ… `schema.graphql` ä¸­å·²æ·»åŠ 
- âœ… `schema.sql` ä¸­å·²æ·»åŠ 
- âœ… **ä»£ç å·²å®ç°**ï¼š`db.rs` + `store_eth_prices` å†™å…¥ roundId

---

#### 5. âœ… Sepolia å’Œ Scroll Sepolia åŒé“¾é…ç½®ï¼ˆ2.6èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- Sepolia (chainId: 11155111)
- Scroll Sepolia (chainId: 534351)
- é…ç½® Pinax endpointã€API Keyã€JWT Token

**å®ç°æƒ…å†µ**ï¼š
- âœ… æ–‡æ¡£ä¸­è¯¦ç»†é…ç½®ï¼ˆ2.6èŠ‚ï¼‰
- âœ… å·²ç”Ÿæˆä¸¤ä¸ª SPKG æ–‡ä»¶ï¼š
  - `dripswap-v2-sepolia-v0.1.0.spkg` (927KB)
  - `dripswap-v2-scroll-sepolia-v0.1.0.spkg` (927KB)
- âœ… JWT Token å·²é…ç½®ï¼ˆæ­£åœ¨æµ‹è¯•ä¸­ï¼‰
- âœ… Pinax endpoint å·²é…ç½®ï¼š
  - Sepolia: `https://sepolia.substreams.pinax.network:443`
  - Scroll Sepolia: `https://scrsepolia.substreams.pinax.network:443`

---

#### 6. âœ… Pinax çš„ API Key å’Œ JWT é…ç½®ï¼ˆ2.6.3èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- API Key
- JWT Token
- ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹

**å®ç°æƒ…å†µ**ï¼š
- âœ… æ–‡æ¡£ä¸­å·²å®Œæ•´é…ç½®ï¼ˆ2.6.3èŠ‚ï¼‰
- âœ… API Key: `cd6d1326907fb01ac311507e73f286371de5703f495c1dc4`
- âœ… JWT Token: å®Œæ•´çš„ä¸‰æ®µå¼ tokenï¼ˆå·²é…ç½®ï¼‰
- âœ… Docker Compose é…ç½®ç¤ºä¾‹å·²æä¾›

---

#### 7. âœ… é¡¹ç›®ç›®å½•ç»“æ„è¯´æ˜ï¼ˆPhase 1ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- è¯´æ˜é¡¹ç›®å»ºç«‹åœ¨ `apps/substream`
- ä¿æŒ Monorepo ç»“æ„

**å®ç°æƒ…å†µ**ï¼š
- âœ… Phase 1 ä¸­è¯¦ç»†æè¿°é¡¹ç›®ç›®å½•ç»“æ„
- âœ… å±•ç¤ºå®Œæ•´çš„ Monorepo ç›®å½•æ ‘
- âœ… è¯´æ˜ Monorepo é›†æˆä¼˜åŠ¿
- âœ… é¡¹ç›®å·²åˆ›å»ºåœ¨ `apps/substream` ç›®å½•

---

#### 8. âœ… å•æ•°æ®åº“ + Chain å­—æ®µåŒºåˆ†æ–¹æ¡ˆï¼ˆ2.6.4èŠ‚ï¼‰

**æ–‡æ¡£è¦æ±‚**ï¼š
- é‡‡ç”¨å•æ•°æ®åº“ï¼Œæ¯ä¸ªè¡¨å¢åŠ  chainId å’Œ chainName å­—æ®µ
- å¤åˆä¸»é”®è®¾è®¡
- BFF å±‚å¼ºåˆ¶çº¦æŸ
- Docker Compose é…ç½®

**å®ç°æƒ…å†µ**ï¼š
- âœ… æ–‡æ¡£ä¸­è¯¦ç»†è®¾è®¡ï¼ˆ2.6.4èŠ‚ï¼‰
- âœ… æä¾›å®Œæ•´çš„ SQL è®¾è®¡ç¤ºä¾‹
- âœ… æä¾› BFF Repository åŸºç±»è®¾è®¡æ€è·¯
- âœ… æä¾› Docker Compose é…ç½®ç¤ºä¾‹
- âš ï¸ **å®é™…æ•°æ®åº“è¡¨åˆ›å»ºå¾…æ‰§è¡Œ**ï¼šå½“å‰ä»…æœ‰è®¾è®¡ï¼Œæœªå®é™…åˆ›å»ºè¡¨

---

### âœ… å·²å®Œæˆçš„å…³é”®è¡¥é½

#### 1. âœ… Oracle ä»·æ ¼æŸ¥è¯¢çš„ä»£ç å®ç°

**ç°çŠ¶**ï¼š
- âœ… æ–‡æ¡£ä¸­å·²è¯¦ç»†è¯´æ˜é€»è¾‘
- âœ… å‚è€ƒäº† `pricing.ts` çš„å®ç°
- âœ… **Rust ä»£ç å·²å®ç° Oracle è°ƒç”¨**ï¼ˆå¤±è´¥å›é€€ç™½åå•æ± å­ä»·æ ¼ï¼‰
- âœ… Sepolia / Scroll Sepolia Oracle åœ°å€å·²é…ç½®

---

#### 2. âœ… Bundle.roundId å­—æ®µçš„å®é™…å†™å…¥

**ç°çŠ¶**ï¼š
- âœ… Schema ä¸­å·²å®šä¹‰
- âœ… **db.rs ä¸­å·²å†™å…¥ roundId**

---

### ğŸš§ å¾…æ‰§è¡Œçš„åç»­ä»»åŠ¡

#### Phase 3: æµ‹è¯•ä¸éªŒè¯ï¼ˆå½“å‰é˜¶æ®µï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… SPKG æ‰“åŒ…æˆåŠŸï¼ˆä¸¤ä¸ªé“¾éƒ½å·²ç”Ÿæˆï¼‰
- ğŸ”„ **æ­£åœ¨è¿›è¡Œ**ï¼šGUI/å‘½ä»¤è¡Œæµ‹è¯•ï¼ˆéœ€è¦æ­£ç¡®çš„ endpointï¼‰
- â³ å¾…æ‰§è¡Œï¼šæ•°æ®å¯¹æ¯”éªŒè¯
- â³ å¾…æ‰§è¡Œï¼šæ€§èƒ½ä¼˜åŒ–

**æµ‹è¯•æ¸…å•**ï¼š
1. âœ… ç¼–è¯‘é€šè¿‡
2. âœ… SPKG æ‰“åŒ…æˆåŠŸ
3. ğŸ”„ **æ­£åœ¨è¿›è¡Œ**ï¼š`map_pools_created` æ¨¡å—æµ‹è¯•
4. â³ `map_extract_data_types` æ¨¡å—æµ‹è¯•
5. â³ `graph_out` å®Œæ•´è¾“å‡ºæµ‹è¯•
6. â³ ä¸ Subgraph æ•°æ®å¯¹æ¯”

**æµ‹è¯•å‘½ä»¤**ï¼ˆç”¨æˆ·æ­£åœ¨æ‰§è¡Œï¼‰ï¼š
```bash
# æ–¹æ¡ˆ1ï¼šGUI æ¨¡å¼
substreams gui dripswap-v2-sepolia-v0.1.0.spkg map_pools_created \
  -e https://sepolia.substreams.pinax.network:443 \
  --start-block 9573280 \
  --stop-block +100

# æ–¹æ¡ˆ2ï¼šå‘½ä»¤è¡Œæ¨¡å¼
substreams run dripswap-v2-sepolia-v0.1.0.spkg map_pools_created \
  -e https://sepolia.substreams.pinax.network:443 \
  --start-block 9573280 \
  --stop-block +10 \
  --output json
```

---

#### Phase 4: æ•°æ®åº“éƒ¨ç½²ä¸ Sink å¯åŠ¨ï¼ˆå¾…æ‰§è¡Œï¼‰

**å¾…å®Œæˆäº‹é¡¹**ï¼š
1. â³ åˆ›å»º PostgreSQL æ•°æ®åº“å’Œè¡¨ç»“æ„
2. â³ å¯åŠ¨ `substreams-sink-postgres` æœåŠ¡
3. â³ ç›‘æ§æ•°æ®åŒæ­¥è¿›åº¦
4. â³ æ•°æ®éªŒè¯ä¸å¯¹æ¯”

---

#### Phase 5: BFF å±‚é€‚é…ï¼ˆå¾…æ‰§è¡Œï¼‰

**å¾…å®Œæˆäº‹é¡¹**ï¼š
1. â³ å®ç°è¡¨ååˆ‡æ¢é€»è¾‘ï¼ˆ`USE_STREAM_TABLES` ç¯å¢ƒå˜é‡ï¼‰
2. â³ åˆ›å»º BaseRepository åŸºç±»ï¼ˆchainId è‡ªåŠ¨æ³¨å…¥ï¼‰
3. â³ æ›´æ–°æ‰€æœ‰ Repository ç»§æ‰¿ BaseRepository
4. â³ è°ƒæ•´ç¼“å­˜ç­–ç•¥ï¼ˆTTL ä» 5åˆ†é’Ÿ â†’ 1åˆ†é’Ÿï¼‰
5. â³ ç¦ç”¨ Subgraph åŒæ­¥æœåŠ¡å’Œ WebSocket ç›‘å¬

---

## ğŸ“Š æ€»ä½“å®Œæˆåº¦è¯„ä¼°

### æ–‡æ¡£è®¾è®¡å±‚é¢
- âœ… **100% å®Œæˆ**ï¼šæ‰€æœ‰æ–‡æ¡£è¦æ±‚å‡å·²è¯¦ç»†è¯´æ˜

### ä»£ç å®ç°å±‚é¢
- âœ… **Phase 1ï¼ˆé¡¹ç›®åˆå§‹åŒ–ï¼‰**ï¼š100% å®Œæˆ
- âœ… **Phase 2ï¼ˆäº‹ä»¶å¤„ç†é€‚é…ï¼‰**ï¼š95% å®Œæˆ
  - âœ… æ ¸å¿ƒ Map/Store æ¨¡å—å·²å®ç°
  - âœ… ç¼–è¯‘é€šè¿‡
  - âš ï¸ TokenMinuteData å½’æ¡£æœºåˆ¶å¾…è¡¥å……
- ğŸ”„ **Phase 3ï¼ˆæµ‹è¯•ä¸éªŒè¯ï¼‰**ï¼š20% å®Œæˆ
  - âœ… SPKG æ‰“åŒ…æˆåŠŸ
  - ğŸ”„ æ­£åœ¨æµ‹è¯• `map_pools_created`ï¼ˆendpoint é—®é¢˜å·²ä¿®å¤ï¼‰
  - â³ å®Œæ•´æµ‹è¯•å¾…æ‰§è¡Œ
- â³ **Phase 4ï¼ˆæ•°æ®åº“éƒ¨ç½²ï¼‰**ï¼š0% å®Œæˆ
- â³ **Phase 5ï¼ˆBFF é€‚é…ï¼‰**ï¼š0% å®Œæˆ

### å…³é”®é‡Œç¨‹ç¢‘
- âœ… **è®¾è®¡å®Œæˆ**ï¼š2024-12-XXï¼ˆæ¶æ„æ–‡æ¡£å®Œæˆï¼‰
- âœ… **ä»£ç ç¼–è¯‘**ï¼š2024-12-XXï¼ˆPhase 2 å®Œæˆï¼‰
- ğŸ”„ **æ¨¡å—æµ‹è¯•**ï¼šè¿›è¡Œä¸­ï¼ˆPhase 3ï¼‰
- â³ **æ•°æ®åŒæ­¥**ï¼šå¾…å¯åŠ¨
- â³ **ç”Ÿäº§åˆ‡æ¢**ï¼šå¾…æ‰§è¡Œ

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆç”¨æˆ·æ­£åœ¨æ‰§è¡Œï¼‰
1. ğŸ”„ **æµ‹è¯• map_pools_created**ï¼šä½¿ç”¨æ­£ç¡®çš„ Pinax endpoint
2. â³ **æµ‹è¯•å…¶ä»–æ¨¡å—**ï¼šé€æ­¥éªŒè¯æ‰€æœ‰ Store æ¨¡å—
3. â³ **æµ‹è¯• graph_out**ï¼šéªŒè¯å®Œæ•´çš„ EntityChanges è¾“å‡º

### çŸ­æœŸè®¡åˆ’ï¼ˆ1-2å¤©ï¼‰
1. â³ å®Œæˆæ‰€æœ‰æ¨¡å—çš„åŠŸèƒ½æµ‹è¯•
2. â³ éªŒè¯ Oracle roundId ä¸ä»·æ ¼ä¸€è‡´æ€§
3. â³ ä¿®å¤æµ‹è¯•ä¸­å‘ç°çš„é—®é¢˜

### ä¸­æœŸè®¡åˆ’ï¼ˆ1å‘¨ï¼‰
1. â³ éƒ¨ç½² PostgreSQL æ•°æ®åº“
2. â³ å¯åŠ¨ substreams-sink-postgres
3. â³ éªŒè¯æ•°æ®å†™å…¥å’Œä¸€è‡´æ€§
4. â³ è°ƒæ•´ BFF å±‚ä»£ç 

### é•¿æœŸè®¡åˆ’ï¼ˆ1ä¸ªæœˆï¼‰
1. â³ ç°åº¦åˆ‡æ¢åˆ° Substreams æ•°æ®æº
2. â³ ç›‘æ§ç¨³å®šæ€§
3. â³ æ¸…ç†é—ç•™çš„ Subgraph åŒæ­¥ä»£ç 

---

## ğŸ“ å¤‡æ³¨

### è®¾è®¡å†³ç­–
- âœ… é‡‡ç”¨å•æ•°æ®åº“æ–¹æ¡ˆï¼ˆè€Œéç‹¬ç«‹æ•°æ®åº“ï¼‰ï¼Œç®€åŒ–æ¶æ„
- âœ… ä¿ç•™ Subgraph è¡¨ä½œä¸ºå¤‡ä»½ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
- âœ… Oracle ä»·æ ¼æŸ¥è¯¢å·²æ¥å…¥ï¼ˆå¤±è´¥å›é€€æ± ä»·ï¼‰

### æŠ€æœ¯å€ºåŠ¡
- Oracle åˆçº¦åœ°å€å·²ç¡®å®šï¼Œéœ€éªŒè¯æµ‹è¯•ç½‘å¯ç”¨æ€§ä¸ç¨³å®šæ€§
- Bridge äº‹ä»¶å¤„ç†é€»è¾‘éœ€è¦æ ¹æ®å®é™…åˆçº¦è°ƒæ•´
- OHLC æ•°æ®çš„ Store æ¸…ç†ç­–ç•¥éœ€è¦æ ¹æ®å®é™…æ•°æ®é‡è°ƒä¼˜

### é£é™©æç¤º
- Pinax çš„ JWT Token æœ‰æ•ˆæœŸè‡³ 2026å¹´ï¼ˆé•¿æœŸæœ‰æ•ˆï¼‰
- æµ‹è¯•ç½‘æ•°æ®å¯èƒ½ä¸å®Œæ•´ï¼Œå»ºè®®å…ˆç”¨ Sepolia éªŒè¯
- å•æ•°æ®åº“æ–¹æ¡ˆéœ€è¦ç¡®ä¿ BFF å±‚ä¸¥æ ¼æ³¨å…¥ chainIdï¼Œé˜²æ­¢è·¨é“¾æ•°æ®æ··æ·†

---

**æœ€åæ›´æ–°**: 2024-12-XX  
**å½“å‰é˜¶æ®µ**: Phase 3 - æ¨¡å—åŠŸèƒ½æµ‹è¯•ï¼ˆæ­£åœ¨è¿›è¡Œä¸­ï¼‰  
**ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘**: å®Œæˆæ‰€æœ‰æ¨¡å—æµ‹è¯•ï¼Œå¯åŠ¨æ•°æ®åŒæ­¥
