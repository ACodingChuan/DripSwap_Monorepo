# 4.1 SWAP 功能规范

**版本**：v1.3  
**状态**：开发中 (Phase 1 完成，纯前端交互)  
**最后更新**：2025-11-28  
**负责人**：前端团队

---

## 1. 背景与动机

### 为什么需要这个功能？

DripSwap 作为基于测试网的跨链 DEX，Swap 是最核心的功能。用户需要能够：
- 查询交易对的实时价格和流动性
- 获取交易报价（quote）
- 执行代币交换

### 解决什么问题？

1. **实时性**：通过纯前端计算实现 0ms 延迟的报价体验
2. **多链支持**：支持 Sepolia 和 Scroll Sepolia 网络无缝切换
3. **报价服务**：提供快速、准确的交易报价

### 架构定位

- **纯前端计算**：Swap Quote 完全由前端 `viem` 实现，不依赖后端 Quote 服务
- **本地地址簿**：前端维护多链 Token 和 Pair 配置
- **无后端依赖**：Swap 的**实时交互**过程（报价、授权、执行）完全直接与链上交互。
- **历史记录剥离**：历史记录查询等读需求移至 `specs/4.8-READ-FROM-ETL.md` 统一规划。

---

## 2. 目标与范围

### 功能目标
- 目标 1：用户能够选择交易对并实时查看报价（amountOut、价格影响、手续费）
- 目标 2：用户能够在输入金额时**立即**获取快速报价（0ms 防抖）
- 目标 3：用户能够自定义滑点和截止时间
- 目标 4：系统自动进行余额校验，余额不足时阻止交易

### 范围
- 包含：
  - **前端直接计算**：快速报价（使用 viem eth_call 获取实时链上数据）
  - **前端本地地址簿**：从静态配置文件加载 Pair 地址
  - **前端计算逻辑**：价格影响、手续费、滑点
  - **多链支持**：动态 RPC 配置，网络自动检测
  - **多跳路由 (Smart Routing)**：支持 1-Hop 自动寻路 (Base Tokens)
- 不包含：
  - <span style="color:red">Gas 费用估算（Phase 1 暂时移除，待后续优化）</span>
  - 跨链 Swap（属于 Bridge 功能）
  - **历史交易记录**（移至 4.8）
  - **K线图/图表**（移至 4.8）

### 架构设计更新

**原则调整**：
```
前端直接计算：Swap Quote（使用 viem 直接 eth_call）
链上直接执行：Swap Execution (Uniswap V2 Router)
历史数据查询：移至 4.8 Spec (ETL -> Postgres -> GraphQL)
```

---

## 3. 需求定义

### 用户故事

#### Story 1：选择交易对并获取实时报价

**角色**：DripSwap 用户  
**目标**：我想选择两个 Token 并输入交易金额，实时查看预期输出和交易详情  
**价值**：以便在充分了解交易成本和价格影响的情况下做出交易决策

**前端交互流程**（When-Case-Do）：

**WHEN** 我想进行 Token 交换时
- **前端展示**：
  - 页面位置：`/app/routes/swap.tsx`
  - 组件状态：显示 Swap 卡片，包含两个资产输入框（Sell/Buy）
  - 初始数据加载：
    - 从本地 Config 加载 Token 列表
    - 默认选中前两个不同的 Token（如 vETH 和 vUSDT）
    - 调用 Wagmi `useBalance()` 获取用户钱包余额

**CASE 1** 我在 Sell 输入框输入金额（如 "1"）
- **前端响应**：
  - UI 变化：
    - `amountIn` 状态更新为 "1"
    - **快速报价计算**（**0ms 实时**）：
      - 用户输入时立即触发（无需防抖）
      - 调用前端函数 `calculateQuote()`
      - Quote 状态区显示 "Calculating quote..."
  - 数据请求：调用前端函数 `calculateQuote()`
  - 参数传递：`{ chainId, tokenIn, tokenOut, amountIn }`

**CASE 2** 前端计算报价成功
- **前端响应**：
  - UI 变化：
    - **Buy 输入框**：更新为计算出的 amountOut
    - **价格信息栏**：更新汇率
    - **详情区域**：
      - Price Impact: --%
      - Protocol Fee (0.3%): --
      - Min. received: --
      - Route: Direct / via vETH
    - **Swap 按钮**：变为可点击状态（蓝色）

**CASE 3** 我点击 Swap 按钮
- **前端响应**：
  - UI 变化：
    - 按钮文字变为 "Approving..." (如需授权) 或 "Swapping..."
    - 弹出钱包签名确认框
  - 数据请求：
    - 调用 `useSwapExecution()` hook
    - 步骤 1：检查 Allowance，如不足触发 `approve()`
    - 步骤 2：触发 `swapExactTokensForTokens()`
    - 步骤 3：等待链上确认
  - 用户反馈：
    - 成功：Toast "Swap Successful"
    - 失败：Toast "Swap Failed"

---

#### Story 2：调整交易设置

**角色**：DripSwap 用户  
**目标**：我想调整滑点容忍度和交易截止时间  
**价值**：以便控制交易风险和执行条件

**前端交互流程**（When-Case-Do）：

**WHEN** 我想调整交易设置时
- **前端展示**：
  - 页面位置：`/app/routes/swap.tsx` - Settings Dialog
  - 初始数据：Auto slippage (Enabled), Manual slippage (0.5%)

**CASE 1** 我点击设置按钮并修改滑点
- **前端响应**：
  - UI 变化：
    - 切换 Auto/Manual
    - 选择 0.1% / 0.5% / 1.0%
  - 影响：立即触发重新报价计算

**DO** 系统应该
- **成功场景**：设置立即生效，影响后续报价计算（Min Received 变化）

---

### 功能需求

| 需求 ID | 描述 | 优先级 | 状态 |
|--------|------|-------|------|
| FR-001 | 前端本地加载 Token 列表 | P0 | ✅ 已完成 |
| FR-002 | 实时计算报价 (Direct/Multi-hop) | P0 | ✅ 已完成 |
| FR-003 | 交易执行 (Approve/Swap) | P0 | ✅ 已完成 |
| FR-004 | 多链切换支持 | P0 | ✅ 已完成 |
| FR-005 | 交易设置 (Slippage/Deadline) | P1 | ✅ 已完成 |
| FR-006 | <span style="color:red">Gas 费用估算</span> | P2 | 🔴 待开发 (Phase 2) |

---

## 4. 技术方案

### 4.1 架构设计

```
前端 (React + Wagmi + Viem)
  ↓ 本地 Token Config
  ↓ 直接计算 Quote (Multicall read pairs)
  ↓ 直接调用 Uniswap V2 Router (写交易)
```

### 4.2 实现逻辑

**Quote 计算 (`calculateQuote.ts`)**:
1. **Fast Path**: 优先尝试直连 Pair，并行获取 Reserves/Token0/OraclePrice，直接计算返回。
2. **Fallback**: 如果直连失败，尝试 1-Hop (Base Tokens) 寻路，找到最佳路径后计算。
3. **Price Impact**: 基于 Reserves 计算 Spot Price vs Execution Price。

**Execution (`useSwapExecution.ts`)**:
1. **Approve**: 检查并授权 TokenIn。
2. **Swap**: 调用 `swapExactTokensForTokens`，支持自定义路径 `path`。

---

## 5. 实现任务清单

### 5.1 前端任务 (React)

- [x] **Swap 核心功能**
  - [x] 多链配置管理
  - [x] 实时报价计算 (useSwapQuote)
  - [x] 交易执行 (useSwapExecution)
  - [x] 余额检查与 Token 选择互斥逻辑
  - [x] 多跳路由支持

- [x] **交易设置**
  - [x] Settings Dialog UI
  - [x] Slippage/Deadline State

---

## 6. 风险与缓解

| 风险 | 影响 | 概率 | 缓解方案 |
|-----|------|------|----------|
| RPC 限流 | 报价失败 | 中 | 使用付费 RPC / 减少请求频率 |
| 流动性不足 | 无法成交 | 低 | 前端提示 Price Impact 过高 |
| 抢跑/夹子 | 用户受损 | 低 | 测试网暂不考虑，主网需 GuardedRouter |

---

## 7. 交付清单

### 前端
- [x] Swap 页面组件
- [x] Quote Calculation Logic
- [x] Execution Hooks
- [x] 单元测试/集成测试

*(后端交付项已移至 4.8)*

---

## 8. 参考文档

- [Uniswap V2 白皮书](https://uniswap.org/whitepaper.pdf)
- [统一读服务 Spec](./4.8-READ-FROM-ETL.md)
