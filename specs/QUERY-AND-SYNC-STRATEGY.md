# DripSwap æŸ¥è¯¢ä¸åŒæ­¥ç­–ç•¥

> **æ–‡æ¡£ç›®çš„**ï¼šå®šä¹‰æ‰€æœ‰é¡µé¢åŠŸèƒ½çš„æ•°æ®æ¥æºã€æŸ¥è¯¢æ–¹å¼å’ŒåŒæ­¥ç­–ç•¥  
> **æ¨¡å—èŒƒå›´**ï¼šSwapã€Poolã€Tokensã€Explore é¡µé¢  
> **æœ€åæ›´æ–°**ï¼š2025-12-18

---

## ğŸ“‹ ç›®å½•

1. [Swap é¡µé¢æ¨¡å—](#swap-é¡µé¢æ¨¡å—)
   - 2.1.1 [æœ€è¿‘äº¤æ˜“åˆ—è¡¨](#åŠŸèƒ½-211æœ€è¿‘äº¤æ˜“åˆ—è¡¨)
   - 2.1.2 [24h äº¤æ˜“ç»Ÿè®¡](#åŠŸèƒ½-21224h-äº¤æ˜“ç»Ÿè®¡)
2. [Pool é¡µé¢æ¨¡å—](#pool-é¡µé¢æ¨¡å—)
   - 3.1.1 [Pool åˆ—è¡¨ï¼ˆTVL æ’åºï¼‰](#åŠŸèƒ½-311pool-åˆ—è¡¨tvl-æ’åº)
   - 3.1.2 [Pool è¯¦æƒ…é¡µ](#åŠŸèƒ½-312pool-è¯¦æƒ…é¡µ)
   - 3.1.3 [ç”¨æˆ·æµåŠ¨æ€§ä»“ä½](#åŠŸèƒ½-313ç”¨æˆ·æµåŠ¨æ€§ä»“ä½)
3. [Tokens é¡µé¢æ¨¡å—](#tokens-é¡µé¢æ¨¡å—)
   - 4.1.1 [Token åˆ—è¡¨ï¼ˆæŒ‰ TVL æ’åºï¼‰](#åŠŸèƒ½-411token-åˆ—è¡¨æŒ‰-tvl-æ’åº)
   - 4.1.2 [Token è¯¦æƒ…é¡µ](#åŠŸèƒ½-412token-è¯¦æƒ…é¡µ)
4. [Explore é¡µé¢æ¨¡å—](#explore-é¡µé¢æ¨¡å—)
   - 5.1.1 [å…¨é“¾äº¤æ˜“æµ](#åŠŸèƒ½-511å…¨é“¾äº¤æ˜“æµ)
   - 5.1.2 [å…¨å±€ç»Ÿè®¡æ•°æ®](#åŠŸèƒ½-512å…¨å±€ç»Ÿè®¡æ•°æ®)
5. [å®æ—¶æ¨é€æŠ€æœ¯ç»†èŠ‚](#å®æ—¶æ¨é€æŠ€æœ¯ç»†èŠ‚)
6. [è¾¹ç•Œæƒ…å†µä¸é—®é¢˜å¤„ç†](#è¾¹ç•Œæƒ…å†µä¸é—®é¢˜å¤„ç†)
7. [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
8. [æ•°æ®æ¥æºæ€»ç»“](#æ•°æ®æ¥æºæ€»ç»“)

---

## Swap é¡µé¢æ¨¡å—

### æ¨¡å—æ¦‚è¿°

#### Swap é¡µé¢å®šä½

**æ ¸å¿ƒåŠŸèƒ½**ï¼šç”¨æˆ·è¿›è¡Œä»£å¸äº¤æ¢çš„ä¸»è¦ç•Œé¢

**ç”¨æˆ·åœºæ™¯**ï¼š
- ç”¨æˆ·é€‰æ‹©è¾“å…¥/è¾“å‡ºä»£å¸
- æŸ¥çœ‹å½“å‰ä»·æ ¼å’Œæ±‡ç‡ï¼ˆå‰ç«¯ç›´æ¥ä»é“¾ä¸ŠæŸ¥è¯¢ï¼‰
- æŸ¥çœ‹äº¤æ˜“è·¯å¾„ï¼ˆå‰ç«¯ç›´æ¥è®¡ç®—ï¼‰
- æŸ¥çœ‹æœ€è¿‘äº¤æ˜“è®°å½•
- æŸ¥çœ‹ 24h äº¤æ˜“ç»Ÿè®¡

**é¡µé¢è·¯ç”±**ï¼š`/swap`

**è®¿é—®é¢‘ç‡**ï¼šæé«˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

> **è¯´æ˜**ï¼šå®æ—¶ä»·æ ¼ã€Token ä¿¡æ¯ã€äº¤æ˜“è·¯å¾„ç­‰åŠŸèƒ½å·²ç”±å‰ç«¯ç›´æ¥ä»é“¾ä¸ŠæŸ¥è¯¢å®ç°ï¼Œä¸éœ€è¦åç«¯æ”¯æŒã€‚

---

### åŠŸèƒ½ 2.1.1ï¼šæœ€è¿‘äº¤æ˜“åˆ—è¡¨

**åŠŸèƒ½æè¿°**ï¼šæ˜¾ç¤ºè¯¥äº¤æ˜“å¯¹æœ€è¿‘çš„ 10 ç¬”äº¤æ˜“è®°å½•

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦äº†è§£è¯¥äº¤æ˜“å¯¹çš„æœ€è¿‘äº¤æ˜“æƒ…å†µï¼Œåˆ¤æ–­å¸‚åœºæ´»è·ƒåº¦

**æ•°æ®é‡çº§**ï¼š10 æ¡è®°å½•

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­ ä¸­  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šå®æ—¶ï¼ˆæ¯ç¬” Swap åéƒ½æœ‰æ–°äº¤æ˜“ï¼‰

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ |
|-------|-------|------|
| äº¤æ˜“å“ˆå¸Œ | swaps | transaction_id |
| äº¤æ˜“æ—¶é—´ | swaps | timestamp |
| äº¤æ˜“è´¦æˆ· | swaps | from_address |
| Token0 æ•°é‡ | swaps | amount0_in, amount0_out |
| Token1 æ•°é‡ | swaps | amount1_in, amount1_out |
| USD ä»·å€¼ | swaps | amount_usd |

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚ï¼ˆchainId, pairAddress, firstï¼‰
    â†“
æ£€æŸ¥ Redis ç¼“å­˜ï¼ˆKey: recent-swaps:{chainId}:{pairAddress}ï¼‰
    â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›ï¼ˆ< 5msï¼‰
    â””â”€ æœªå‘½ä¸­ â†’ æŸ¥è¯¢ PostgreSQL swaps è¡¨
              â†“
              WHERE chain_id = ? AND pair_id = ?
              ORDER BY timestamp DESC
              LIMIT 10
              â†“
              å†™å…¥ Redis ç¼“å­˜ï¼ˆTTL: 60sï¼‰
              â†“
              è¿”å›ç»“æœï¼ˆ< 50msï¼‰
```

**SQL æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
SELECT 
  id,
  transaction_id,
  timestamp,
  pair_id,
  from_address,
  amount0_in,
  amount0_out,
  amount1_in,
  amount1_out,
  amount_usd
FROM swaps
WHERE chain_id = 'sepolia' 
  AND pair_id = '0xdef...'
ORDER BY timestamp DESC
LIMIT 10;
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  pairRecentSwaps(
    chainId: String!
    pairAddress: String!
    first: Int = 10
  ): [Swap!]!
}

type Swap {
  id: ID!
  transactionId: String!
  timestamp: Int!
  pairAddress: String!
  fromAddress: String!
  amount0In: String!
  amount0Out: String!
  amount1In: String!
  amount1Out: String!
  amountUsd: String!
}
```

**æŸ¥è¯¢å‚æ•°è¯´æ˜**ï¼š
- `chainId`ï¼šé“¾ IDï¼ˆå¦‚ "11155111" è¡¨ç¤º Sepoliaï¼‰
- `pairAddress`ï¼šPair åˆçº¦åœ°å€ï¼ˆç”¨äºç²¾ç¡®æŸ¥è¯¢ç‰¹å®šäº¤æ˜“å¯¹ï¼‰
- `first`ï¼šè¿”å›è®°å½•æ•°ï¼ˆé»˜è®¤ 10 æ¡ï¼‰

---

##### 2. WS ç›‘å¬å®æ—¶æ›´æ–°æµç¨‹

**ç›‘å¬äº‹ä»¶**ï¼šSwap äº‹ä»¶

**å¤„ç†é€»è¾‘**ï¼š
```
åŒºå—é“¾è§¦å‘ Swap äº‹ä»¶
    â†“
WS ç›‘å¬å™¨æ•è·äº‹ä»¶
    â†“
è§£æäº‹ä»¶æ•°æ®ï¼ˆtxHash, pairAddress, amounts, timestamp ç­‰ï¼‰
    â†“
å†™å…¥ Redisï¼ˆLPUSH åˆ° List å¤´éƒ¨ï¼‰
    â”œâ”€ Key: recent-swaps:{chainId}:{pairAddress}
    â”œâ”€ ä¿ç•™æœ€è¿‘ 10 æ¡ï¼ˆLTRIM 0 9ï¼‰
    â””â”€ ä¸å†™æ•°æ®åº“ï¼ˆé™ä½æ•°æ®åº“å‹åŠ›ï¼‰
    â†“
é€šçŸ¥å‰ç«¯æ›´æ–°ï¼ˆé€šè¿‡ Server-Sent Events æˆ–è½®è¯¢ï¼‰
    â†“
å‰ç«¯é‡æ–°æŸ¥è¯¢ GraphQLï¼ˆä» Redis è·å–æœ€æ–°æ•°æ®ï¼‰
    â†“
ç”¨æˆ· B çœ‹åˆ°æœ€æ–°äº¤æ˜“ï¼ˆæ— éœ€æ‰‹åŠ¨åˆ·æ–°ï¼‰
```

**å…³é”®ç‚¹**ï¼š
- âœ… åªå†™ Redisï¼Œä¸å†™æ•°æ®åº“
- âœ… ä½¿ç”¨ List ç»“æ„ï¼ŒLPUSH æ–°æ•°æ®åˆ°å¤´éƒ¨
- âœ… LTRIM ä¿ç•™æœ€è¿‘ 10 æ¡
- âœ… é€šçŸ¥å‰ç«¯æ›´æ–°ï¼ˆé€šè¿‡ SSE æˆ–è½®è¯¢ï¼‰

**å®æ—¶æ¨é€æŠ€æœ¯æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ 1ï¼šServer-Sent Events (SSE)** - æ¨è
```
å‰ç«¯å»ºç«‹ SSE è¿æ¥
    â†“
GET /api/events/swap-updates?pairAddress=0xdef...
    â†“
åç«¯ä¿æŒè¿æ¥ï¼ŒWS ç›‘å¬åˆ°æ–°äº¤æ˜“æ—¶æ¨é€äº‹ä»¶
    â†“
event: swap-update
data: {"pairAddress": "0xdef...", "txHash": "0xabc..."}
    â†“
å‰ç«¯æ”¶åˆ°äº‹ä»¶ï¼Œé‡æ–°æŸ¥è¯¢ GraphQL
    â†“
ç”¨æˆ·çœ‹åˆ°æœ€æ–°äº¤æ˜“ï¼ˆæ— éœ€åˆ·æ–°é¡µé¢ï¼‰
```

**æ–¹æ¡ˆ 2ï¼šçŸ­è½®è¯¢ (Polling)** - å¤‡é€‰
```
å‰ç«¯æ¯ 5 ç§’æŸ¥è¯¢ä¸€æ¬¡ GraphQL
    â†“
query { pairRecentSwaps(pairAddress: "0xdef...") }
    â†“
å¦‚æœæœ‰æ–°æ•°æ®ï¼Œæ›´æ–° UI
```

**æ–¹æ¡ˆ 3ï¼šWebSocket** - å¯é€‰
```
å‰ç«¯å»ºç«‹ WebSocket è¿æ¥
    â†“
ws://backend/swap-updates
    â†“
è®¢é˜…ç‰¹å®š Pairï¼š{"action": "subscribe", "pairAddress": "0xdef..."}
    â†“
åç«¯æ¨é€æ–°äº¤æ˜“ï¼š{"type": "swap", "data": {...}}
    â†“
å‰ç«¯æ›´æ–° UI
```

**æ¨èæ–¹æ¡ˆ**ï¼šSSEï¼ˆç®€å•ã€å•å‘æ¨é€ã€è‡ªåŠ¨é‡è¿ï¼‰

---

##### 3. å‰ç«¯è§¦å‘åŒæ­¥æµç¨‹

**è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·åœ¨å‰ç«¯æ‰§è¡Œ Swap äº¤æ˜“æˆåŠŸåï¼ˆäº¤æ˜“å·²å‘é€åˆ°é“¾ä¸Šï¼‰

**å‰ç«¯å‘é€ä¿¡æ¯**ï¼ˆREST APIï¼‰ï¼š
```json
POST /api/sync/swap

{
  "txHash": "0xabc...",
  "chainId": 11155111,
  "pairAddress": "0xdef..."
}
```

**è¯´æ˜**ï¼š
- å‰ç«¯å¯ä»¥è·å–åˆ° `txHash`ï¼ˆäº¤æ˜“å“ˆå¸Œï¼‰ã€`chainId`ï¼ˆé“¾ IDï¼‰ã€`pairAddress`ï¼ˆPair åœ°å€ï¼‰
- `pairAddress` æ¥è‡ª `quote.pair.address`ï¼ˆå‰ç«¯åœ¨æ‰§è¡Œ Swap å‰å·²ç»è®¡ç®—è¿‡ quoteï¼‰
- `timestamp` ç­‰å…¶ä»–ä¿¡æ¯éœ€è¦åç«¯ä» Subgraph æŸ¥è¯¢
- å‰ç«¯åœ¨ `handleSwap` æˆåŠŸåç­‰90såå¾…the graphåŒæ­¥äº†é€»è¾‘åè°ƒç”¨æ­¤æ¥å£

**åç«¯å¤„ç†é€»è¾‘**ï¼š
```
æ¥æ”¶å‰ç«¯ä¿¡å·ï¼ˆtxHash, chainId, pairAddressï¼‰
    â†“
æŸ¥è¯¢ Subgraphï¼ˆæ ¹æ® txHash + pairAddress ç²¾ç¡®æŸ¥è¯¢ï¼‰
    â†“
query {
  swaps(
    where: { 
      transaction: "0xabc...",
      pair: "0xdef..."
    }
  ) {
    id
    transaction { id timestamp }
    pair { id }
    from
    amount0In
    amount0Out
    amount1In
    amount1Out
    amountUSD
  }
}
    â†“
å†™å…¥ PostgreSQL swaps è¡¨ï¼ˆINSERT æˆ– UPDATEï¼‰
    â”œâ”€ ä½¿ç”¨ transaction_id + pair_id ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â””â”€ é¿å…é‡å¤æ’å…¥
    â†“
ä¸åˆ é™¤ Redis ç¼“å­˜ï¼ˆä¿æŒ WS å†™å…¥çš„å®æ—¶æ•°æ®ï¼‰
    â†“
è¿”å›æˆåŠŸå“åº”
```

**Subgraph æŸ¥è¯¢ä¼˜åŒ–**ï¼š
- ä½¿ç”¨ `transaction` + `pair` åŒé‡è¿‡æ»¤ï¼Œç²¾ç¡®å®šä½äº¤æ˜“
- é¿å…å…¨è¡¨æ‰«æï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
- å¦‚æœ Subgraph è¿”å›ç©ºï¼Œç­‰å¾… 10 ç§’åé‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰

**åŒæ­¥å­—æ®µè¯´æ˜**ï¼š
- **å‰ç«¯æä¾›**ï¼š`txHash`ï¼ˆäº¤æ˜“å“ˆå¸Œï¼‰ã€`chainId`ï¼ˆé“¾ IDï¼‰ã€`pairAddress`ï¼ˆPair åœ°å€ï¼‰
- **åç«¯æŸ¥è¯¢**ï¼šæ ¹æ® `txHash` å’Œ `pairAddress` æŸ¥è¯¢ Subgraphï¼Œè·å–å®Œæ•´äº¤æ˜“ä¿¡æ¯
- **åŒæ­¥è¡¨**ï¼šswaps è¡¨
- **åŒæ­¥å­—æ®µ**ï¼šæ‰€æœ‰å­—æ®µï¼ˆid, transaction_id, timestamp, pair_id, from_address, amount0_in, amount0_out, amount1_in, amount1_out, amount_usd ç­‰ï¼‰
- **å”¯ä¸€æ ‡è¯†**ï¼štransaction_idï¼ˆé¿å…é‡å¤æ’å…¥ï¼‰
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨ `pairAddress` å¯ä»¥ç²¾ç¡®æŸ¥è¯¢ Subgraphï¼Œé¿å…å…¨è¡¨æ‰«æ

**ç¼“å­˜å¤„ç†ç­–ç•¥**ï¼š
- **ä¸åˆ é™¤ç¼“å­˜**ï¼šå‰ç«¯è§¦å‘åŒæ­¥åä¸åˆ é™¤ Redis ç¼“å­˜
- **åŸå› **ï¼š
  - WS ç›‘å¬å·²ç»å®æ—¶å†™å…¥ Redisï¼Œç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°è‡ªå·±çš„äº¤æ˜“
  - æ•°æ®åº“å†™å…¥æ˜¯ä¸ºäº†æŒä¹…åŒ–ï¼Œä¸å½±å“ç¼“å­˜çš„å®æ—¶æ€§
  - ç­‰å¾…ç¼“å­˜è‡ªç„¶è¿‡æœŸï¼ˆ60 ç§’ï¼‰åï¼Œä¸‹æ¬¡æŸ¥è¯¢ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½
  - é¿å…ä¸å¿…è¦çš„ç¼“å­˜åˆ é™¤æ“ä½œï¼Œå‡å°‘ Redis å‹åŠ›
- **æ•°æ®ä¸€è‡´æ€§ä¿éšœ**ï¼š
  - Redis ä¸­æœ‰ WS ç›‘å¬å†™å…¥çš„æœ€æ–°æ•°æ®ï¼ˆå®æ—¶ï¼Œç”¨æˆ·ç«‹å³å¯è§ï¼‰
  - PostgreSQL ä¸­æœ‰å‰ç«¯è§¦å‘åŒæ­¥çš„å®Œæ•´æ•°æ®ï¼ˆæŒä¹…åŒ–ï¼Œé˜²æ­¢ Redis é‡å¯ä¸¢å¤±ï¼‰
  - 60 ç§’åç¼“å­˜è‡ªç„¶è¿‡æœŸï¼Œä¸‹æ¬¡æŸ¥è¯¢ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§
  - å³ä½¿ Redis é‡å¯ï¼ŒæŸ¥è¯¢ä¼šè‡ªåŠ¨ä»æ•°æ®åº“åŠ è½½å¹¶é‡å»ºç¼“å­˜

---

##### 4. Redis ç¼“å­˜ç»“æ„

**Key è®¾è®¡**ï¼š
```
recent-swaps:{chainId}:{pairAddress}
```

**æ•°æ®ç»“æ„**ï¼šList

**å­˜å‚¨å†…å®¹**ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰ï¼š
```
[
  "{\"transactionId\":\"0xabc...\",\"timestamp\":1702800000,...}",  // æœ€æ–°
  "{\"transactionId\":\"0xdef...\",\"timestamp\":1702799990,...}",
  ...
  "{\"transactionId\":\"0x123...\",\"timestamp\":1702799900,...}"   // æœ€æ—§ï¼ˆç¬¬ 10 æ¡ï¼‰
]
```

**æ“ä½œè¯´æ˜**ï¼š
- **WS ç›‘å¬å†™å…¥**ï¼š`LPUSH` æ–°æ•°æ® + `LTRIM 0 9`ï¼ˆä¿ç•™æœ€è¿‘ 10 æ¡ï¼‰
- **æŸ¥è¯¢è¯»å–**ï¼š`LRANGE 0 9`ï¼ˆè·å–æœ€è¿‘ 10 æ¡ï¼‰
- **æŸ¥è¯¢å†™å…¥**ï¼š`DEL` + `LPUSH` å¤šæ¡ + `EXPIRE 60`ï¼ˆé‡å»ºç¼“å­˜å¹¶è®¾ç½® TTLï¼‰
- **å‰ç«¯è§¦å‘åŒæ­¥**ï¼šä¸åˆ é™¤ç¼“å­˜ï¼ˆä¿æŒ WS å†™å…¥çš„å®æ—¶æ•°æ®ï¼‰

**TTL ç­–ç•¥**ï¼š
- **WS ç›‘å¬å†™å…¥æ—¶**ï¼šä¸è®¾ç½® TTLï¼ˆä¿æŒåŸæœ‰ TTL ä¸å˜ï¼‰
- **æŸ¥è¯¢æ—¶å†™å…¥**ï¼š60 ç§’ TTL

**TTL å¤„ç†é€»è¾‘è¯´æ˜**ï¼š

Redis List çš„ TTL æ˜¯é’ˆå¯¹æ•´ä¸ª Key çš„ï¼Œä¸æ˜¯é’ˆå¯¹ List ä¸­çš„å•ä¸ªå…ƒç´ ã€‚

**åœºæ™¯ 1ï¼šWS ç›‘å¬å†™å…¥ï¼ˆLPUSHï¼‰**
```
WS ç›‘å¬åˆ°æ–°äº¤æ˜“
    â†“
LPUSH åˆ° Redis Listï¼ˆå¾€ List å¤´éƒ¨æ’å…¥æ•°æ®ï¼‰
    â†“
LTRIM 0 9ï¼ˆä¿ç•™æœ€è¿‘ 10 æ¡ï¼‰
    â†“
ä¸æ‰§è¡Œ EXPIRE å‘½ä»¤
    â†“
ç»“æœï¼š
  - å¦‚æœ Key å·²å­˜åœ¨ä¸”æœ‰ TTL â†’ TTL ä¸å˜ï¼ˆç»§ç»­å€’è®¡æ—¶ï¼‰
  - å¦‚æœ Key å·²å­˜åœ¨ä½†æ—  TTL â†’ ä»ç„¶æ—  TTL
  - å¦‚æœ Key ä¸å­˜åœ¨ â†’ åˆ›å»º Keyï¼Œè®¾ç½®TTL ä¸º60s
```

**åœºæ™¯ 2ï¼šGraphQL æŸ¥è¯¢æ—¶å†™å…¥**
```
æŸ¥è¯¢ Redis æœªå‘½ä¸­ï¼ˆKey ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸï¼‰
    â†“
æŸ¥è¯¢ PostgreSQL
    â†“
å†™å…¥ Redisï¼ˆLPUSH å¤šæ¡æ•°æ®ï¼‰
    â†“
è®¾ç½® TTL 60 ç§’ï¼ˆEXPIRE å‘½ä»¤ï¼‰
    â†“
ç»“æœï¼š
  - æ•´ä¸ª Key åœ¨ 60 ç§’åè¿‡æœŸ
  - 60 ç§’å†…çš„æ‰€æœ‰æŸ¥è¯¢éƒ½å‘½ä¸­ç¼“å­˜
  - 60 ç§’å Key è‡ªåŠ¨åˆ é™¤
```

**åœºæ™¯ 3ï¼šå‰ç«¯è§¦å‘åŒæ­¥å**
```
å‰ç«¯è§¦å‘åŒæ­¥
    â†“
å†™å…¥ PostgreSQL
    â†“
ä¸åˆ é™¤ Redis ç¼“å­˜ï¼ˆä¿æŒ WS å†™å…¥çš„å®æ—¶æ•°æ®ï¼‰
    â†“
ç­‰å¾…ç¼“å­˜è‡ªç„¶è¿‡æœŸï¼ˆ60 ç§’ï¼‰
```

**ä¸ºä»€ä¹ˆ WS ç›‘å¬ä¸è®¾ç½® TTLï¼Ÿ**
1. **ä¿æŒåŸæœ‰ TTL**ï¼šå¦‚æœ Key å·²æœ‰ TTLï¼ˆå¦‚æŸ¥è¯¢æ—¶è®¾ç½®çš„ 60 ç§’ï¼‰ï¼ŒLPUSH ä¸ä¼šå½±å“ TTLï¼Œè®©å®ƒè‡ªç„¶è¿‡æœŸ
2. **æ€§èƒ½è€ƒè™‘**ï¼šWS ç›‘å¬é¢‘ç¹å†™å…¥ï¼Œæ¯æ¬¡éƒ½æ‰§è¡Œ EXPIRE ä¼šå¢åŠ  Redis æ“ä½œ
3. **é¿å…æ°¸ä¹…å­˜å‚¨**ï¼šä¾èµ–æŸ¥è¯¢æ—¶è®¾ç½®çš„ TTLï¼Œç¡®ä¿å†·é—¨ Pair çš„ç¼“å­˜ä¼šè‡ªåŠ¨è¿‡æœŸ

**å®é™…è¿è¡Œæƒ…å†µ**ï¼š
- **æ´»è·ƒ Pair**ï¼šé¢‘ç¹æŸ¥è¯¢ â†’ æŸ¥è¯¢æ—¶è®¾ç½® 60 ç§’ TTL â†’ WS æŒç»­å†™å…¥ï¼ˆä¸å½±å“ TTLï¼‰â†’ TTL å€’è®¡æ—¶ â†’ 60 ç§’åè¿‡æœŸ â†’ ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°åŠ è½½
- **å†·é—¨ Pair**ï¼šå¶å°”æŸ¥è¯¢ â†’ æŸ¥è¯¢æ—¶è®¾ç½® 60 ç§’ TTL â†’ å¯èƒ½æœ‰ WS å†™å…¥ â†’ 60 ç§’åè¿‡æœŸ â†’ é‡Šæ”¾å†…å­˜
- **ä»æœªæŸ¥è¯¢çš„ Pair**ï¼šåªæœ‰ WS å†™å…¥ â†’  TTL 60s 

---

##### 5. æ•°æ®ä¸€è‡´æ€§ä¿éšœ

**é—®é¢˜**ï¼šWS ç›‘å¬çš„æ•°æ®åªåœ¨ Redisï¼Œå¦‚æœ Redis å¤±æ•ˆæˆ–é‡å¯ï¼Œæ•°æ®ä¼šä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼šå‰ç«¯è§¦å‘åŒæ­¥å†™å…¥ PostgreSQLï¼ˆæŒä¹…åŒ–ï¼‰

**å®Œæ•´æµç¨‹ç¤ºä¾‹**ï¼š

**åœºæ™¯ 1ï¼šç”¨æˆ· A æ‰§è¡Œäº¤æ˜“ï¼Œç”¨æˆ· B å®æ—¶çœ‹åˆ°**
```
ç”¨æˆ· A æ‰§è¡Œäº¤æ˜“
    â†“
åŒºå—é“¾ç¡®è®¤äº¤æ˜“
    â†“
WS ç›‘å¬æ•è· Swap äº‹ä»¶
    â†“
å†™å…¥ Redisï¼ˆLPUSHï¼‰
    â†“
ç”¨æˆ· A ç«‹å³çœ‹åˆ°è‡ªå·±çš„äº¤æ˜“ï¼ˆ< 5 ç§’ï¼‰
    â†“
åç«¯é€šè¿‡ SSE æ¨é€äº‹ä»¶ç»™æ‰€æœ‰è®¢é˜…è¯¥ Pair çš„ç”¨æˆ·
    â†“
ç”¨æˆ· B æ”¶åˆ° SSE äº‹ä»¶
    â†“
ç”¨æˆ· B å‰ç«¯é‡æ–°æŸ¥è¯¢ GraphQL
    â†“
GraphQL ä» Redis è¯»å–æœ€æ–°æ•°æ®
    â†“
ç”¨æˆ· B çœ‹åˆ°ç”¨æˆ· A çš„äº¤æ˜“ï¼ˆ< 5 ç§’ï¼Œæ— éœ€åˆ·æ–°é¡µé¢ï¼‰
    â†“
å‰ç«¯è§¦å‘åŒæ­¥ï¼ˆå‘é€ txHash + pairAddressï¼‰
    â†“
åç«¯æŸ¥è¯¢ Subgraph
    â†“
å†™å…¥ PostgreSQLï¼ˆæŒä¹…åŒ–ï¼‰
    â†“
ä¸åˆ é™¤ Redis ç¼“å­˜ï¼ˆä¿æŒ WS å†™å…¥çš„å®æ—¶æ•°æ®ï¼‰
    â†“
60 ç§’åç¼“å­˜è‡ªç„¶è¿‡æœŸ
    â†“
ä¸‹æ¬¡æŸ¥è¯¢ä» PostgreSQL é‡æ–°åŠ è½½
```

**åœºæ™¯ 2ï¼šç”¨æˆ· C é¦–æ¬¡è®¿é—®é¡µé¢**
```
ç”¨æˆ· C æ‰“å¼€ Swap é¡µé¢
    â†“
å‰ç«¯æŸ¥è¯¢ GraphQL
    â†“
Redis å‘½ä¸­ï¼ˆæœ‰ç¼“å­˜ï¼‰
    â†“
è¿”å›æœ€è¿‘ 10 ç¬”äº¤æ˜“ï¼ˆ< 5msï¼‰
    â†“
å‰ç«¯å»ºç«‹ SSE è¿æ¥ï¼ˆè®¢é˜…è¯¥ Pairï¼‰
    â†“
åç»­æœ‰æ–°äº¤æ˜“æ—¶ï¼Œè‡ªåŠ¨æ¨é€æ›´æ–°
```

**å…³é”®ç‚¹**ï¼š
- âœ… WS ç›‘å¬ä¿è¯å®æ—¶æ€§ï¼ˆç”¨æˆ·ç«‹å³çœ‹åˆ°è‡ªå·±çš„äº¤æ˜“ï¼Œ< 5 ç§’ï¼‰
- âœ… SSE æ¨é€ä¿è¯å¤šç”¨æˆ·å®æ—¶æ€§ï¼ˆå…¶ä»–ç”¨æˆ·æ— éœ€åˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°æ–°äº¤æ˜“ï¼‰
- âœ… å‰ç«¯è§¦å‘åŒæ­¥ä¿è¯æŒä¹…åŒ–ï¼ˆé˜²æ­¢ Redis é‡å¯ä¸¢å¤±ï¼‰
- âœ… ä¸åˆ é™¤ç¼“å­˜ä¿è¯æ€§èƒ½ï¼ˆé¿å…ä¸å¿…è¦çš„ç¼“å­˜å¤±æ•ˆï¼‰
- âœ… è‡ªç„¶è¿‡æœŸä¿è¯ä¸€è‡´æ€§ï¼ˆ60 ç§’åè‡ªåŠ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼‰

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **Redis ä¼˜å…ˆ**ï¼šçƒ­ç‚¹æ•°æ®ï¼Œè®¿é—®é¢‘ç‡é«˜ï¼Œæ¯«ç§’çº§å“åº”ï¼ˆ< 5msï¼‰
- âœ… **GraphQL æŸ¥è¯¢**ï¼šRedis æœªå‘½ä¸­æ—¶æŸ¥è¯¢ PostgreSQLï¼Œè‡ªåŠ¨å›å¡«ç¼“å­˜ï¼ˆ< 50msï¼‰
- âœ… **WS ç›‘å¬åªå†™ Redis**ï¼šä¿è¯å®æ—¶æ€§ï¼ˆ< 5 ç§’ï¼‰ï¼Œé™ä½æ•°æ®åº“å‹åŠ›
- âœ… **å‰ç«¯è§¦å‘å†™ DB**ï¼šç”¨æˆ·äº¤æ˜“åæŒä¹…åŒ–ï¼ˆ< 5 ç§’ï¼‰ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§
- âœ… **ä¸åˆ é™¤ç¼“å­˜**ï¼šå‰ç«¯è§¦å‘åŒæ­¥åä¸åˆ é™¤ç¼“å­˜ï¼Œä¿æŒ WS å†™å…¥çš„å®æ—¶æ•°æ®ï¼Œç­‰å¾…è‡ªç„¶è¿‡æœŸï¼ˆ60 ç§’ï¼‰
- âŒ **ä¸éœ€è¦å®šæ—¶åŒæ­¥**ï¼šå‰ç«¯è§¦å‘å·²è¦†ç›–ï¼Œæ— éœ€é¢å¤–å®šæ—¶ä»»åŠ¡

---

### åŠŸèƒ½ 2.1.2ï¼š24h äº¤æ˜“ç»Ÿè®¡

**åŠŸèƒ½æè¿°**ï¼šæ˜¾ç¤ºè¯¥äº¤æ˜“å¯¹ä»æ˜¨å¤©ç»“æŸåˆ°ç°åœ¨çš„äº¤æ˜“é‡ã€äº¤æ˜“ç¬”æ•°ã€TVL å˜åŒ–

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦äº†è§£è¯¥äº¤æ˜“å¯¹çš„æ´»è·ƒåº¦å’ŒæµåŠ¨æ€§

**æ•°æ®é‡çº§**ï¼šå•æ¡è®°å½•ï¼ˆèšåˆæ•°æ®ï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­ ä¸­  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§ï¼ˆä»Šå¤©çš„æ•°æ®åœ¨ç´¯ç§¯ä¸­ï¼‰

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | æ—¶é—´ç»´åº¦ |
|-------|-------|------|---------|
| æ˜¨å¤©äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | æ˜¨å¤©ï¼ˆå›ºå®šå€¼ï¼‰ |
| æ˜¨å¤©äº¤æ˜“ç¬”æ•° | pair_day_data | daily_tx_count | æ˜¨å¤©ï¼ˆå›ºå®šå€¼ï¼‰ |
| æ˜¨å¤© ä¸ºæ­¢å†å²ç´¯è®¡TVL | pair_day_data | reserve_usd | æ˜¨å¤©ç»“æŸæ—¶ï¼ˆå›ºå®šå€¼ï¼‰ |
| ä»Šå¤©äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | ä»Šå¤©ï¼ˆç´¯ç§¯ä¸­ï¼‰ |
| ä»Šå¤©äº¤æ˜“ç¬”æ•° | pair_day_data | daily_tx_count | ä»Šå¤©ï¼ˆç´¯ç§¯ä¸­ï¼‰ |
| ä»Šå¤© ä¸ºæ­¢å†å²ç´¯è®¡TVL | pair_day_data | reserve_usd | ä»Šå¤©å½“å‰æ—¶åˆ» |

**è¯´æ˜**ï¼š
- è¿™ä¸æ˜¯ä¸¥æ ¼çš„"è¿‡å» 24 å°æ—¶"ï¼Œè€Œæ˜¯"ä»æ˜¨å¤©ç»“æŸåˆ°ç°åœ¨"çš„å˜åŒ–
- Uniswap çš„æ ‡å‡†è®¾è®¡ï¼Œç®€å•å®ç”¨
- `reserve_usd` ä½¿ç”¨å†å²ä»·æ ¼å¿«ç…§ï¼ˆSubgraph è®¡ç®—æ—¶çš„ ETH/USD ä»·æ ¼ï¼‰ï¼Œä¸æ˜¯å®æ—¶ä»·æ ¼

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, pairAddressï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æ£€æŸ¥ Redis ç¼“å­˜ï¼ˆKey: pair-stats-24h:{chainId}:{pairAddress}ï¼‰
    â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›ï¼ˆ< 5msï¼‰
    â””â”€ æœªå‘½ä¸­ â†’ æŸ¥è¯¢ PostgreSQL
              â†“
              æŸ¥è¯¢ pair_day_data è¡¨ï¼ˆæ˜¨å¤© + ä»Šå¤©ï¼‰
              â†“
              è®¡ç®—å˜åŒ–ç™¾åˆ†æ¯”
              â†“
              å†™å…¥ Redis ç¼“å­˜ï¼ˆTTL: 180sï¼‰
              â†“
              è¿”å›ç»“æœï¼ˆ< 50msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  pairStats24h(
    chainId: String!
    pairAddress: String!
  ): PairStats24h
}

type PairStats24h {
  # æ˜¨å¤©çš„æ•°æ®ï¼ˆå›ºå®šå€¼ï¼‰
  volumeYesterday: String!
  txCountYesterday: Int!
  tvlYesterday: String!
  
  # ä»Šå¤©çš„æ•°æ®ï¼ˆç´¯ç§¯ä¸­ï¼‰
  volumeToday: String!
  txCountToday: Int!
  tvlToday: String!
  
  # å˜åŒ–ç™¾åˆ†æ¯”
  volumeChange: String!      # ä¾‹å¦‚ï¼š"+15.3%"
  txCountChange: String!     # ä¾‹å¦‚ï¼š"+8.2%"
  tvlChange: String!         # ä¾‹å¦‚ï¼š"+5.23%"
}
```

**æŸ¥è¯¢å‚æ•°è¯´æ˜**ï¼š
- `chainId`ï¼šé“¾ IDï¼ˆå¦‚ "11155111" è¡¨ç¤º Sepoliaï¼‰
- `pairAddress`ï¼šPair åˆçº¦åœ°å€

---

##### 2. å‰ç«¯è§¦å‘åŒæ­¥æµç¨‹

**è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·æ‰§è¡Œ Swap äº¤æ˜“æˆåŠŸå

**å‰ç«¯å‘é€ä¿¡æ¯**ï¼ˆREST APIï¼‰ï¼š
```json
POST /api/sync/swap

{
  "txHash": "0xabc...",
  "chainId": 11155111,
  "pairAddress": "0xdef..."
}
```

**åç«¯å¤„ç†é€»è¾‘**ï¼š
```
æ¥æ”¶å‰ç«¯ä¿¡å·ï¼ˆtxHash, chainId, pairAddressï¼‰
    â†“
æŸ¥è¯¢ Subgraphï¼ˆæ ¹æ® pairAddress æŸ¥è¯¢ä»Šå¤©çš„ pair_day_dataï¼‰
    â†“
query {
  pairDayDatas(
    where: { 
      pair: "0xdef...",
      date: <ä»Šå¤©çš„ dayId>
    }
  ) {
    id
    date
    dailyVolumeUSD
    dailyTxCount
    reserveUSD
  }
}
    â†“
å†™å…¥/æ›´æ–° PostgreSQL pair_day_data è¡¨
    â”œâ”€ ä½¿ç”¨ pair_id + date ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â”œâ”€ INSERT ON CONFLICT UPDATE
    â””â”€ æ›´æ–°ä»Šå¤©çš„ç´¯ç§¯æ•°æ®
    â†“
ä¸åˆ é™¤ Redis ç¼“å­˜ï¼ˆç­‰å¾…è‡ªç„¶è¿‡æœŸ 180 ç§’ï¼‰
    â†“
è¿”å›æˆåŠŸå“åº”
```

**åŒæ­¥å­—æ®µè¯´æ˜**ï¼š
- **å‰ç«¯æä¾›**ï¼š`txHash`ã€`chainId`ã€`pairAddress`
- **åç«¯æŸ¥è¯¢**ï¼šæ ¹æ® `pairAddress` + `today` æŸ¥è¯¢ Subgraph
- **åŒæ­¥è¡¨**ï¼špair_day_dataï¼ˆä»Šå¤©çš„è®°å½•ï¼‰
- **åŒæ­¥å­—æ®µ**ï¼šdaily_volume_usd, daily_tx_count, reserve_usd
- **å”¯ä¸€æ ‡è¯†**ï¼špair_id + dateï¼ˆé¿å…é‡å¤æ’å…¥ï¼‰

---

##### 3. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼šæ¯å¤©å‡Œæ™¨ 1:00 UTC

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraphï¼ˆæ˜¨å¤©çš„ pair_day_dataï¼‰
    â†“
query {
  pairDayDatas(
    where: { date: <æ˜¨å¤©çš„ dayId> }
    first: 1000
  ) {
    id
    pair { id }
    date
    dailyVolumeUSD
    dailyTxCount
    reserveUSD
  }
}
    â†“
å†™å…¥ PostgreSQL pair_day_data è¡¨
    â”œâ”€ ä½¿ç”¨ pair_id + date ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â””â”€ INSERT ON CONFLICT UPDATE
    â†“
ä¸æ›´æ–° Redisï¼ˆç”±æŸ¥è¯¢æ—¶æ›´æ–°ï¼‰
```

**å…³é”®ç‚¹**ï¼š
- âœ… åªåŒæ­¥æ˜¨å¤©çš„æ•°æ®ï¼ˆå·²å®Œæ•´ï¼Œä¸å†å˜åŒ–ï¼‰
- âœ… æ‰¹é‡åŒæ­¥æ‰€æœ‰ Pairï¼ˆä¸æ˜¯å•ä¸ª Pairï¼‰
- âœ… åªå†™æ•°æ®åº“ï¼Œä¸å†™ Redis

---

##### 4. Redis ç¼“å­˜ç»“æ„

**Key è®¾è®¡**ï¼š
```
pair-stats-24h:{chainId}:{pairAddress}
```

**æ•°æ®ç»“æ„**ï¼šHash

**å­˜å‚¨å†…å®¹**ï¼š
```json
{
  "volumeYesterday": "1000000.50",
  "txCountYesterday": "542",
  "tvlYesterday": "5000000.00",
  "volumeToday": "850000.30",
  "txCountToday": "487",
  "tvlToday": "5250000.00",
  "volumeChange": "+15.3%",
  "txCountChange": "+8.2%",
  "tvlChange": "+5.0%",
  "lastUpdate": "1702800000"
}
```

**æ“ä½œè¯´æ˜**ï¼š
- **æŸ¥è¯¢è¯»å–**ï¼š`HGETALL`
- **æŸ¥è¯¢å†™å…¥**ï¼š`HMSET` + `EXPIRE 180`
- **å‰ç«¯è§¦å‘åŒæ­¥**ï¼šä¸åˆ é™¤ç¼“å­˜ï¼ˆç­‰å¾…è‡ªç„¶è¿‡æœŸï¼‰

**TTL ç­–ç•¥**ï¼š
- **æŸ¥è¯¢æ—¶å†™å…¥**ï¼š180 ç§’ï¼ˆ3 åˆ†é’Ÿï¼‰
- **å‰ç«¯è§¦å‘åŒæ­¥**ï¼šä¸è®¾ç½® TTLï¼ˆä¸åˆ é™¤ç¼“å­˜ï¼‰

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **Redis ç¼“å­˜**ï¼š180 ç§’ TTLï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
- âœ… **GraphQL æŸ¥è¯¢**ï¼šRedis æœªå‘½ä¸­æ—¶æŸ¥è¯¢ PostgreSQLï¼Œè‡ªåŠ¨å›å¡«ç¼“å­˜ï¼ˆ< 50msï¼‰
- âœ… **å‰ç«¯è§¦å‘åŒæ­¥**ï¼šç”¨æˆ·äº¤æ˜“åæ›´æ–°ä»Šå¤©çš„ pair_day_data
- âœ… **å®šæ—¶åŒæ­¥**ï¼šæ¯å¤©å‡Œæ™¨åŒæ­¥æ˜¨å¤©çš„æ•°æ®ï¼ˆå›ºå®šå€¼ï¼‰
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šæ•°æ®å˜åŒ–æ…¢ï¼Œä¸éœ€è¦å®æ—¶æ¨é€
- âŒ **ä¸ä½¿ç”¨ SSE æ¨é€**ï¼šç”¨æˆ·å¯ä»¥æ¥å— 3 åˆ†é’Ÿçš„å»¶è¿Ÿ

---

## Pool é¡µé¢æ¨¡å—

### æ¨¡å—æ¦‚è¿°

**æ ¸å¿ƒåŠŸèƒ½**ï¼šç”¨æˆ·æŸ¥çœ‹å’Œç®¡ç†æµåŠ¨æ€§æ± 

**ç”¨æˆ·åœºæ™¯**ï¼š
- æµè§ˆæ‰€æœ‰å¯ç”¨çš„æµåŠ¨æ€§æ± 
- æŸ¥çœ‹æ± å­çš„ TVLã€äº¤æ˜“é‡ã€æ‰‹ç»­è´¹
- æ·»åŠ /ç§»é™¤æµåŠ¨æ€§
- æŸ¥çœ‹è‡ªå·±çš„æµåŠ¨æ€§ä»“ä½

**é¡µé¢è·¯ç”±**ï¼š`/pools`

**è®¿é—®é¢‘ç‡**ï¼šé«˜

---

### åŠŸèƒ½ 3.1.1ï¼šPool åˆ—è¡¨ï¼ˆTVL æ’åºï¼‰

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºæ‰€æœ‰ Pool çš„åˆ—è¡¨ï¼ŒæŒ‰ TVL ä»é«˜åˆ°ä½æ’åºï¼Œæ”¯æŒæœç´¢å’Œåˆ†é¡µ

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æµè§ˆæ‰€æœ‰å¯ç”¨çš„æµåŠ¨æ€§æ± ï¼Œæ‰¾åˆ° TVL æœ€é«˜çš„æ± å­è¿›è¡Œæ·»åŠ æµåŠ¨æ€§

**æ•°æ®é‡çº§**ï¼šTop 100ï¼ˆé»˜è®¤å±•ç¤ºå‰ 100 ä¸ªï¼Œæ”¯æŒåŠ è½½æ›´å¤šï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­ ä¸­  
**è®¿é—®é¢‘ç‡**ï¼šé«˜  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§ï¼ˆTVL éšç€äº¤æ˜“å˜åŒ–ï¼Œä½†ä¸éœ€è¦ç§’çº§æ›´æ–°ï¼‰

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | è®¡ç®—æ–¹å¼ |
|-------|-------|------|---------|
| Pool åœ°å€ | pairs | id, address | - |
| Token0 ä¿¡æ¯ | tokens | symbol, decimals, name | - |
| Token1 ä¿¡æ¯ | tokens | symbol, decimals, name | - |
| TVL | pairs | reserve_usd | - |
| 24h äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | æ˜¨å¤©çš„æ•°æ® |
| 30å¤©äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | SUM(æœ€è¿‘30å¤©) |
| äº¤æ˜“è®¡æ•° | pairs | tx_count | - |
| APRï¼ˆå¹´åŒ–æ”¶ç›Šç‡ï¼‰ | - | - | (24häº¤æ˜“é‡ Ã— 0.003 Ã— 365) / TVL |
| Vol/TVL æ¯”ç‡ | - | - | 24häº¤æ˜“é‡ / TVL |

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, first, orderByï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æ£€æŸ¥ Redis ç¼“å­˜ï¼ˆKey: pool-list:{chainId}:{orderBy}ï¼‰
    â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›ï¼ˆ< 5msï¼‰
    â””â”€ æœªå‘½ä¸­ â†’ æŸ¥è¯¢ PostgreSQL
              â†“
              æŸ¥è¯¢ pairs è¡¨
              â†“
              ORDER BY reserve_usd DESC (æˆ–å…¶ä»–æ’åºå­—æ®µ)
              LIMIT 100
              â†“
              è®¡ç®— APR å’Œ Vol/TVL
              â”œâ”€ APR = (volume24h Ã— 0.003 Ã— 365) / reserveUsd
              â””â”€ volOverTvl = volume24h / reserveUsd
              â†“
              å†™å…¥ Redis ç¼“å­˜ï¼ˆTTL: 60sï¼‰
              â†“
              è¿”å›ç»“æœï¼ˆ< 100msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  pools(
    chainId: String!
    first: Int = 100
    orderBy: PoolOrderBy = TVL_DESC
    cursor: String
  ): PoolConnection!
}

type PoolConnection {
  edges: [PoolEdge!]!
  pageInfo: PageInfo!
}

type PoolEdge {
  node: Pool!
  cursor: String!
}

type Pool {
  id: ID!
  address: String!
  token0: Token!
  token1: Token!
  reserveUsd: String!
  volume24h: String!
  volume30d: String!
  txCount: Int!
  apr: String!              # å¹´åŒ–æ”¶ç›Šç‡
  volOverTvl: String!       # Vol/TVL æ¯”ç‡
}

type Token {
  id: ID!
  address: String!
  symbol: String!
  name: String!
  decimals: Int!
}

enum PoolOrderBy {
  TVL_DESC
  VOLUME_DESC
  TX_COUNT_DESC
}
```

**æŸ¥è¯¢å‚æ•°è¯´æ˜**ï¼š
- `chainId`ï¼šé“¾ ID
- `first`ï¼šè¿”å›è®°å½•æ•°ï¼ˆé»˜è®¤ 100ï¼‰
- `orderBy`ï¼šæ’åºæ–¹å¼ï¼ˆé»˜è®¤æŒ‰ TVL é™åºï¼‰
- `cursor`ï¼šåˆ†é¡µæ¸¸æ ‡

---

##### 2. å‰ç«¯è§¦å‘åŒæ­¥æµç¨‹

**è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·æ‰§è¡Œ Swap / æ·»åŠ æµåŠ¨æ€§ / ç§»é™¤æµåŠ¨æ€§ å

**å‰ç«¯å‘é€ä¿¡æ¯**ï¼ˆREST APIï¼‰ï¼š
```json
POST /api/sync/pool

{
  "txHash": "0xabc...",
  "chainId": 11155111,
  "pairAddress": "0xdef...",
  "type": "swap"  // swap | mint | burn
}
```

**åç«¯å¤„ç†é€»è¾‘**ï¼š
```
æ¥æ”¶å‰ç«¯ä¿¡å·ï¼ˆtxHash, chainId, pairAddress, typeï¼‰
    â†“
æŸ¥è¯¢ Subgraphï¼ˆæ ¹æ® pairAddress æŸ¥è¯¢ Pair æœ€æ–°çŠ¶æ€ï¼‰
    â†“
query {
  pair(id: "0xdef...") {
    id
    reserve0
    reserve1
    reserveUSD
    totalSupply
    txCount
    token0 { id symbol name decimals }
    token1 { id symbol name decimals }
  }
  
  # æŸ¥è¯¢ä»Šå¤©çš„ pair_day_data
  pairDayDatas(
    where: { 
      pair: "0xdef...",
      date: <ä»Šå¤©çš„ dayId>
    }
    first: 1
  ) {
    id
    date
    dailyVolumeUSD
    dailyTxCount
    reserveUSD
  }
}
    â†“
å†™å…¥ PostgreSQL
    â”œâ”€ æ›´æ–° pairs è¡¨
    â”‚   â”œâ”€ reserve0, reserve1, reserve_usd
    â”‚   â”œâ”€ total_supply
    â”‚   â”œâ”€ tx_count
    â”‚   â””â”€ INSERT ON CONFLICT UPDATE
    â”‚
    â”œâ”€ æ›´æ–° tokens è¡¨ï¼ˆtoken0, token1 åŸºç¡€ä¿¡æ¯ï¼‰
    â”‚   â””â”€ INSERT ON CONFLICT UPDATE
    â”‚
    â””â”€ æ›´æ–° pair_day_data è¡¨ï¼ˆä»Šå¤©çš„æ•°æ®ï¼‰
        â”œâ”€ daily_volume_usd
        â”œâ”€ daily_tx_count
        â”œâ”€ reserve_usd
        â””â”€ INSERT ON CONFLICT UPDATE
    â†“
åˆ é™¤ Redis ç¼“å­˜ï¼ˆç²¾ç¡®å¤±æ•ˆï¼‰
    â”œâ”€ DEL pool-list:{chainId}:*ï¼ˆæ‰€æœ‰æ’åºæ–¹å¼çš„ç¼“å­˜ï¼‰
    â”œâ”€ DEL pool-details:{chainId}:{pairAddress}
    â””â”€ DEL pair-stats-24h:{chainId}:{pairAddress}
    â†“
è¿”å›æˆåŠŸå“åº”
```

**åŒæ­¥çš„è¡¨å’Œå­—æ®µ**ï¼š

| æ“ä½œç±»å‹ | åŒæ­¥è¡¨ | åŒæ­¥å­—æ®µ | è¯´æ˜ |
|---------|-------|---------|------|
| **Swap** | pairs | reserve0, reserve1, reserve_usd, tx_count | å‚¨å¤‡é‡å’Œäº¤æ˜“è®¡æ•°å˜åŒ– |
| **Swap** | pair_day_data | daily_volume_usd, daily_tx_count, reserve_usd | ä»Šå¤©çš„äº¤æ˜“é‡å’Œ TVL |
| **Mint** | pairs | reserve0, reserve1, reserve_usd, total_supply, tx_count | å‚¨å¤‡é‡å’Œ LP ä¾›åº”é‡å¢åŠ  |
| **Mint** | pair_day_data | reserve_usd | ä»Šå¤©çš„ TVL å¢åŠ  |
| **Burn** | pairs | reserve0, reserve1, reserve_usd, total_supply, tx_count | å‚¨å¤‡é‡å’Œ LP ä¾›åº”é‡å‡å°‘ |
| **Burn** | pair_day_data | reserve_usd | ä»Šå¤©çš„ TVL å‡å°‘ |
| **æ‰€æœ‰æ“ä½œ** | tokens | symbol, name

---

### åŠŸèƒ½ 3.1.2ï¼šPool è¯¦æƒ…é¡µ

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºå•ä¸ª Pool çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»·æ ¼å›¾è¡¨ã€äº¤æ˜“é‡å›¾è¡¨ã€äº¤æ˜“å†å²

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æ·±å…¥äº†è§£æŸä¸ªæ± å­çš„è¯¦ç»†æ•°æ®ï¼Œå†³å®šæ˜¯å¦æ·»åŠ æµåŠ¨æ€§

**æ•°æ®é‡çº§**ï¼šå•æ¡è®°å½• + å›¾è¡¨æ•°æ®ï¼ˆæœ€è¿‘ 7 å¤©ï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­â­ é«˜  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | æ—¶é—´ç»´åº¦ | è®¡ç®—æ–¹å¼ |
|-------|-------|------|---------|---------|
| Pool åŸºæœ¬ä¿¡æ¯ | pairs | address, reserve0, reserve1, reserve_usd | å½“å‰ | - |
| Token0 ä¿¡æ¯ | tokens | symbol, name, decimals | - | - |
| Token1 ä¿¡æ¯ | tokens | symbol, name, decimals | - | - |
| 24h äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | æ˜¨å¤© | - |
| 24h æ‰‹ç»­è´¹ | pair_day_data | daily_volume_usd * 0.003 | æ˜¨å¤© | äº¤æ˜“é‡ Ã— 0.3% |
| 24h TVL å˜åŒ– | pair_day_data | reserve_usd | æ˜¨å¤© vs ä»Šå¤© | (ä»Šå¤© - æ˜¨å¤©) / æ˜¨å¤© Ã— 100% |
| ä»·æ ¼å†å²ï¼ˆKçº¿ï¼‰ | pair_hour_data / pair_day_data | reserve0, reserve1 | å¯é€‰èŒƒå›´ | token0Price = reserve1 / reserve0 |
| äº¤æ˜“é‡å†å² | pair_hour_data / pair_day_data | hourly_volume_usd / daily_volume_usd | å¯é€‰èŒƒå›´ | - |
| TVL å†å² | pair_hour_data / pair_day_data | reserve_usd | å¯é€‰èŒƒå›´ | - |
| æœ€è¿‘äº¤æ˜“ | swaps | transaction_id, timestamp, amounts | æœ€è¿‘ 20 ç¬” | - |

**æ—¶é—´èŒƒå›´é€‰é¡¹**ï¼š
- `HOUR`ï¼šæœ€è¿‘ 1 å°æ—¶ï¼ˆä½¿ç”¨ pair_hour_dataï¼‰
- `DAY`ï¼šæœ€è¿‘ 1 å¤©ï¼ˆä½¿ç”¨ pair_hour_dataï¼‰
- `WEEK`ï¼šæœ€è¿‘ 7 å¤©ï¼ˆä½¿ç”¨ pair_day_dataï¼‰
- `MONTH`ï¼šæœ€è¿‘ 30 å¤©ï¼ˆä½¿ç”¨ pair_day_dataï¼‰
- `YEAR`ï¼šæœ€è¿‘ 365 å¤©ï¼ˆä½¿ç”¨ pair_day_dataï¼‰

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, pairAddressï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æŸ¥è¯¢ PostgreSQL
    â”œâ”€ pairs è¡¨ï¼ˆåŸºæœ¬ä¿¡æ¯ï¼‰
    â”œâ”€ pair_day_data è¡¨ï¼ˆ24h æ•°æ®ï¼‰
    â”œâ”€ pair_hour_data è¡¨ï¼ˆå›¾è¡¨æ•°æ®ï¼‰
    â””â”€ swaps è¡¨ï¼ˆæœ€è¿‘äº¤æ˜“ï¼‰
    â†“
è¿”å›ç»“æœï¼ˆ< 200msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  poolDetails(
    chainId: String!
    pairAddress: String!
  ): PoolDetails
}

type PoolDetails {
  # åŸºæœ¬ä¿¡æ¯
  id: ID!
  address: String!
  token0: Token!
  token1: Token!
  reserve0: String!
  reserve1: String!
  reserveUsd: String!
  
  # 24h ç»Ÿè®¡
  volume24h: String!
  fees24h: String!
  tvlChange24h: String!
  
  # å›¾è¡¨æ•°æ®ï¼ˆæ”¯æŒå¤šç§æ—¶é—´èŒƒå›´ï¼‰
  priceHistory(duration: HistoryDuration!): [PricePoint!]!
  volumeHistory(duration: HistoryDuration!): [VolumePoint!]!
  tvlHistory(duration: HistoryDuration!): [TvlPoint!]!
  
  # æœ€è¿‘äº¤æ˜“
  recentSwaps: [Swap!]!
}

enum HistoryDuration {
  HOUR
  DAY
  WEEK
  MONTH
  YEAR
}

type PricePoint {
  timestamp: Int!
  token0Price: String!
  token1Price: String!
}

type VolumePoint {
  timestamp: Int!
  volume: String!
}

type TvlPoint {
  timestamp: Int!
  tvl: String!
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼š
- pairs è¡¨ï¼šæ¯ 5 åˆ†é’Ÿ
- pair_day_data è¡¨ï¼šæ¯å¤©å‡Œæ™¨ï¼ˆæ˜¨å¤©çš„æ•°æ®ï¼‰
- pair_hour_data è¡¨ï¼šæ¯å°æ—¶

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraph
    â†“
query {
  # æ¯å°æ—¶åŒæ­¥
  pairHourDatas(
    where: { 
      pair: "0xdef...",
      hourStartUnix_gte: <7å¤©å‰>
    }
  ) {
    id
    hourStartUnix
    reserve0
    reserve1
    hourlyVolumeUSD
  }
}
    â†“
å†™å…¥ PostgreSQL pair_hour_data è¡¨
    â”œâ”€ ä½¿ç”¨ id ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â””â”€ INSERT ON CONFLICT UPDATE
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **GraphQL æŸ¥è¯¢**ï¼šä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰æ•°æ®ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
- âœ… **å®šæ—¶åŒæ­¥**ï¼šåˆ†å±‚åŒæ­¥ï¼ˆ5åˆ†é’Ÿ/1å°æ—¶/1å¤©ï¼‰ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
- âœ… **å›¾è¡¨æ•°æ®**ï¼šä½¿ç”¨ pair_hour_dataï¼Œæä¾›è¶³å¤Ÿçš„ç²’åº¦
- âŒ **ä¸ä½¿ç”¨ Redis**ï¼šæ•°æ®é‡å¤§ï¼ŒæŸ¥è¯¢å¤æ‚ï¼Œä¸é€‚åˆç¼“å­˜
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šå›¾è¡¨æ•°æ®ä¸éœ€è¦å®æ—¶æ›´æ–°

---

### åŠŸèƒ½ 3.1.3ï¼šç”¨æˆ·æµåŠ¨æ€§ä»“ä½

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºç”¨æˆ·åœ¨æ‰€æœ‰ Pool ä¸­çš„æµåŠ¨æ€§ä»“ä½

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æŸ¥çœ‹è‡ªå·±æä¾›äº†å¤šå°‘æµåŠ¨æ€§ï¼Œå½“å‰ä»·å€¼å¤šå°‘

**æ•°æ®é‡çº§**ï¼šç”¨æˆ·çš„æ‰€æœ‰ä»“ä½ï¼ˆé€šå¸¸ < 10 ä¸ªï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­â­ é«˜  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æº | è¯´æ˜ |
|-------|------|------|
| LP Token ä½™é¢ | é“¾ä¸ŠæŸ¥è¯¢ | å‰ç«¯ç›´æ¥è°ƒç”¨ ERC20.balanceOf |
| Pool æ€»ä¾›åº”é‡ | pairs | total_supply |
| Pool å‚¨å¤‡é‡ | pairs | reserve0, reserve1 |
| Token ä»·æ ¼ | tokens | price_usd |

**è¯´æ˜**ï¼š
- å‰ç«¯ç›´æ¥ä»é“¾ä¸ŠæŸ¥è¯¢ç”¨æˆ·çš„ LP Token ä½™é¢
- åç«¯æä¾› Pool ä¿¡æ¯ï¼ˆæ€»ä¾›åº”é‡ã€å‚¨å¤‡é‡ï¼‰
- å‰ç«¯è®¡ç®—ç”¨æˆ·çš„ä»½é¢å’Œä»·å€¼

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šæ··åˆï¼ˆé“¾ä¸Š + GraphQLï¼‰

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯è·å–ç”¨æˆ·åœ°å€
    â†“
æŸ¥è¯¢é“¾ä¸Šæ‰€æœ‰ LP Token ä½™é¢
    â†“
for each LP Token with balance > 0:
    â†“
    æŸ¥è¯¢ GraphQL è·å– Pool ä¿¡æ¯
    â†“
    è®¡ç®—ç”¨æˆ·ä»½é¢ = balance / totalSupply
    â†“
    è®¡ç®—ç”¨æˆ·èµ„äº§ = ä»½é¢ * (reserve0 + reserve1 * price)
    â†“
è¿”å›ç”¨æˆ·ä»“ä½åˆ—è¡¨
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  userPositions(
    chainId: String!
    userAddress: String!
  ): [UserPosition!]!
}

type UserPosition {
  pool: Pool!
  lpTokenBalance: String!
  lpTokenTotalSupply: String!
  share: String!              # ç”¨æˆ·ä»½é¢ç™¾åˆ†æ¯”
  token0Amount: String!       # ç”¨æˆ·æ‹¥æœ‰çš„ token0 æ•°é‡
  token1Amount: String!       # ç”¨æˆ·æ‹¥æœ‰çš„ token1 æ•°é‡
  valueUsd: String!           # æ€»ä»·å€¼ï¼ˆUSDï¼‰
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼šæ¯ 5 åˆ†é’Ÿï¼ˆéš pairs è¡¨åŒæ­¥ï¼‰

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraphï¼ˆpairs è¡¨ï¼‰
    â†“
æ›´æ–° total_supply, reserve0, reserve1
    â†“
å‰ç«¯æŸ¥è¯¢æ—¶è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **é“¾ä¸ŠæŸ¥è¯¢**ï¼šLP Token ä½™é¢å¿…é¡»ä»é“¾ä¸ŠæŸ¥è¯¢ï¼ˆæœ€å‡†ç¡®ï¼‰
- âœ… **GraphQL æŸ¥è¯¢**ï¼šPool ä¿¡æ¯ä»åç«¯æŸ¥è¯¢ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
- âœ… **å‰ç«¯è®¡ç®—**ï¼šç”¨æˆ·ä»½é¢å’Œä»·å€¼ç”±å‰ç«¯è®¡ç®—ï¼ˆçµæ´»ï¼‰
- âŒ **ä¸å­˜å‚¨ç”¨æˆ·æ•°æ®**ï¼šä¸åœ¨åç«¯å­˜å‚¨ç”¨æˆ·ä»“ä½ï¼ˆéšç§è€ƒè™‘ï¼‰

---

## Tokens é¡µé¢æ¨¡å—

### æ¨¡å—æ¦‚è¿°

**æ ¸å¿ƒåŠŸèƒ½**ï¼šå±•ç¤ºæ‰€æœ‰ Token çš„åˆ—è¡¨å’Œè¯¦æƒ…

**ç”¨æˆ·åœºæ™¯**ï¼š
- æµè§ˆæ‰€æœ‰å¯ç”¨çš„ Token
- æŸ¥çœ‹ Token çš„ä»·æ ¼ã€TVLã€äº¤æ˜“é‡
- æŸ¥çœ‹ Token çš„ä»·æ ¼å›¾è¡¨å’Œäº¤æ˜“å†å²
- æœç´¢å’Œç­›é€‰ Token

**é¡µé¢è·¯ç”±**ï¼š`/tokens`

**è®¿é—®é¢‘ç‡**ï¼šé«˜

---

### åŠŸèƒ½ 4.1.1ï¼šToken åˆ—è¡¨ï¼ˆæŒ‰ TVL æ’åºï¼‰

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºæ‰€æœ‰ Token çš„åˆ—è¡¨ï¼ŒæŒ‰ TVL ä»é«˜åˆ°ä½æ’åºï¼Œæ”¯æŒæœç´¢å’Œåˆ†é¡µ

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æµè§ˆæ‰€æœ‰å¯ç”¨çš„ Tokenï¼Œæ‰¾åˆ° TVL æœ€é«˜æˆ–äº¤æ˜“é‡æœ€å¤§çš„ Token

**æ•°æ®é‡çº§**ï¼šTop 100ï¼ˆé»˜è®¤å±•ç¤ºå‰ 100 ä¸ªï¼Œæ”¯æŒåŠ è½½æ›´å¤šï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­ ä¸­  
**è®¿é—®é¢‘ç‡**ï¼šé«˜  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ |
|-------|-------|------|
| Token åœ°å€ | tokens | id, address |
| Token ä¿¡æ¯ | tokens | symbol, name, decimals |
| å½“å‰ä»·æ ¼ | tokens | price_usd |
| TVL | tokens | tvl_usd |
| 24h äº¤æ˜“é‡ | token_day_data | daily_volume_usd |
| 24h ä»·æ ¼å˜åŒ– | token_day_data | price_change_24h |

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, first, orderByï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æŸ¥è¯¢ PostgreSQL tokens è¡¨
    â†“
ORDER BY tvl_usd DESC
LIMIT 100
    â†“
è¿”å›ç»“æœï¼ˆ< 100msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  tokens(
    chainId: String!
    first: Int = 100
    orderBy: TokenOrderBy = TVL_DESC
    cursor: String
  ): TokenConnection!
}

type TokenConnection {
  edges: [TokenEdge!]!
  pageInfo: PageInfo!
}

type TokenEdge {
  node: Token!
  cursor: String!
}

type Token {
  id: ID!
  address: String!
  symbol: String!
  name: String!
  decimals: Int!
  priceUsd: String!
  tvlUsd: String!
  volume24h: String!
  priceChange24h: String!
}

enum TokenOrderBy {
  TVL_DESC
  VOLUME_DESC
  PRICE_DESC
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼šæ¯ 5 åˆ†é’Ÿ

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraphï¼ˆtokens è¡¨ï¼‰
    â†“
query {
  tokens(
    first: 1000
    orderBy: totalLiquidity
    orderDirection: desc
  ) {
    id
    symbol
    name
    decimals
    derivedETH
    totalLiquidity
    tradeVolume
    tradeVolumeUSD
    txCount
  }
}
    â†“
å†™å…¥ PostgreSQL tokens è¡¨
    â”œâ”€ ä½¿ç”¨ id ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â””â”€ INSERT ON CONFLICT UPDATE
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **ä¸ä½¿ç”¨ Redis**ï¼šæ•°æ®é‡å¤§ï¼ˆ100+ æ¡ï¼‰ï¼Œæ’åºå¤æ‚ï¼Œä¸é€‚åˆ Redis
- âœ… **GraphQL æŸ¥è¯¢**ï¼šæ”¯æŒçµæ´»çš„æ’åºã€åˆ†é¡µã€å­—æ®µé€‰æ‹©
- âœ… **å®šæ—¶åŒæ­¥**ï¼š5 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šToken æ•°æ®å˜åŒ–æ…¢ï¼Œä¸éœ€è¦å®æ—¶æ¨é€

---

### åŠŸèƒ½ 4.1.2ï¼šToken è¯¦æƒ…é¡µ

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºå•ä¸ª Token çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»·æ ¼å›¾è¡¨ã€äº¤æ˜“é‡å›¾è¡¨ã€äº¤æ˜“å†å²

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æ·±å…¥äº†è§£æŸä¸ª Token çš„è¯¦ç»†æ•°æ®ï¼Œå†³å®šæ˜¯å¦äº¤æ˜“

**æ•°æ®é‡çº§**ï¼šå•æ¡è®°å½• + å›¾è¡¨æ•°æ®ï¼ˆæœ€è¿‘ 7 å¤©ï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­â­ é«˜  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | æ—¶é—´ç»´åº¦ | è®¡ç®—æ–¹å¼ |
|-------|-------|------|---------|---------|
| Token åŸºæœ¬ä¿¡æ¯ | tokens | address, symbol, name, decimals | - | - |
| å½“å‰ä»·æ ¼ | tokens | price_usd | å½“å‰ | derivedETH Ã— ethPrice |
| TVL | tokens | tvl_usd | å½“å‰ | totalLiquidity Ã— derivedETH Ã— ethPrice |
| 24h äº¤æ˜“é‡ | token_day_data | daily_volume_usd | æ˜¨å¤© | - |
| 24h ä»·æ ¼å˜åŒ– | token_day_data | price_change_24h | æ˜¨å¤© | (ä»Šå¤©ä»·æ ¼ - æ˜¨å¤©ä»·æ ¼) / æ˜¨å¤©ä»·æ ¼ Ã— 100% |
| 52å‘¨æœ€é«˜ä»· | token_day_data | price_usd | æœ€è¿‘ 365 å¤© | MAX(price_usd) |
| 52å‘¨æœ€ä½ä»· | token_day_data | price_usd | æœ€è¿‘ 365 å¤© | MIN(price_usd) |
| ä»·æ ¼å†å²ï¼ˆKçº¿/OHLCï¼‰ | token_hour_data / token_day_data | open, high, low, close | å¯é€‰èŒƒå›´ | - |
| äº¤æ˜“é‡å†å² | token_hour_data / token_day_data | hourly_volume_usd / daily_volume_usd | å¯é€‰èŒƒå›´ | - |
| TVL å†å² | token_hour_data / token_day_data | tvl_usd | å¯é€‰èŒƒå›´ | - |
| è¯¥ Token çš„æ‰€æœ‰ Pool | pairs | - | - | WHERE token0 = ? OR token1 = ? |
| æœ€è¿‘äº¤æ˜“ | swaps | transaction_id, timestamp, amounts | æœ€è¿‘ 20 ç¬” | WHERE token0 = ? OR token1 = ? |

**æ—¶é—´èŒƒå›´é€‰é¡¹**ï¼š
- `HOUR`ï¼šæœ€è¿‘ 1 å°æ—¶ï¼ˆä½¿ç”¨ token_hour_dataï¼‰
- `DAY`ï¼šæœ€è¿‘ 1 å¤©ï¼ˆä½¿ç”¨ token_hour_dataï¼‰
- `WEEK`ï¼šæœ€è¿‘ 7 å¤©ï¼ˆä½¿ç”¨ token_day_dataï¼‰
- `MONTH`ï¼šæœ€è¿‘ 30 å¤©ï¼ˆä½¿ç”¨ token_day_dataï¼‰
- `YEAR`ï¼šæœ€è¿‘ 365 å¤©ï¼ˆä½¿ç”¨ token_day_dataï¼‰

**è¯´æ˜**ï¼š
- âš ï¸ **Kçº¿æ•°æ®ï¼ˆOHLCï¼‰**ï¼šUniswap V2 æ ‡å‡† Subgraph çš„ `TokenHourData` **æ²¡æœ‰** OHLC å­—æ®µ
- âœ… **è§£å†³æ–¹æ¡ˆ**ï¼šéœ€è¦ä½¿ç”¨ **v2-tokens Subgraph**ï¼ˆä¸“é—¨æä¾› Token Kçº¿æ•°æ®ï¼‰æˆ–åç«¯è®¡ç®—
- âœ… **åç«¯è®¡ç®—æ–¹æ¡ˆ**ï¼šä» `token_hour_data` çš„ `price_usd` å­—æ®µè®¡ç®—æ¯å°æ—¶çš„ OHLC

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, tokenAddressï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æŸ¥è¯¢ PostgreSQL
    â”œâ”€ tokens è¡¨ï¼ˆåŸºæœ¬ä¿¡æ¯ï¼‰
    â”œâ”€ token_day_data è¡¨ï¼ˆ24h æ•°æ®ï¼‰
    â”œâ”€ token_hour_data è¡¨ï¼ˆå›¾è¡¨æ•°æ®ï¼‰
    â””â”€ swaps è¡¨ï¼ˆæœ€è¿‘äº¤æ˜“ï¼ŒWHERE token0 = ? OR token1 = ?ï¼‰
    â†“
è¿”å›ç»“æœï¼ˆ< 200msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  tokenDetails(
    chainId: String!
    tokenAddress: String!
  ): TokenDetails
}

type TokenDetails {
  # åŸºæœ¬ä¿¡æ¯
  id: ID!
  address: String!
  symbol: String!
  name: String!
  decimals: Int!
  priceUsd: String!
  tvlUsd: String!
  
  # 24h ç»Ÿè®¡
  volume24h: String!
  priceChange24h: String!
  
  # 52å‘¨ä»·æ ¼èŒƒå›´
  priceHigh52w: String!
  priceLow52w: String!
  
  # å›¾è¡¨æ•°æ®ï¼ˆæ”¯æŒå¤šç§æ—¶é—´èŒƒå›´ï¼‰
  priceHistory(duration: HistoryDuration!): [PricePoint!]!
  priceOHLC(duration: HistoryDuration!): [OHLCPoint!]!    # Kçº¿å›¾æ•°æ®
  volumeHistory(duration: HistoryDuration!): [VolumePoint!]!
  tvlHistory(duration: HistoryDuration!): [TvlPoint!]!
  
  # è¯¥ Token çš„æ‰€æœ‰ Pool
  pools: [Pool!]!
  
  # æœ€è¿‘äº¤æ˜“
  recentSwaps: [Swap!]!
}

type OHLCPoint {
  timestamp: Int!
  open: String!
  high: String!
  low: String!
  close: String!
}

type TvlPoint {
  timestamp: Int!
  tvl: String!
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼š
- tokens è¡¨ï¼šæ¯ 5 åˆ†é’Ÿ
- token_day_data è¡¨ï¼šæ¯å¤©å‡Œæ™¨ï¼ˆæ˜¨å¤©çš„æ•°æ®ï¼‰
- token_hour_data è¡¨ï¼šæ¯å°æ—¶

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraph
    â†“
query {
  # æ¯å°æ—¶åŒæ­¥
  tokenHourDatas(
    where: { 
      token: "0xabc...",
      hourStartUnix_gte: <7å¤©å‰>
    }
  ) {
    id
    hourStartUnix
    priceUSD
    totalLiquidityUSD
    hourlyVolumeUSD
  }
}
    â†“
å†™å…¥ PostgreSQL token_hour_data è¡¨
    â”œâ”€ ä½¿ç”¨ id ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â””â”€ INSERT ON CONFLICT UPDATE
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **GraphQL æŸ¥è¯¢**ï¼šä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰æ•°æ®ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
- âœ… **å®šæ—¶åŒæ­¥**ï¼šåˆ†å±‚åŒæ­¥ï¼ˆ5åˆ†é’Ÿ/1å°æ—¶/1å¤©ï¼‰ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
- âœ… **å›¾è¡¨æ•°æ®**ï¼šä½¿ç”¨ token_hour_dataï¼Œæä¾›è¶³å¤Ÿçš„ç²’åº¦
- âŒ **ä¸ä½¿ç”¨ Redis**ï¼šæ•°æ®é‡å¤§ï¼ŒæŸ¥è¯¢å¤æ‚ï¼Œä¸é€‚åˆç¼“å­˜
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šå›¾è¡¨æ•°æ®ä¸éœ€è¦å®æ—¶æ›´æ–°

---

### åŠŸèƒ½ 4.1.3ï¼šToken ä»·æ ¼ K çº¿å›¾

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤º Token çš„ä»·æ ¼ K çº¿å›¾ï¼ˆOHLCï¼šå¼€ç›˜ä»·ã€æœ€é«˜ä»·ã€æœ€ä½ä»·ã€æ”¶ç›˜ä»·ï¼‰

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æŸ¥çœ‹ Token çš„ä»·æ ¼èµ°åŠ¿ï¼Œè¿›è¡ŒæŠ€æœ¯åˆ†æ

**æ•°æ®é‡çº§**ï¼šæ ¹æ®æ—¶é—´èŒƒå›´ä¸åŒï¼ˆæœ€å¤š 365 ä¸ªæ•°æ®ç‚¹ï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­â­ é«˜  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šå°æ—¶çº§/å¤©çº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | è¯´æ˜ |
|-------|-------|------|------|
| OHLC æ•°æ® | token_hour_data / token_day_data | open, high, low, close | âš ï¸ V2 æ ‡å‡† Subgraph æ²¡æœ‰æ­¤å­—æ®µ |
| æ—¶é—´æˆ³ | token_hour_data / token_day_data | hour_start_unix / date | - |

**é‡è¦è¯´æ˜**ï¼š

âš ï¸ **Uniswap V2 æ ‡å‡† Subgraph çš„é™åˆ¶**ï¼š
- `TokenHourData` å’Œ `TokenDayData` **æ²¡æœ‰** `open`, `high`, `low`, `close` å­—æ®µ
- åªæœ‰ `priceUSD` å­—æ®µï¼ˆæŸä¸ªæ—¶åˆ»çš„ä»·æ ¼å¿«ç…§ï¼‰

âœ… **è§£å†³æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ v2-tokens Subgraph**
- Uniswap ç»´æŠ¤äº†ä¸€ä¸ªä¸“é—¨çš„ **v2-tokens Subgraph**
- è¯¥ Subgraph çš„ `TokenHourData` **æœ‰** OHLC å­—æ®µ
- ç«¯ç‚¹ï¼šéœ€è¦å•ç‹¬éƒ¨ç½²æˆ–ä½¿ç”¨ Uniswap çš„ç«¯ç‚¹

âœ… **è§£å†³æ–¹æ¡ˆ 2ï¼šåç«¯è®¡ç®— OHLC**
- ä»æ ‡å‡† V2 Subgraph æŸ¥è¯¢ `TokenHourData` çš„ `priceUSD`
- åç«¯æŒ‰å°æ—¶/å¤©èšåˆè®¡ç®— OHLCï¼š
  - `open`ï¼šè¯¥æ—¶é—´æ®µç¬¬ä¸€ä¸ªä»·æ ¼
  - `high`ï¼šè¯¥æ—¶é—´æ®µæœ€é«˜ä»·æ ¼
  - `low`ï¼šè¯¥æ—¶é—´æ®µæœ€ä½ä»·æ ¼
  - `close`ï¼šè¯¥æ—¶é—´æ®µæœ€åä¸€ä¸ªä»·æ ¼

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 2ï¼ˆåç«¯è®¡ç®—ï¼‰ï¼ŒåŸå› ï¼š
- ä¸ä¾èµ–é¢å¤–çš„ Subgraph
- å¯ä»¥å®Œå…¨æ§åˆ¶æ•°æ®è´¨é‡
- å¯ä»¥ç¼“å­˜è®¡ç®—ç»“æœ

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, tokenAddress, durationï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æŸ¥è¯¢ PostgreSQL token_ohlc è¡¨
    â†“
WHERE token_address = ? AND duration = ?
ORDER BY timestamp ASC
    â†“
è¿”å›ç»“æœï¼ˆ< 100msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  tokenPriceOHLC(
    chainId: String!
    tokenAddress: String!
    duration: HistoryDuration!
  ): [OHLCPoint!]!
}

type OHLCPoint {
  timestamp: Int!
  open: String!
  high: String!
  low: String!
  close: String!
  volume: String!    # å¯é€‰ï¼šè¯¥æ—¶é—´æ®µçš„äº¤æ˜“é‡
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹ï¼ˆåç«¯è®¡ç®— OHLCï¼‰

**åŒæ­¥é¢‘ç‡**ï¼šæ¯å°æ—¶

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraphï¼ˆtoken_hour_data æˆ– token_day_dataï¼‰
    â†“
query {
  tokenHourDatas(
    where: { 
      token: "0xabc...",
      periodStartUnix_gte: <ä¸Šæ¬¡åŒæ­¥æ—¶é—´>
    }
    orderBy: periodStartUnix
    orderDirection: asc
  ) {
    id
    periodStartUnix
    priceUSD
    hourlyVolumeUSD
  }
}
    â†“
æŒ‰å°æ—¶èšåˆè®¡ç®— OHLC
    â”œâ”€ å¦‚æœè¯¥å°æ—¶åªæœ‰ä¸€ä¸ªæ•°æ®ç‚¹ï¼šopen = high = low = close
    â”œâ”€ å¦‚æœè¯¥å°æ—¶æœ‰å¤šä¸ªæ•°æ®ç‚¹ï¼š
    â”‚   â”œâ”€ open = ç¬¬ä¸€ä¸ª priceUSD
    â”‚   â”œâ”€ high = MAX(priceUSD)
    â”‚   â”œâ”€ low = MIN(priceUSD)
    â”‚   â””â”€ close = æœ€åä¸€ä¸ª priceUSD
    â””â”€ volume = SUM(hourlyVolumeUSD)
    â†“
å†™å…¥ PostgreSQL token_ohlc è¡¨
    â”œâ”€ ä½¿ç”¨ token_address + timestamp ä½œä¸ºå”¯ä¸€æ ‡è¯†
    â””â”€ INSERT ON CONFLICT UPDATE
```

**æ•°æ®åº“è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE token_ohlc (
  id BIGSERIAL PRIMARY KEY,
  chain_id VARCHAR(50) NOT NULL,
  token_address VARCHAR(42) NOT NULL,
  timestamp BIGINT NOT NULL,
  duration VARCHAR(20) NOT NULL,  -- HOUR | DAY
  open NUMERIC(78, 18),
  high NUMERIC(78, 18),
  low NUMERIC(78, 18),
  close NUMERIC(78, 18),
  volume NUMERIC(78, 18),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(chain_id, token_address, timestamp, duration)
);

CREATE INDEX idx_token_ohlc_lookup 
ON token_ohlc(chain_id, token_address, duration, timestamp);
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **PostgreSQL å­˜å‚¨**ï¼šOHLC æ•°æ®é€‚åˆå…³ç³»å‹æ•°æ®åº“
- âœ… **å®šæ—¶åŒæ­¥**ï¼šæ¯å°æ—¶åŒæ­¥ä¸€æ¬¡ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
- âœ… **åç«¯è®¡ç®—**ï¼šä¸ä¾èµ–é¢å¤–çš„ Subgraphï¼Œå®Œå…¨å¯æ§
- âŒ **ä¸ä½¿ç”¨ Redis**ï¼šKçº¿æ•°æ®é‡å¤§ï¼Œä¸é€‚åˆç¼“å­˜
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šKçº¿æ•°æ®ä¸éœ€è¦å®æ—¶æ›´æ–°

---

### åŠŸèƒ½ 4.1.4ï¼šToken çš„æ‰€æœ‰ Pool åˆ—è¡¨

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºåŒ…å«è¯¥ Token çš„æ‰€æœ‰æµåŠ¨æ€§æ± 

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æŸ¥çœ‹è¯¥ Token åœ¨å“ªäº›æ± å­ä¸­æœ‰æµåŠ¨æ€§ï¼Œé€‰æ‹©æœ€ä¼˜çš„äº¤æ˜“æ± 

**æ•°æ®é‡çº§**ï¼šé€šå¸¸ < 20 ä¸ª Pool

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­ ä¸­  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | æŸ¥è¯¢æ¡ä»¶ |
|-------|-------|------|---------|
| Pool åˆ—è¡¨ | pairs | - | WHERE token0 = ? OR token1 = ? |
| é…å¯¹ Token | tokens | symbol, name | - |
| TVL | pairs | reserve_usd | - |
| 24h äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | - |
| APR | - | - | è®¡ç®— |

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, tokenAddressï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æŸ¥è¯¢ PostgreSQL pairs è¡¨
    â†“
WHERE (token0_address = ? OR token1_address = ?)
  AND reserve_usd > 0
ORDER BY reserve_usd DESC
    â†“
è¿”å›ç»“æœï¼ˆ< 50msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  tokenPools(
    chainId: String!
    tokenAddress: String!
  ): [Pool!]!
}

type Pool {
  id: ID!
  address: String!
  token0: Token!
  token1: Token!
  reserveUsd: String!
  volume24h: String!
  apr: String!
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼šæ¯ 5 åˆ†é’Ÿï¼ˆéš pairs è¡¨åŒæ­¥ï¼‰

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ Subgraphï¼ˆpairs è¡¨ï¼‰
    â†“
æ›´æ–° pairs è¡¨
    â†“
å‰ç«¯æŸ¥è¯¢æ—¶è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **ä¸ä½¿ç”¨ Redis**ï¼šæ•°æ®é‡å°ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“å³å¯
- âœ… **GraphQL æŸ¥è¯¢**ï¼šæ”¯æŒçµæ´»çš„è¿‡æ»¤å’Œæ’åº
- âœ… **å®šæ—¶åŒæ­¥**ï¼š5 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œä¿æŒæ•°æ®æ–°é²œ
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šæ•°æ®å˜åŒ–æ…¢ï¼Œä¸éœ€è¦å®æ—¶æ¨é€

---

## Explore é¡µé¢æ¨¡å—

### æ¨¡å—æ¦‚è¿°

**æ ¸å¿ƒåŠŸèƒ½**ï¼šå±•ç¤ºå…¨å±€çš„äº¤æ˜“æµå’Œç»Ÿè®¡æ•°æ®

**ç”¨æˆ·åœºæ™¯**ï¼š
- æŸ¥çœ‹å…¨é“¾æœ€æ–°äº¤æ˜“
- æŸ¥çœ‹çƒ­é—¨ Pool å’Œ Token
- æŸ¥çœ‹å…¨å±€ç»Ÿè®¡æ•°æ®ï¼ˆæ€» TVLã€24h äº¤æ˜“é‡ç­‰ï¼‰

**é¡µé¢è·¯ç”±**ï¼š`/explore`

**è®¿é—®é¢‘ç‡**ï¼šä¸­

---

### åŠŸèƒ½ 5.1.1ï¼šå…¨é“¾äº¤æ˜“æµ

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºå…¨é“¾æœ€æ–°çš„äº¤æ˜“è®°å½•ï¼ˆSwapã€Addã€Removeï¼‰

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦æŸ¥çœ‹æ•´ä¸ªå¹³å°çš„å®æ—¶äº¤æ˜“æ´»åŠ¨

**æ•°æ®é‡çº§**ï¼šæœ€è¿‘ 50 ç¬”äº¤æ˜“

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­â­ ä¸­  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šå®æ—¶

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ |
|-------|-------|------|
| äº¤æ˜“å“ˆå¸Œ | swaps / mints / burns | transaction_id |
| äº¤æ˜“æ—¶é—´ | swaps / mints / burns | timestamp |
| äº¤æ˜“ç±»å‹ | - | æ ¹æ®è¡¨ååˆ¤æ–­ï¼ˆswap/mint/burnï¼‰ |
| äº¤æ˜“è´¦æˆ· | swaps / mints / burns | from_address |
| Token0 ä¿¡æ¯ | tokens | symbol, name |
| Token1 ä¿¡æ¯ | tokens | symbol, name |
| Token0 æ•°é‡ | swaps / mints / burns | amount0 |
| Token1 æ•°é‡ | swaps / mints / burns | amount1 |
| USD ä»·å€¼ | swaps / mints / burns | amount_usd |

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainId, firstï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æŸ¥è¯¢ PostgreSQL
    â”œâ”€ swaps è¡¨ï¼ˆæœ€è¿‘ 50 ç¬”ï¼‰
    â”œâ”€ mints è¡¨ï¼ˆæœ€è¿‘ 50 ç¬”ï¼‰
    â””â”€ burns è¡¨ï¼ˆæœ€è¿‘ 50 ç¬”ï¼‰
    â†“
åˆå¹¶ä¸‰ä¸ªè¡¨çš„ç»“æœ
    â†“
æŒ‰ timestamp é™åºæ’åº
    â†“
å–å‰ 50 æ¡
    â†“
è¿”å›ç»“æœï¼ˆ< 100msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  recentTransactions(
    chainId: String!
    first: Int = 50
  ): [Transaction!]!
}

type Transaction {
  id: ID!
  transactionId: String!
  timestamp: Int!
  type: TransactionType!
  account: String!
  token0: Token!
  token1: Token!
  amount0: String!
  amount1: String!
  amountUsd: String!
}

enum TransactionType {
  SWAP
  MINT
  BURN
}
```

---

##### 2. WS ç›‘å¬å®æ—¶æ›´æ–°æµç¨‹

**ç›‘å¬äº‹ä»¶**ï¼šSwapã€Mintã€Burn äº‹ä»¶

**å¤„ç†é€»è¾‘**ï¼š
```
åŒºå—é“¾è§¦å‘äº‹ä»¶
    â†“
WS ç›‘å¬å™¨æ•è·äº‹ä»¶
    â†“
è§£æäº‹ä»¶æ•°æ®
    â†“
å†™å…¥ Redisï¼ˆLPUSH åˆ° List å¤´éƒ¨ï¼‰
    â”œâ”€ Key: recent-transactions:{chainId}
    â”œâ”€ ä¿ç•™æœ€è¿‘ 50 æ¡ï¼ˆLTRIM 0 49ï¼‰
    â””â”€ ä¸å†™æ•°æ®åº“
    â†“
é€šè¿‡ SSE æ¨é€äº‹ä»¶ç»™å‰ç«¯
    â†“
å‰ç«¯é‡æ–°æŸ¥è¯¢ GraphQL
    â†“
ç”¨æˆ·çœ‹åˆ°æœ€æ–°äº¤æ˜“
```

---

##### 3. å‰ç«¯è§¦å‘åŒæ­¥æµç¨‹

**è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·æ‰§è¡Œäº¤æ˜“æˆåŠŸå

**å‰ç«¯å‘é€ä¿¡æ¯**ï¼ˆREST APIï¼‰ï¼š
```json
POST /api/sync/transaction

{
  "txHash": "0xabc...",
  "chainId": 11155111,
  "type": "swap"  // swap | mint | burn
}
```

**åç«¯å¤„ç†é€»è¾‘**ï¼š
```
æ¥æ”¶å‰ç«¯ä¿¡å·
    â†“
æŸ¥è¯¢ Subgraphï¼ˆæ ¹æ® txHash æŸ¥è¯¢ï¼‰
    â†“
å†™å…¥å¯¹åº”çš„è¡¨ï¼ˆswaps / mints / burnsï¼‰
    â†“
ä¸åˆ é™¤ Redis ç¼“å­˜
    â†“
è¿”å›æˆåŠŸå“åº”
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **Redis ä¼˜å…ˆ**ï¼šçƒ­ç‚¹æ•°æ®ï¼Œè®¿é—®é¢‘ç‡é«˜ï¼Œæ¯«ç§’çº§å“åº”
- âœ… **GraphQL æŸ¥è¯¢**ï¼šRedis æœªå‘½ä¸­æ—¶æŸ¥è¯¢ PostgreSQL
- âœ… **WS ç›‘å¬åªå†™ Redis**ï¼šä¿è¯å®æ—¶æ€§ï¼Œé™ä½æ•°æ®åº“å‹åŠ›
- âœ… **å‰ç«¯è§¦å‘å†™ DB**ï¼šç”¨æˆ·äº¤æ˜“åæŒä¹…åŒ–ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§
- âœ… **SSE æ¨é€**ï¼šè®©æ‰€æœ‰ç”¨æˆ·å®æ—¶çœ‹åˆ°æ–°äº¤æ˜“
- âŒ **ä¸éœ€è¦å®šæ—¶åŒæ­¥**ï¼šå‰ç«¯è§¦å‘å·²è¦†ç›–

---

### åŠŸèƒ½ 5.1.2ï¼šå…¨å±€ç»Ÿè®¡æ•°æ®

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºå…¨å±€çš„ç»Ÿè®¡æ•°æ®ï¼ˆæ€» TVLã€24h äº¤æ˜“é‡ã€24h æ‰‹ç»­è´¹ç­‰ï¼‰

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦äº†è§£æ•´ä¸ªå¹³å°çš„è§„æ¨¡å’Œæ´»è·ƒåº¦

**æ•°æ®é‡çº§**ï¼šå•æ¡è®°å½•ï¼ˆèšåˆæ•°æ®ï¼‰

**ç”¨æˆ·æ„ŸçŸ¥**ï¼šâ­â­ ä½  
**è®¿é—®é¢‘ç‡**ï¼šä¸­  
**æ•°æ®å˜åŒ–é¢‘ç‡**ï¼šåˆ†é’Ÿçº§

---

#### æ•°æ®éœ€æ±‚

| æ•°æ®é¡¹ | æ¥æºè¡¨ | å­—æ®µ | è®¡ç®—æ–¹å¼ |
|-------|-------|------|---------|
| æ€» TVL | pairs | reserve_usd | SUM(reserve_usd) |
| 24h äº¤æ˜“é‡ | pair_day_data | daily_volume_usd | SUM(daily_volume_usd) WHERE date = æ˜¨å¤© |
| 24h æ‰‹ç»­è´¹ | pair_day_data | daily_volume_usd * 0.003 | è®¡ç®— |
| æ€»äº¤æ˜“ç¬”æ•° | pairs | tx_count | SUM(tx_count) |

---

#### å®Œæ•´æµç¨‹è¯´æ˜

##### 1. å‰ç«¯æŸ¥è¯¢æµç¨‹

**æŸ¥è¯¢æ–¹å¼**ï¼šGraphQL

**æŸ¥è¯¢é€»è¾‘**ï¼š
```
å‰ç«¯å‘èµ·æŸ¥è¯¢ï¼ˆchainIdï¼‰
    â†“
GraphQL Resolver æ¥æ”¶è¯·æ±‚
    â†“
æ£€æŸ¥ Redis ç¼“å­˜ï¼ˆKey: global-stats:{chainId}ï¼‰
    â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›ï¼ˆ< 5msï¼‰
    â””â”€ æœªå‘½ä¸­ â†’ æŸ¥è¯¢ PostgreSQL
              â†“
              èšåˆæŸ¥è¯¢ï¼ˆSUMï¼‰
              â†“
              å†™å…¥ Redis ç¼“å­˜ï¼ˆTTL: 300sï¼‰
              â†“
              è¿”å›ç»“æœï¼ˆ< 100msï¼‰
```

**GraphQL Schema**ï¼š
```graphql
type Query {
  globalStats(chainId: String!): GlobalStats
}

type GlobalStats {
  totalTvl: String!
  volume24h: String!
  fees24h: String!
  totalTxCount: Int!
}
```

---

##### 2. å®šæ—¶åŒæ­¥æµç¨‹

**åŒæ­¥é¢‘ç‡**ï¼šæ¯ 5 åˆ†é’Ÿ

**åŒæ­¥é€»è¾‘**ï¼š
```
å®šæ—¶ä»»åŠ¡è§¦å‘
    â†“
æŸ¥è¯¢ PostgreSQLï¼ˆèšåˆæŸ¥è¯¢ï¼‰
    â†“
æ›´æ–° Redis ç¼“å­˜
    â†“
è®¾ç½® TTL 300 ç§’
```

---

#### æ¥æºå†³ç­–ç†ç”±

- âœ… **Redis ç¼“å­˜**ï¼š300 ç§’ TTLï¼Œå‡å°‘æ•°æ®åº“èšåˆæŸ¥è¯¢å‹åŠ›
- âœ… **GraphQL æŸ¥è¯¢**ï¼šRedis æœªå‘½ä¸­æ—¶æŸ¥è¯¢ PostgreSQL
- âœ… **å®šæ—¶åŒæ­¥**ï¼š5 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œä¿æŒç¼“å­˜çƒ­åº¦
- âŒ **ä¸ä½¿ç”¨ WS ç›‘å¬**ï¼šæ•°æ®å˜åŒ–æ…¢ï¼Œä¸éœ€è¦å®æ—¶æ¨é€

---

## å®æ—¶æ¨é€æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆéœ€è¦å®æ—¶æ¨é€ï¼Ÿ

**é—®é¢˜**ï¼šç”¨æˆ· B åœ¨æŸ¥çœ‹ Swap é¡µé¢æ—¶ï¼Œç”¨æˆ· A æ‰§è¡Œäº†ä¸€ç¬”äº¤æ˜“ï¼ŒWS ç›‘å¬å·²ç»å†™å…¥ Redisï¼Œä½†ç”¨æˆ· B çš„é¡µé¢ä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåç«¯é€šè¿‡ SSEï¼ˆServer-Sent Eventsï¼‰æ¨é€äº‹ä»¶ï¼Œé€šçŸ¥å‰ç«¯æœ‰æ–°äº¤æ˜“ï¼Œå‰ç«¯é‡æ–°æŸ¥è¯¢ GraphQLã€‚

---

### SSE å®ç°æ–¹æ¡ˆï¼ˆæ¨èï¼‰

#### åç«¯å®ç°é€»è¾‘

**SSE ç«¯ç‚¹**ï¼š
```
GET /api/events/swap-updates?pairAddress=0xdef...
```

**è¿æ¥ç®¡ç†**ï¼š
```
ç”¨æˆ·æ‰“å¼€ Swap é¡µé¢
    â†“
å‰ç«¯å»ºç«‹ SSE è¿æ¥ï¼ˆè®¢é˜…ç‰¹å®š Pairï¼‰
    â†“
åç«¯ç»´æŠ¤è¿æ¥æ± ï¼šMap<pairAddress, Set<SSEè¿æ¥>>
    â†“
WS ç›‘å¬åˆ°æ–°äº¤æ˜“
    â†“
æŸ¥æ‰¾è¯¥ Pair çš„æ‰€æœ‰ SSE è¿æ¥
    â†“
æ¨é€äº‹ä»¶ï¼ševent: swap-update, data: {"pairAddress": "0xdef...", "txHash": "0xabc..."}
    â†“
å‰ç«¯æ”¶åˆ°äº‹ä»¶ï¼Œé‡æ–°æŸ¥è¯¢ GraphQL
    â†“
ç”¨æˆ·çœ‹åˆ°æœ€æ–°äº¤æ˜“
```

**è¿æ¥ç”Ÿå‘½å‘¨æœŸ**ï¼š
- **å»ºç«‹è¿æ¥**ï¼šå‰ç«¯æ‰“å¼€é¡µé¢æ—¶å»ºç«‹
- **ä¿æŒè¿æ¥**ï¼šåç«¯å®šæœŸå‘é€å¿ƒè·³ï¼ˆæ¯ 30 ç§’ï¼‰
- **æ–­å¼€è¿æ¥**ï¼šç”¨æˆ·å…³é—­é¡µé¢æˆ–ç½‘ç»œæ–­å¼€
- **è‡ªåŠ¨é‡è¿**ï¼šSSE è‡ªå¸¦é‡è¿æœºåˆ¶

---

#### å‰ç«¯å®ç°é€»è¾‘

**å»ºç«‹è¿æ¥**ï¼š
```typescript
// ä¼ªä»£ç 
const eventSource = new EventSource(
  `/api/events/swap-updates?pairAddress=${pairAddress}`
);

eventSource.addEventListener('swap-update', (event) => {
  const data = JSON.parse(event.data);
  // é‡æ–°æŸ¥è¯¢ GraphQL
  refetchSwaps();
});

eventSource.addEventListener('error', () => {
  // è‡ªåŠ¨é‡è¿ï¼ˆSSE å†…ç½®ï¼‰
});
```

**æ¸…ç†è¿æ¥**ï¼š
```typescript
// ç”¨æˆ·ç¦»å¼€é¡µé¢æ—¶
useEffect(() => {
  return () => {
    eventSource.close();
  };
}, []);
```

---

### å¤‡é€‰æ–¹æ¡ˆï¼šçŸ­è½®è¯¢

**é€‚ç”¨åœºæ™¯**ï¼šSSE ä¸å¯ç”¨æ—¶ï¼ˆå¦‚æŸäº›ä»£ç†æœåŠ¡å™¨ä¸æ”¯æŒï¼‰

**å®ç°é€»è¾‘**ï¼š
```
å‰ç«¯æ¯ 5 ç§’æŸ¥è¯¢ä¸€æ¬¡ GraphQL
    â†“
query { pairRecentSwaps(pairAddress: "0xdef...") }
    â†“
æ¯”è¾ƒè¿”å›æ•°æ®ä¸å½“å‰æ•°æ®
    â†“
å¦‚æœæœ‰æ–°äº¤æ˜“ï¼Œæ›´æ–° UI
```

**ä¼˜ç¼ºç‚¹**ï¼š
- âœ… ç®€å•ï¼Œæ— éœ€ç»´æŠ¤è¿æ¥
- âŒ å»¶è¿Ÿè¾ƒé«˜ï¼ˆ5 ç§’ï¼‰
- âŒ å¢åŠ æœåŠ¡å™¨è´Ÿè½½ï¼ˆé¢‘ç¹æŸ¥è¯¢ï¼‰

---

### æ€§èƒ½ä¼˜åŒ–

**è¿æ¥æ± ç®¡ç†**ï¼š
- é™åˆ¶å•ä¸ª Pair çš„æœ€å¤§è¿æ¥æ•°ï¼ˆå¦‚ 1000ï¼‰
- è¶…è¿‡é™åˆ¶æ—¶ï¼Œæ‹’ç»æ–°è¿æ¥æˆ–å…³é—­æœ€æ—§çš„è¿æ¥

**äº‹ä»¶è¿‡æ»¤**ï¼š
- åªæ¨é€ç”¨æˆ·è®¢é˜…çš„ Pair çš„äº‹ä»¶
- é¿å…æ¨é€æ— å…³äº‹ä»¶

**æ‰¹é‡æ¨é€**ï¼š
- å¦‚æœçŸ­æ—¶é—´å†…æœ‰å¤šç¬”äº¤æ˜“ï¼ˆå¦‚ 1 ç§’å†… 10 ç¬”ï¼‰
- åˆå¹¶ä¸ºä¸€ä¸ªäº‹ä»¶æ¨é€ï¼Œå‡å°‘ç½‘ç»œå¼€é”€

---

## è¾¹ç•Œæƒ…å†µä¸é—®é¢˜å¤„ç†


---

### é—®é¢˜ 1ï¼šRedis é‡å¯åæ•°æ®ä¸¢å¤±

**åœºæ™¯**ï¼š
- Redis é‡å¯æˆ–æ•…éšœ
- æ‰€æœ‰ç¼“å­˜æ•°æ®ä¸¢å¤±
- ç”¨æˆ·æŸ¥è¯¢æ—¶éœ€è¦ä»æ•°æ®åº“é‡æ–°åŠ è½½

**å½±å“**ï¼š
- çŸ­æ—¶é—´å†…å¤§é‡æŸ¥è¯¢æ‰“åˆ°æ•°æ®åº“
- æ•°æ®åº“å‹åŠ›æ¿€å¢ï¼ˆç¼“å­˜é›ªå´©ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **Redis æŒä¹…åŒ–**
   - å¯ç”¨ RDB æˆ– AOF æŒä¹…åŒ–
   - é‡å¯åè‡ªåŠ¨æ¢å¤æ•°æ®

2. **ç¼“å­˜é¢„çƒ­**
   - Redis é‡å¯åï¼Œåå°ä»»åŠ¡é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
   - æŸ¥è¯¢æœ€æ´»è·ƒçš„ Top 100 Pairï¼Œå†™å…¥ç¼“å­˜

3. **é™æµä¿æŠ¤**
   - æ•°æ®åº“æŸ¥è¯¢åŠ é™æµï¼ˆå¦‚æ¯ç§’æœ€å¤š 100 æ¬¡ï¼‰
   - è¶…è¿‡é™æµè¿”å›é™çº§æ•°æ®æˆ–é”™è¯¯

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 1ï¼ˆæŒä¹…åŒ–ï¼‰+ æ–¹æ¡ˆ 2ï¼ˆé¢„çƒ­ï¼‰

---

### é—®é¢˜ 3ï¼šWS ç›‘å¬å»¶è¿Ÿæˆ–ä¸¢å¤±äº‹ä»¶

**åœºæ™¯**ï¼š
- WS è¿æ¥æ–­å¼€æˆ–ç½‘ç»œå»¶è¿Ÿ
- æŸäº› Swap äº‹ä»¶æœªè¢«ç›‘å¬åˆ°
- Redis ä¸­ç¼ºå°‘éƒ¨åˆ†äº¤æ˜“è®°å½•

**å½±å“**ï¼š
- ç”¨æˆ·çœ‹åˆ°çš„äº¤æ˜“åˆ—è¡¨ä¸å®Œæ•´
- æ•°æ®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **å‰ç«¯è§¦å‘åŒæ­¥å…œåº•**
   - ç”¨æˆ·äº¤æ˜“åï¼Œå‰ç«¯è§¦å‘åŒæ­¥
   - ä» Subgraph æŸ¥è¯¢å®Œæ•´æ•°æ®ï¼Œå†™å…¥æ•°æ®åº“
   - 60 ç§’åç¼“å­˜è¿‡æœŸï¼ŒæŸ¥è¯¢ä¼šä»æ•°æ®åº“åŠ è½½å®Œæ•´æ•°æ®

2. **WS é‡è¿æœºåˆ¶**
   - WS æ–­å¼€åè‡ªåŠ¨é‡è¿
   - é‡è¿åè¡¥æ‰«ç¼ºå¤±çš„åŒºå—

3. **å®šæœŸå¯¹è´¦**
   - å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯ 10 åˆ†é’Ÿï¼‰å¯¹æ¯” Redis å’Œæ•°æ®åº“
   - å‘ç°ä¸ä¸€è‡´æ—¶ï¼Œä»æ•°æ®åº“é‡æ–°åŠ è½½

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 1ï¼ˆå‰ç«¯è§¦å‘å…œåº•ï¼‰+ æ–¹æ¡ˆ 2ï¼ˆWS é‡è¿ï¼‰

---

### é—®é¢˜ 4ï¼šå‰ç«¯è§¦å‘åŒæ­¥å¤±è´¥

**åœºæ™¯**ï¼š
- å‰ç«¯å‘é€åŒæ­¥è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰
- åç«¯å¤„ç†åŒæ­¥å¤±è´¥ï¼ˆSubgraph æ•…éšœï¼‰
- æ•°æ®æœªå†™å…¥æ•°æ®åº“

**å½±å“**ï¼š
- ç”¨æˆ·çš„äº¤æ˜“æœªæŒä¹…åŒ–
- Redis ç¼“å­˜è¿‡æœŸåï¼Œæ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **å‰ç«¯é‡è¯•æœºåˆ¶**
   - åŒæ­¥å¤±è´¥åï¼Œå‰ç«¯è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
   - ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 4sï¼‰

2. **åç«¯å¹‚ç­‰æ€§**
   - ä½¿ç”¨ `transaction_id` ä½œä¸ºå”¯ä¸€æ ‡è¯†
   - é‡å¤åŒæ­¥ä¸ä¼šæ’å…¥é‡å¤æ•°æ®

3. **é™çº§åˆ°å®šæ—¶åŒæ­¥**
   - å¦‚æœå‰ç«¯è§¦å‘åŒæ­¥æŒç»­å¤±è´¥
   - ä¾èµ–å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯å°æ—¶ï¼‰ä» Subgraph å…¨é‡åŒæ­¥

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 1ï¼ˆå‰ç«¯é‡è¯•ï¼‰+ æ–¹æ¡ˆ 2ï¼ˆå¹‚ç­‰æ€§ï¼‰

---

### é—®é¢˜ 5ï¼šSubgraph æ•°æ®å»¶è¿Ÿ

**åœºæ™¯**ï¼š
- Subgraph ç´¢å¼•å»¶è¿Ÿï¼ˆå¦‚ 10 ç§’ï¼‰
- å‰ç«¯è§¦å‘åŒæ­¥æ—¶ï¼ŒSubgraph è¿˜æœªç´¢å¼•åˆ°è¯¥äº¤æ˜“
- æŸ¥è¯¢ Subgraph è¿”å›ç©ºæ•°æ®

**å½±å“**ï¼š
- æ•°æ®æœªå†™å…¥æ•°æ®åº“
- ç”¨æˆ·çš„äº¤æ˜“æœªæŒä¹…åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **å»¶è¿Ÿé‡è¯•**
   - æŸ¥è¯¢ Subgraph è¿”å›ç©ºæ—¶ï¼Œç­‰å¾… 10 ç§’åé‡è¯•
   - æœ€å¤šé‡è¯• 3 æ¬¡

2. **ä¾èµ– WS æ•°æ®**
   - WS ç›‘å¬çš„æ•°æ®å·²åœ¨ Redis
   - ç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°è‡ªå·±çš„äº¤æ˜“
   - ç­‰å¾… Subgraph ç´¢å¼•å®Œæˆåå†æŒä¹…åŒ–

3. **ç›´æ¥æŸ¥è¯¢é“¾ä¸Š**
   - å¦‚æœ Subgraph æŒç»­å¤±è´¥
   - åç«¯ç›´æ¥æŸ¥è¯¢é“¾ä¸Šæ•°æ®ï¼ˆRPCï¼‰
   - è§£æäº¤æ˜“æ—¥å¿—ï¼Œå†™å…¥æ•°æ®åº“

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 1ï¼ˆå»¶è¿Ÿé‡è¯•ï¼‰+ æ–¹æ¡ˆ 2ï¼ˆä¾èµ– WSï¼‰

---

### é—®é¢˜ 6ï¼šé«˜å¹¶å‘æŸ¥è¯¢å‹åŠ›

**åœºæ™¯**ï¼š
- çƒ­é—¨ Pair è¢«å¤§é‡ç”¨æˆ·åŒæ—¶æŸ¥è¯¢
- Redis ç¼“å­˜è¿‡æœŸç¬é—´ï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
- æ•°æ®åº“å‹åŠ›æ¿€å¢ï¼ˆç¼“å­˜å‡»ç©¿ï¼‰

**å½±å“**ï¼š
- æ•°æ®åº“å“åº”å˜æ…¢
- ç”¨æˆ·æŸ¥è¯¢è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **åˆ†å¸ƒå¼é”**
   - ç¼“å­˜è¿‡æœŸæ—¶ï¼Œåªå…è®¸ä¸€ä¸ªè¯·æ±‚æŸ¥è¯¢æ•°æ®åº“
   - å…¶ä»–è¯·æ±‚ç­‰å¾…ï¼Œç›´åˆ°ç¼“å­˜é‡å»ºå®Œæˆ

2. **æå‰åˆ·æ–°**
   - ç¼“å­˜ TTL å‰©ä½™ 10 ç§’æ—¶ï¼Œå¼‚æ­¥åˆ·æ–°ç¼“å­˜
   - ç”¨æˆ·å§‹ç»ˆå‘½ä¸­ç¼“å­˜

3. **å¤šçº§ç¼“å­˜**
   - å¢åŠ æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚ Caffeineï¼‰
   - Redis æœªå‘½ä¸­æ—¶ï¼Œå…ˆæŸ¥æœ¬åœ°ç¼“å­˜

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 1ï¼ˆåˆ†å¸ƒå¼é”ï¼‰+ æ–¹æ¡ˆ 2ï¼ˆæå‰åˆ·æ–°ï¼‰

---

## æ€§èƒ½æŒ‡æ ‡

### æŸ¥è¯¢æ€§èƒ½ç›®æ ‡

| åœºæ™¯ | ç›®æ ‡å“åº”æ—¶é—´ | æ•°æ®æ¥æº |
|-----|-------------|---------|
| Redis å‘½ä¸­ | < 5ms | Redis |
| Redis æœªå‘½ä¸­ | < 50ms | PostgreSQL + Redis å›å¡« |
| æ•°æ®åº“æŸ¥è¯¢ | < 100ms | PostgreSQL |

### å®æ—¶æ€§ç›®æ ‡

| åœºæ™¯ | ç›®æ ‡å»¶è¿Ÿ | è¯´æ˜ |
|-----|---------|------|
| WS ç›‘å¬å†™å…¥ | < 5 ç§’ | åŒºå—ç¡®è®¤ + WS å»¶è¿Ÿ |
| å‰ç«¯è§¦å‘åŒæ­¥ | < 5 ç§’ | Subgraph æŸ¥è¯¢ + æ•°æ®åº“å†™å…¥ |
| ç¼“å­˜è‡ªç„¶è¿‡æœŸ | 60 ç§’ | TTL è¿‡æœŸåè‡ªåŠ¨é‡æ–°åŠ è½½ |

### æ•°æ®ä¸€è‡´æ€§ç›®æ ‡

| åœºæ™¯ | ä¸€è‡´æ€§çº§åˆ« | è¯´æ˜ |
|-----|-----------|------|
| ç”¨æˆ·è‡ªå·±çš„äº¤æ˜“ | å¼ºä¸€è‡´æ€§ | WS ç›‘å¬ + å‰ç«¯è§¦å‘åŒæ­¥ï¼Œ< 5 ç§’å¯è§ |
| å…¶ä»–ç”¨æˆ·çš„äº¤æ˜“ | æœ€ç»ˆä¸€è‡´æ€§ | 60 ç§’åç¼“å­˜è¿‡æœŸï¼Œä»æ•°æ®åº“åŠ è½½ |
| å†å²æ•°æ® | æœ€ç»ˆä¸€è‡´æ€§ | å®šæ—¶åŒæ­¥ + æŸ¥è¯¢æ—¶å›å¡« |

---

## æ•°æ®æ¥æºæ€»ç»“

### æ‰€æœ‰åŠŸèƒ½çš„æ•°æ®æ¥æºæ±‡æ€»

| åŠŸèƒ½æ¨¡å— | åŠŸèƒ½ç‚¹ | ä¸»è¦æ•°æ®æ¥æº | ç¼“å­˜ç­–ç•¥ | åŒæ­¥æ–¹å¼ | å®æ—¶æ¨é€ |
|---------|-------|------------|---------|---------|---------|
| **Swap é¡µé¢** | æœ€è¿‘äº¤æ˜“åˆ—è¡¨ | Redis â†’ PostgreSQL | Redis 60s | WS ç›‘å¬ + å‰ç«¯è§¦å‘ | SSE æ¨é€ |
| **Swap é¡µé¢** | 24h äº¤æ˜“ç»Ÿè®¡ | PostgreSQL | Redis 180s | å‰ç«¯è§¦å‘ + å®šæ—¶ï¼ˆæ¯å¤©ï¼‰ | ä¸æ¨é€ |
| **Pool é¡µé¢** | Pool åˆ—è¡¨ï¼ˆå«APR/Vol/TVLï¼‰ | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰ | ä¸æ¨é€ |
| **Pool é¡µé¢** | Pool è¯¦æƒ…é¡µ | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆ5åˆ†é’Ÿ/1å°æ—¶/1å¤©ï¼‰ | ä¸æ¨é€ |
| **Pool é¡µé¢** | Pool ä»·æ ¼/äº¤æ˜“é‡/TVL å›¾è¡¨ | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆ1å°æ—¶/1å¤©ï¼‰ | ä¸æ¨é€ |
| **Pool é¡µé¢** | ç”¨æˆ·æµåŠ¨æ€§ä»“ä½ | é“¾ä¸Š + PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰ | ä¸æ¨é€ |
| **Tokens é¡µé¢** | Token åˆ—è¡¨ | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰ | ä¸æ¨é€ |
| **Tokens é¡µé¢** | Token è¯¦æƒ…é¡µï¼ˆå«52å‘¨é«˜ä½ï¼‰ | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆ5åˆ†é’Ÿ/1å°æ—¶/1å¤©ï¼‰ | ä¸æ¨é€ |
| **Tokens é¡µé¢** | Token Kçº¿å›¾ï¼ˆOHLCï¼‰ | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆæ¯å°æ—¶ï¼Œåç«¯è®¡ç®—ï¼‰ | ä¸æ¨é€ |
| **Tokens é¡µé¢** | Token çš„æ‰€æœ‰ Pool | PostgreSQL | ä¸ç¼“å­˜ | å®šæ—¶ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰ | ä¸æ¨é€ |
| **Explore é¡µé¢** | å…¨é“¾äº¤æ˜“æµ | Redis â†’ PostgreSQL | Redis 60s | WS ç›‘å¬ + å‰ç«¯è§¦å‘ | SSE æ¨é€ |
| **Explore é¡µé¢** | å…¨å±€ç»Ÿè®¡æ•°æ® | PostgreSQL | Redis 300s | å®šæ—¶ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰ | ä¸æ¨é€ |

---

### æ•°æ®åº“è¡¨åŒæ­¥ç­–ç•¥æ±‡æ€»

| è¡¨å | åŒæ­¥é¢‘ç‡ | åŒæ­¥æ–¹å¼ | æ•°æ®æ¥æº | è§¦å‘æ¡ä»¶ | è¯´æ˜ |
|-----|---------|---------|---------|---------|------|
| **swaps** | å®æ—¶ + æŒ‰éœ€ | WS ç›‘å¬ï¼ˆRedisï¼‰+ å‰ç«¯è§¦å‘ï¼ˆDBï¼‰ | Subgraph | ç”¨æˆ·æ‰§è¡Œ Swap | - |
| **mints** | å®æ—¶ + æŒ‰éœ€ | WS ç›‘å¬ï¼ˆRedisï¼‰+ å‰ç«¯è§¦å‘ï¼ˆDBï¼‰ | Subgraph | ç”¨æˆ·æ·»åŠ æµåŠ¨æ€§ | - |
| **burns** | å®æ—¶ + æŒ‰éœ€ | WS ç›‘å¬ï¼ˆRedisï¼‰+ å‰ç«¯è§¦å‘ï¼ˆDBï¼‰ | Subgraph | ç”¨æˆ·ç§»é™¤æµåŠ¨æ€§ | - |
| **pairs** | æ¯ 5 åˆ†é’Ÿ | å®šæ—¶åŒæ­¥ | Subgraph | å®šæ—¶ä»»åŠ¡ | åŒ…å« APRã€Vol/TVL è®¡ç®— |
| **tokens** | æ¯ 5 åˆ†é’Ÿ | å®šæ—¶åŒæ­¥ | Subgraph | å®šæ—¶ä»»åŠ¡ | åŒ…å« 52å‘¨é«˜ä½ä»·è®¡ç®— |
| **pair_day_data** | æ¯å¤©å‡Œæ™¨ + æŒ‰éœ€ | å®šæ—¶åŒæ­¥ï¼ˆæ˜¨å¤©ï¼‰+ å‰ç«¯è§¦å‘ï¼ˆä»Šå¤©ï¼‰ | Subgraph | å®šæ—¶ä»»åŠ¡ + ç”¨æˆ·äº¤æ˜“ | ç”¨äºè®¡ç®— 30å¤©äº¤æ˜“é‡ |
| **pair_hour_data** | æ¯å°æ—¶ | å®šæ—¶åŒæ­¥ | Subgraph | å®šæ—¶ä»»åŠ¡ | ç”¨äºä»·æ ¼/äº¤æ˜“é‡å›¾è¡¨ |
| **token_day_data** | æ¯å¤©å‡Œæ™¨ | å®šæ—¶åŒæ­¥ | Subgraph | å®šæ—¶ä»»åŠ¡ | ç”¨äºè®¡ç®— 52å‘¨é«˜ä½ä»· |
| **token_hour_data** | æ¯å°æ—¶ | å®šæ—¶åŒæ­¥ | Subgraph | å®šæ—¶ä»»åŠ¡ | ç”¨äºä»·æ ¼/äº¤æ˜“é‡å›¾è¡¨ |
| **token_ohlc** | æ¯å°æ—¶ | å®šæ—¶åŒæ­¥ + åç«¯è®¡ç®— | Subgraphï¼ˆåŸå§‹æ•°æ®ï¼‰ | å®šæ—¶ä»»åŠ¡ | Kçº¿å›¾æ•°æ®ï¼Œåç«¯è®¡ç®— OHLC |

---

### Redis ç¼“å­˜é”®è®¾è®¡æ±‡æ€»

| ç¼“å­˜é”® | æ•°æ®ç»“æ„ | TTL | ç”¨é€” | å†™å…¥æ—¶æœº | å¤±æ•ˆæ—¶æœº |
|-------|---------|-----|------|---------|---------|
| `recent-swaps:{chainId}:{pairAddress}` | List | 60s | æœ€è¿‘äº¤æ˜“åˆ—è¡¨ | WS ç›‘å¬ + æŸ¥è¯¢å›å¡« | è‡ªç„¶è¿‡æœŸ |
| `pair-stats-24h:{chainId}:{pairAddress}` | Hash | 180s | 24h äº¤æ˜“ç»Ÿè®¡ | æŸ¥è¯¢å›å¡« | è‡ªç„¶è¿‡æœŸ |
| `recent-transactions:{chainId}` | List | 60s | å…¨é“¾äº¤æ˜“æµ | WS ç›‘å¬ + æŸ¥è¯¢å›å¡« | è‡ªç„¶è¿‡æœŸ |
| `global-stats:{chainId}` | Hash | 300s | å…¨å±€ç»Ÿè®¡æ•°æ® | æŸ¥è¯¢å›å¡« + å®šæ—¶åˆ·æ–° | è‡ªç„¶è¿‡æœŸ |

---

### å‰ç«¯è§¦å‘åŒæ­¥æ¥å£æ±‡æ€»

| æ¥å£ | è§¦å‘æ—¶æœº | è¯·æ±‚å‚æ•° | åŒæ­¥è¡¨ | å“åº”æ—¶é—´ |
|-----|---------|---------|-------|---------|
| `POST /api/sync/swap` | ç”¨æˆ·æ‰§è¡Œ Swap å | txHash, chainId, pairAddress | swaps, pair_day_data | < 5s |
| `POST /api/sync/mint` | ç”¨æˆ·æ·»åŠ æµåŠ¨æ€§å | txHash, chainId, pairAddress | mints, pair_day_data | < 5s |
| `POST /api/sync/burn` | ç”¨æˆ·ç§»é™¤æµåŠ¨æ€§å | txHash, chainId, pairAddress | burns, pair_day_data | < 5s |
| `POST /api/sync/transaction` | ç”¨æˆ·æ‰§è¡Œä»»æ„äº¤æ˜“å | txHash, chainId, type | swaps/mints/burns | < 5s |

---

### WS ç›‘å¬äº‹ä»¶æ±‡æ€»

| äº‹ä»¶ | ç›‘å¬åˆçº¦ | å†™å…¥ç›®æ ‡ | æ¨é€æ–¹å¼ | ç”¨é€” |
|-----|---------|---------|---------|------|
| **Swap** | UniswapV2Pair | Redis (recent-swaps, recent-transactions) | SSE | å®æ—¶äº¤æ˜“åˆ—è¡¨ |
| **Mint** | UniswapV2Pair | Redis (recent-transactions) | SSE | å®æ—¶äº¤æ˜“åˆ—è¡¨ |
| **Burn** | UniswapV2Pair | Redis (recent-transactions) | SSE | å®æ—¶äº¤æ˜“åˆ—è¡¨ |
| **Sync** | UniswapV2Pair | ä¸å†™å…¥ï¼ˆä»…ç”¨äºç¼“å­˜å¤±æ•ˆï¼‰ | ä¸æ¨é€ | è§¦å‘ç¼“å­˜å¤±æ•ˆ |

---

### å®šæ—¶åŒæ­¥ä»»åŠ¡æ±‡æ€»

| ä»»åŠ¡åç§° | æ‰§è¡Œé¢‘ç‡ | åŒæ­¥è¡¨ | æ•°æ®æ¥æº | è¯´æ˜ |
|---------|---------|-------|---------|------|
| **Pairs åŒæ­¥** | æ¯ 5 åˆ†é’Ÿ | pairs, tokens | Subgraph | åŒæ­¥æ‰€æœ‰æ´»è·ƒ Pairï¼Œè®¡ç®— APRã€Vol/TVL |
| **Pair Hour Data åŒæ­¥** | æ¯å°æ—¶ | pair_hour_data | Subgraph | åŒæ­¥æœ€è¿‘ 7 å¤©çš„å°æ—¶æ•°æ®ï¼Œç”¨äºå›¾è¡¨ |
| **Pair Day Data åŒæ­¥** | æ¯å¤©å‡Œæ™¨ | pair_day_data | Subgraph | åŒæ­¥æ˜¨å¤©çš„æ—¥æ•°æ®ï¼Œè®¡ç®— 30å¤©äº¤æ˜“é‡ |
| **Token Hour Data åŒæ­¥** | æ¯å°æ—¶ | token_hour_data | Subgraph | åŒæ­¥æœ€è¿‘ 7 å¤©çš„å°æ—¶æ•°æ®ï¼Œç”¨äºå›¾è¡¨ |
| **Token Day Data åŒæ­¥** | æ¯å¤©å‡Œæ™¨ | token_day_data | Subgraph | åŒæ­¥æ˜¨å¤©çš„æ—¥æ•°æ®ï¼Œè®¡ç®— 52å‘¨é«˜ä½ä»· |
| **Token OHLC è®¡ç®—** | æ¯å°æ—¶ | token_ohlc | Subgraphï¼ˆåŸå§‹æ•°æ®ï¼‰ | ä» token_hour_data è®¡ç®— OHLC Kçº¿æ•°æ® |
| **Global Stats åˆ·æ–°** | æ¯ 5 åˆ†é’Ÿ | - | PostgreSQL èšåˆ | åˆ·æ–°å…¨å±€ç»Ÿè®¡ç¼“å­˜ |

---

### æ ¸å¿ƒå‡†åˆ™æ€»ç»“

#### æŸ¥è¯¢å‡†åˆ™

1. **æŸ¥è¯¢ä¼˜å…ˆçº§**ï¼šRedisï¼ˆç¼“å­˜ï¼‰â†’ GraphQLï¼ˆä¸»è¦æŸ¥è¯¢ï¼‰â†’ RESTï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰
2. **ç¼“å­˜ç­–ç•¥**ï¼š
   - çƒ­ç‚¹æ•°æ®ï¼ˆæœ€è¿‘äº¤æ˜“ï¼‰ï¼šRedis 60s
   - ç»Ÿè®¡æ•°æ®ï¼ˆ24h ç»Ÿè®¡ï¼‰ï¼šRedis 180s
   - å…¨å±€æ•°æ®ï¼ˆå…¨å±€ç»Ÿè®¡ï¼‰ï¼šRedis 300s
   - åˆ—è¡¨æ•°æ®ï¼ˆPool/Token åˆ—è¡¨ï¼‰ï¼šä¸ç¼“å­˜ï¼ˆç›´æ¥æŸ¥ DBï¼‰
3. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ GraphQL å…³è”æŸ¥è¯¢ï¼Œé¿å… N+1 é—®é¢˜
   - ä½¿ç”¨åˆ†é¡µæ¸¸æ ‡ï¼Œæ”¯æŒæ— é™æ»šåŠ¨
   - ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æ’åºå’Œè¿‡æ»¤

#### åŒæ­¥å‡†åˆ™

1. **WS ç›‘å¬ç­–ç•¥**ï¼šåªå†™ Redisï¼Œä¸å†™æ•°æ®åº“ï¼ˆä¿è¯å®æ—¶æ€§ï¼Œé™ä½æ•°æ®åº“å‹åŠ›ï¼‰
2. **æ•°æ®åº“å†™å…¥**ï¼šç”±å‰ç«¯è§¦å‘åŒæ­¥æˆ–å®šæ—¶ä»»åŠ¡å®Œæˆï¼ˆä¿è¯æ•°æ®å®Œæ•´æ€§ï¼‰
3. **ç¼“å­˜æ›´æ–°**ï¼š
   - å®šæ—¶ä»»åŠ¡æˆ–å‰ç«¯è§¦å‘åŒæ­¥åªå†™æ•°æ®åº“ï¼Œä¸å†™ Redis
   - GraphQL æŸ¥è¯¢æ—¶ä» Redis æ‰¾ä¸åˆ°ï¼ŒæŸ¥è¯¢æ•°æ®åº“åé‡æ–°æ›´æ–° Redis
   - å‰ç«¯è§¦å‘åŒæ­¥åä¸åˆ é™¤ Redis ç¼“å­˜ï¼ˆä¿æŒ WS å†™å…¥çš„å®æ—¶æ•°æ®ï¼Œç­‰å¾…è‡ªç„¶è¿‡æœŸï¼‰
4. **åŒæ­¥é¢‘ç‡**ï¼š
   - å®æ—¶æ•°æ®ï¼ˆäº¤æ˜“è®°å½•ï¼‰ï¼šWS ç›‘å¬ + å‰ç«¯è§¦å‘
   - åˆ†é’Ÿçº§æ•°æ®ï¼ˆPair/Token ä¿¡æ¯ï¼‰ï¼šæ¯ 5 åˆ†é’Ÿ
   - å°æ—¶çº§æ•°æ®ï¼ˆå›¾è¡¨æ•°æ®ï¼‰ï¼šæ¯å°æ—¶
   - å¤©çº§æ•°æ®ï¼ˆå†å²ç»Ÿè®¡ï¼‰ï¼šæ¯å¤©å‡Œæ™¨
5. **è®¡ç®—å­—æ®µç­–ç•¥**ï¼š
   - APRï¼ˆå¹´åŒ–æ”¶ç›Šç‡ï¼‰ï¼šåç«¯è®¡ç®—ï¼Œå…¬å¼ `(24häº¤æ˜“é‡ Ã— 0.003 Ã— 365) / TVL`
   - Vol/TVL æ¯”ç‡ï¼šåç«¯è®¡ç®—ï¼Œå…¬å¼ `24häº¤æ˜“é‡ / TVL`
   - 30å¤©äº¤æ˜“é‡ï¼šåç«¯èšåˆï¼Œä» `pair_day_data` è¡¨ SUM æœ€è¿‘ 30 å¤©
   - 52å‘¨é«˜ä½ä»·ï¼šåç«¯èšåˆï¼Œä» `token_day_data` è¡¨ MAX/MIN æœ€è¿‘ 365 å¤©
   - Token ä»·æ ¼ï¼šåç«¯è®¡ç®—ï¼Œå…¬å¼ `derivedETH Ã— ethPrice`
   - Pool ä»·æ ¼ï¼šåç«¯è®¡ç®—ï¼Œå…¬å¼ `token0Price = reserve1 / reserve0`
6. **Kçº¿æ•°æ®ï¼ˆOHLCï¼‰ç­–ç•¥**ï¼š
   - âš ï¸ V2 æ ‡å‡† Subgraph æ²¡æœ‰ OHLC å­—æ®µ
   - âœ… åç«¯ä» `token_hour_data` çš„ `priceUSD` è®¡ç®— OHLC
   - âœ… æ¯å°æ—¶èšåˆä¸€æ¬¡ï¼Œå­˜å‚¨åˆ° `token_ohlc` è¡¨
   - âœ… æ”¯æŒå¤šç§æ—¶é—´èŒƒå›´ï¼ˆHOUR, DAY, WEEK, MONTH, YEARï¼‰

#### å®æ—¶æ¨é€å‡†åˆ™

1. **éœ€è¦æ¨é€çš„åœºæ™¯**ï¼š
   - æœ€è¿‘äº¤æ˜“åˆ—è¡¨ï¼ˆSwap é¡µé¢ï¼‰ï¼šç”¨æˆ·éœ€è¦å®æ—¶çœ‹åˆ°å…¶ä»–äººçš„äº¤æ˜“
   - å…¨é“¾äº¤æ˜“æµï¼ˆExplore é¡µé¢ï¼‰ï¼šç”¨æˆ·éœ€è¦å®æ—¶çœ‹åˆ°å…¨å±€äº¤æ˜“æ´»åŠ¨
2. **ä¸éœ€è¦æ¨é€çš„åœºæ™¯**ï¼š
   - ç»Ÿè®¡æ•°æ®ï¼ˆ24h äº¤æ˜“é‡ã€TVL ç­‰ï¼‰ï¼šç”¨æˆ·å¯ä»¥æ¥å—åˆ†é’Ÿçº§å»¶è¿Ÿ
   - åˆ—è¡¨æ•°æ®ï¼ˆPool/Token åˆ—è¡¨ï¼‰ï¼šç”¨æˆ·å¯ä»¥æ¥å—åˆ†é’Ÿçº§å»¶è¿Ÿ
   - å›¾è¡¨æ•°æ®ï¼ˆä»·æ ¼/äº¤æ˜“é‡å†å²ï¼‰ï¼šç”¨æˆ·å¯ä»¥æ¥å—åˆ†é’Ÿçº§å»¶è¿Ÿ
3. **æ¨é€æ–¹å¼**ï¼šSSEï¼ˆServer-Sent Eventsï¼‰æ¨èï¼ŒWebSocket å¯é€‰ï¼ŒçŸ­è½®è¯¢å¤‡é€‰

---

**æ–‡æ¡£å®Œæˆ**

> **çŠ¶æ€**ï¼šå·²å®Œæˆ Swapã€Poolã€Tokensã€Explore å››ä¸ªæ¨¡å—çš„æŸ¥è¯¢ä¸åŒæ­¥ç­–ç•¥è®¾è®¡  
> **ä¸‹ä¸€æ­¥**ï¼šæ ¹æ®æ­¤æ–‡æ¡£è¿›è¡Œåç«¯å¼€å‘å’Œå‰ç«¯å¯¹æ¥
