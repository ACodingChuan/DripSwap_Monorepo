# 4.8 ç»Ÿä¸€è¯»æ•°æ®æœåŠ¡ (Read from ETL)

**ç‰ˆæœ¬**ï¼šv1.1  
**çŠ¶æ€**ï¼šè®¾è®¡ä¸­  
**æœ€åæ›´æ–°**ï¼š2025-11-28  
**è´Ÿè´£äºº**ï¼šåç«¯å›¢é˜Ÿ

---

## 1. èƒŒæ™¯ä¸åŠ¨æœº

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Ÿ

ä¸ºäº†è®©å‰ç«¯ï¼ˆDEX, Bridge, Portfolioï¼‰èƒ½è½»é‡çº§ã€å¿«é€Ÿåœ°è¿ä½œï¼Œæ‰€æœ‰**å¤æ‚çš„å†å²æ•°æ®æŸ¥è¯¢ã€èšåˆç»Ÿè®¡ã€å›¾è¡¨æ•°æ®**éƒ½å‰¥ç¦»è‡³ç»Ÿä¸€çš„ ETL æœåŠ¡å±‚ã€‚å‰ç«¯åªè´Ÿè´£å†™ï¼ˆé“¾ä¸Šäº¤äº’ï¼‰å’ŒæŸ¥ï¼ˆå®æ—¶çŠ¶æ€ï¼‰ï¼Œåç«¯è´Ÿè´£è¯»ï¼ˆå†å²ç´¢å¼•ï¼‰ã€‚

### è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1. **è§£è€¦**ï¼šå‰ç«¯æ— éœ€å¤„ç†å¤æ‚çš„äº‹ä»¶è§£æå’ŒçŠ¶æ€ç´¯ç§¯ã€‚
2. **æ€§èƒ½**ï¼šé€šè¿‡ SQL/ClickHouse æŸ¥è¯¢æ›¿ä»£é“¾ä¸Š `eth_getLogs`ï¼Œå®ç°æ¯«ç§’çº§å“åº”ã€‚
3. **ç»Ÿä¸€**ï¼šæ‰€æœ‰æ¨¡å—ï¼ˆSwap, Liquidity, Bridgeï¼‰å…±ç”¨ä¸€å¥—æ•°æ®æµå’Œ API è§„èŒƒã€‚

---

## 2. ç›®æ ‡ä¸èŒƒå›´

### åŠŸèƒ½ç›®æ ‡
- æä¾›æ‰€æœ‰æ¨¡å—çš„å†å²äº¤æ˜“è®°å½•æŸ¥è¯¢ API
- æä¾›ç”¨æˆ·èµ„äº§ç»„åˆï¼ˆPortfolioï¼‰èšåˆæŸ¥è¯¢
- æä¾›å…¨å±€ç»Ÿè®¡æ•°æ®ï¼ˆTVL, Volumeï¼‰

### èŒƒå›´
- **åŒ…å«**ï¼š
  - é“¾ä¸Šäº‹ä»¶ç›‘å¬ (Ingestion)
  - æ•°æ®æ¸…æ´—ä¸æ ‡å‡†åŒ– (Transformation)
  - æŒä¹…åŒ–å­˜å‚¨ (Postgres/ClickHouse)
  - GraphQL æŸ¥è¯¢æ¥å£ (BFF)
- **ä¸åŒ…å«**ï¼š
  - é“¾ä¸Šå†™æ“ä½œï¼ˆäº¤æ˜“æ‰§è¡Œï¼‰
  - å®æ—¶ä»·æ ¼é¢„è¨€æœºï¼ˆè¿™æ˜¯å‰ç«¯ç›´æ¥è°ƒç”¨çš„ï¼‰

---

## 3. éœ€æ±‚å®šä¹‰ (User Stories)

### Story 1ï¼šæŸ¥çœ‹å†å²äº¤æ˜“è®°å½• (Swap History)

**è§’è‰²**ï¼šDripSwap ç”¨æˆ·  
**ç›®æ ‡**ï¼šæˆ‘æƒ³åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­æŸ¥çœ‹æˆ‘æ‰€æœ‰çš„ Swap å†å²è®°å½•ï¼ŒåŒ…æ‹¬çŠ¶æ€ã€æ—¶é—´ã€é‡‘é¢ã€‚

**å‰ç«¯äº¤äº’æµç¨‹**ï¼ˆWhen-Case-Doï¼‰ï¼š

**WHEN** æˆ‘è¿›å…¥ "Activity" æˆ– "Wallet" é¡µé¢
- **å‰ç«¯å±•ç¤º**ï¼š
  - ç»„ä»¶ï¼š`SwapHistoryTable`
  - åˆå§‹çŠ¶æ€ï¼šåŠ è½½éª¨æ¶å±

**CASE** é¡µé¢åŠ è½½
- **æ•°æ®è¯·æ±‚**ï¼šGraphQL `mySwaps(address, page: 1)`
- **åç«¯å¤„ç†**ï¼š
  - æŸ¥è¯¢ `swap_tx` è¡¨ï¼ŒæŒ‰ `block_timestamp` å€’åºã€‚
  - å…³è” Token ä¿¡æ¯ï¼ˆSymbol, Decimalsï¼‰ã€‚

**DO** ç³»ç»Ÿåº”è¯¥
- **æˆåŠŸåœºæ™¯**ï¼šè¿”å›åˆ†é¡µçš„ Swap è®°å½•åˆ—è¡¨ã€‚
  - Item: `ETH -> USDT`, `1.0 -> 3000.0`, `Success`, `2 mins ago`
- **å¤±è´¥åœºæ™¯**ï¼šè¿”å›ç©ºåˆ—è¡¨æˆ–é”™è¯¯æç¤ºã€‚

### Story 2ï¼šæŸ¥çœ‹æµåŠ¨æ€§å˜åŠ¨å†å² (Liquidity History)

**è§’è‰²**ï¼šLiquidity Provider  
**ç›®æ ‡**ï¼šæˆ‘æƒ³æŸ¥çœ‹æˆ‘æ·»åŠ /ç§»é™¤æµåŠ¨æ€§çš„å†å²è®°å½•ã€‚

**å‰ç«¯äº¤äº’æµç¨‹**ï¼š
- **WHEN** è¿›å…¥ Pool è¯¦æƒ…é¡µ
- **æ•°æ®è¯·æ±‚**ï¼šGraphQL `myLiquidityActions(address, poolAddress)`
- **åç«¯å¤„ç†**ï¼šæŸ¥è¯¢ `liquidity_tx` è¡¨ï¼ˆMint/Burn äº‹ä»¶ï¼‰ã€‚

### Story 3ï¼šèµ„äº§æ¦‚è§ˆ (Portfolio)

**è§’è‰²**ï¼šDripSwap ç”¨æˆ·  
**ç›®æ ‡**ï¼šæˆ‘æƒ³æŸ¥çœ‹æˆ‘åœ¨ DripSwap åè®®ä¸­çš„æ€»èµ„äº§å‡€å€¼ï¼ˆWallet + Liquidityï¼‰ã€‚

**å‰ç«¯äº¤äº’æµç¨‹**ï¼š
- **WHEN** è¿›å…¥ Portfolio é¡µé¢
- **æ•°æ®è¯·æ±‚**ï¼šGraphQL `myPortfolio(address)`
- **åç«¯å¤„ç†**ï¼š
  - èšåˆ Swap å†å²è®¡ç®—æŒä»“ï¼ˆå¯é€‰ï¼Œæˆ–ç›´æ¥è¯»é“¾ä¸Šä½™é¢ï¼‰ã€‚
  - è®¡ç®— LP Token ä»·å€¼ã€‚
  - è¿”å›æ€» USD ä»·å€¼ã€‚

### Story 4ï¼šæŸ¥çœ‹è·¨é“¾å†å² (Bridge History)

**è§’è‰²**ï¼šDripSwap ç”¨æˆ·  
**ç›®æ ‡**ï¼šæˆ‘æƒ³æŸ¥çœ‹æˆ‘æ‰€æœ‰çš„è·¨é“¾äº¤æ˜“è®°å½•åŠå…¶æœ€ç»ˆçŠ¶æ€ã€‚

**å‰ç«¯äº¤äº’æµç¨‹**ï¼š
- **WHEN** è¿›å…¥ Bridge å†å²é¡µé¢
- **æ•°æ®è¯·æ±‚**ï¼šGraphQL `myBridges(address)`
- **åç«¯å¤„ç†**ï¼š
  - æŸ¥è¯¢ `bridge_tx` è¡¨ã€‚
  - å…³è”æºé“¾å’Œç›®æ ‡é“¾çš„äº‹ä»¶çŠ¶æ€ï¼ˆSubmitted, Relayed, Completedï¼‰ã€‚
  - è¿”å›è·¨é“¾è¿›åº¦ã€‚

---

## 4. æŠ€æœ¯æ–¹æ¡ˆ

### 4.0 Subgraph æ•°æ®åŒæ­¥æ¶æ„ï¼ˆé‡æ„ç‰ˆï¼‰

#### 4.0.1 è®¾è®¡ç›®æ ‡
- **æœ€å°å¿…è¦äº‹ä»¶**ï¼šåªåŒæ­¥å¯¹ä¸šåŠ¡æœ‰ç”¨çš„äº‹ä»¶ï¼Œé¿å…å™ªå£°ã€‚
- **å®ä½“å½’ä¸€**ï¼šæŒ‰â€œåŸŸâ€ç»„ç»‡ï¼šDEXï¼ˆUniswapï¼‰ã€Bridgeã€VTokenã€Oracleã€å®¡è®¡ç±»ã€‚
- **å¯è¿½æº¯æ€§**ï¼šäº‹ä»¶å®ä½“ ID = `txHash-logIndex`ï¼Œåœ°å€ç»Ÿä¸€å°å†™ï¼Œä¿ç•™ `blockNumber/timestamp/transactionHash` ä¾¿äºå¯¹è´¦ã€‚
- **è·¨é“¾å…³è”çš„çœŸå®æ€§**ï¼šåªæœ‰ Bridge.TransferInitiated æ‹¿åˆ° CCIP `messageId`ï¼›Pool äº‹ä»¶ä¸å¼ºè¡Œç»‘å®š messageIdï¼Œå¿…è¦æ—¶åœ¨ ETL å±‚ç”¨â€œæ¨æ–­å…³è”â€å¹¶æ˜¾å¼æ ‡è®°ã€‚

#### 4.0.2 äº‹ä»¶é€‰æ‹©ï¼ˆä¿ç•™/å¿½ç•¥ï¼‰
- **ä¿ç•™**
  - Bridgeï¼š`TransferInitiated`, `TokenPoolRegistered/Removed`, `LimitsUpdated`, `PayMethodUpdated`, `ServiceFeeUpdated`, `Paused/Unpaused`.
  - BurnMintTokenPoolï¼š`LockedOrBurned`, `ReleasedOrMinted`, `ChainAdded/Configured/Removed`, `RemotePoolAdded/Removed`, `AllowListAdd/Remove`, `RouterUpdated`, `OwnershipTransferRequested/Transferred`, `ConfigChanged`, `RateLimitAdminSet`, `Outbound/InboundRateLimitConsumed`.
  - VTokenï¼š`Transfer`, `Minted`, `Burned`, `Initialized`, `Paused/Unpaused`, `OwnershipTransferred`, `EIP712DomainChanged`.
  - Uniswapï¼š`PairCreated`(Factory), `Swap/Mint/Burn/Sync`(Pair)ã€‚
  - Oracleï¼š`USDFeedUpdated`ã€‚
- **å¯å¿½ç•¥**ï¼šApprovalã€RoleGranted/Revoked/AdminChanged ç­‰é»˜è®¤ä¸å…¥ä¸šåŠ¡è¡¨ï¼›å¦‚éœ€å®¡è®¡å¯å†™å…¥é€šç”¨ `ConfigEvent/RoleEvent`ã€‚

#### 4.0.3 å®ä½“è®¾è®¡ï¼ˆGraphQL Schema å¯¼å‘ï¼‰
- **DEX**
  - `Pair`, `Swap`, `LiquidityAction`(Mint/Burn èšåˆ), `TokenMeta`ï¼ˆUniswap è§†è§’ tokenï¼‰ã€‚
- **VToken**
  - `VTokenState`ï¼ˆid=token addrï¼Œå°å†™ï¼›symbol/name/decimals/totalSupply/totalMinted/totalBurnedï¼‰ã€‚
  - `VTokenTransfer` / `VTokenMint` / `VTokenBurn`ï¼ˆäº‹ä»¶å®ä½“ï¼Œid=txHash-logIndexï¼‰ã€‚
- **Bridge**
  - `BridgeSend`ï¼ˆæ¥æº=Bridge.TransferInitiatedï¼Œå« `messageId/ccipFee/serviceFeePaid/pool/payInLink/status`ï¼‰ã€‚
  - `BridgePoolLeg`ï¼ˆæ¥æº=Pool LockedOrBurned/ReleasedOrMintedï¼›å­—æ®µï¼špool/token/remoteChainSelector/amount/sender/recipient/legType/txHash/logIndexï¼‰ã€‚
  - `BridgeConfigEvent`ï¼ˆBridge é…ç½®ï¼‰ã€‚
  - `PoolConfigEvent`ï¼ˆPool é…ç½®/é™æµ/allowlist/router/ownership/RateLimit æ¶ˆè€—ï¼‰ã€‚
- **Oracle**
  - `OracleFeedUpdate`ï¼ˆtoken/aggregator/aggDecimals/fixedUsdE18ï¼‰ã€‚
- **å®¡è®¡ï¼ˆå¯é€‰ï¼‰**
  - `ConfigEvent` ç”¨äºè½»é‡å®¡è®¡ï¼ˆå¦‚ VToken åˆå§‹åŒ–/æš‚åœï¼‰ï¼Œ`RoleEvent` ä»…åœ¨éœ€è¦æ—¶å¯ç”¨ã€‚

> æŸ¥è¯¢æŒ‡å¼•ï¼š  
> - éœ€è¦ vSCR ç­‰è‡ªå®šä¹‰ token çŠ¶æ€ â†’ æŸ¥ `VTokenState`ã€‚  
> - éœ€è¦å‚ä¸æ± çš„ token åˆ—è¡¨ â†’ æŸ¥ `TokenMeta`ï¼ˆUniswap è§†è§’ï¼Œæœªå…¥æ± çš„ä¸å‡ºç°ï¼‰ã€‚  
> - è·¨é“¾å‘é€ â†’ æŸ¥ `BridgeSend`ï¼›Pool è½åœ°è…¿ â†’ æŸ¥ `BridgePoolLeg`ã€‚

#### 4.0.4 å…³è”ç­–ç•¥ï¼ˆmessageId / txHashï¼‰
- **æƒå¨å…³è”**ï¼š`BridgeSend.messageId` æ˜¯å”¯ä¸€è·¨é“¾ IDã€‚  
- **Pool äº‹ä»¶**ï¼šæ—  messageIdï¼Œä¿æŒç‹¬ç«‹è®°å½• `BridgePoolLeg`ï¼Œå¸¦ `txHash/logIndex/blockNumber/timestamp`ã€‚  
- **æ¨æ–­å…³è”ï¼ˆå¦‚éœ€ï¼‰**ï¼šä»…åœ¨ ETL/BFF å±‚å¯é€‰ï¼Œç”¨åŒä¸€ `txHash` ä¸” pool=tokenPools[token] ä½œä¸º Heuristicï¼Œå¹¶æ–°å¢å­—æ®µ `correlationType: Exact|Heuristic|None`ï¼Œé»˜è®¤ Noneï¼›Subgraph ä¸å¼ºè¡Œå†™æ­»ã€‚  
- **Null è¯´æ˜**ï¼šPool é”å®šè…¿ `receiver` ä¸ºç©ºå±æ­£å¸¸ï¼›`payInLink/ccipFee` ä»… Bridge äº‹ä»¶æœ‰ï¼ŒPool äº‹ä»¶ä¸º null ä¸ä»£è¡¨åŒæ­¥å¼‚å¸¸ã€‚

#### 4.0.5 æ•°æ®åŒæ­¥ä¸æ¨¡å‹è½åœ°
- **åœ°å€ä¸ startBlock**ï¼šå‡æ¥è‡ª `apps/contracts/deployments/{chain}/address_book.md`ï¼Œç»Ÿä¸€å°å†™ã€‚  
- **ID è§„èŒƒ**ï¼šäº‹ä»¶å®ä½“ id=`txHash-logIndex`ï¼›çŠ¶æ€å®ä½“ id=åˆçº¦åœ°å€ï¼ˆå°å†™ï¼‰ã€‚  
- **ä»£ç ç”Ÿæˆ/éƒ¨ç½²**ï¼š`pnpm --dir apps/subgraph/sepolia codegen` â†’ `build` â†’ `graph deploy --studio sepolia`ã€‚  
- **å¤šé“¾æ‰©å±•**ï¼šæ¯é“¾ä¸€ç»„ dataSourceï¼Œç‹¬ç«‹ startBlockï¼›è‹¥æ–°å¢ç½‘ç»œï¼Œå¤åˆ¶åŒæ„é…ç½®å¹¶æ›´æ–°åœ°å€ç°¿ã€‚

#### 4.0.6 æŸ¥è¯¢ä¸éªŒè¯
- **åŒæ­¥è¿›åº¦**ï¼š`_meta { block { number timestamp } }` å¯¹æ¯”ç›®æ ‡åŒºå—ã€‚  
- **æŒ‰åŸŸæŸ¥è¯¢**ï¼š  
  - VTokenï¼š`vtokens { id symbol totalSupply }`ï¼ˆvSCR ç­‰ä¸åœ¨æ± ä¹Ÿèƒ½æŸ¥åˆ°ï¼‰ã€‚  
  - Uniswap Token åˆ—è¡¨ï¼š`tokens { id symbol decimals }`ï¼ˆä»…å‚ä¸ Pair çš„ tokenï¼‰ã€‚  
  - Bridge å‘é€ï¼š`bridgeSends { messageId sender receiver token amount pool payInLink ccipFee serviceFeePaid }`ï¼ˆstatus=Initiatedï¼‰ã€‚  
  - Pool è…¿äº‹ä»¶ï¼š`bridgePoolLegs { txHash pool token remoteChainSelector legType amount }`ã€‚  
  - Oracleï¼š`oracleFeedUpdates { token aggregator aggDecimals fixedUsdE18 }`ã€‚  
- **æ ¡éªŒè¦ç‚¹**ï¼šåœ°å€å°å†™ï¼›è‹¥è®°å½•ç¼ºå¤±ï¼Œå…ˆæŸ¥äº‹ä»¶æ˜¯å¦çœŸå®å‘ç”Ÿ/æ˜¯å¦åœ¨ startBlock ä¹‹åï¼›å­—æ®µä¸ºç©ºå…ˆç¡®è®¤è¯¥äº‹ä»¶æ˜¯å¦æœ¬å°±ä¸åŒ…å«è¯¥å­—æ®µã€‚

#### 4.0.7 æ¶æ„æ€»è§ˆï¼ˆæ›´æ–°ï¼‰
```
é“¾ä¸Šåˆçº¦ â†’ Subgraphï¼ˆæŒ‰åŸŸæ‹†åˆ†æ•°æ®æºï¼‰
  DEX: Factory/Pair â†’ Pair/Swap/LiquidityAction/TokenMeta
  VToken: VToken åˆçº¦ â†’ VTokenState + äº‹ä»¶å®ä½“
  Bridge: Bridge â†’ BridgeSendï¼›BurnMintPool â†’ BridgePoolLeg + PoolConfigEvent
  Oracle: ChainlinkOracle â†’ OracleFeedUpdate
  å®¡è®¡: ConfigEvent/RoleEventï¼ˆå¯é€‰ï¼‰

Subgraph GraphQL API â†’ SubgraphSyncServiceï¼ˆBFF ETLï¼Œå‘¨æœŸæ‹‰å–ï¼Œæ¸¸æ ‡/æ‰¹é‡/é‡è¯•ï¼‰
  â†’ Transformerï¼ˆå•ä½è½¬æ¢ã€éªŒè¯ã€å°å†™åŒ–ï¼‰â†’ Postgres (Upsert)
  â†’ Cache Invalidationï¼ˆRedisï¼‰

WS Listenerï¼ˆå®æ—¶å…œåº•ï¼‰â†’ raw_events / cache å¤±æ•ˆ
å‰ç«¯/BFF Query â†’ ç»Ÿä¸€è¯» Postgres/Redis
```

---

### 4.1 æ¶æ„è®¾è®¡ (Pipeline)

```mermaid
graph TD
    Subgraph["ğŸ”— The Graph Subgraph API<br/>(ç»“æ„åŒ–ç´¢å¼•)"] -->|GraphQL HTTP<br/>åˆ†é¡µæŸ¥è¯¢| SubgraphSync["âš™ï¸ SubgraphSyncService<br/>(å‘¨æœŸ: 1-5åˆ†é’Ÿ)"]
    
    BlockChain["â›“ï¸ åŒºå—é“¾<br/>(RPC WebSocket)"] -->|å®æ—¶äº‹ä»¶æµ| WSListener["ğŸ“¡ ChainEventListener<br/>(WsConnectionManager)"]
    
    SubgraphSync -->|æ‰¹é‡æ•°æ®| Transformer["ğŸ”„ Transformer<br/>(å•ä½è½¬æ¢ã€å»é‡ã€éªŒè¯)"]
    WSListener -->|Raw Log| EventDecoder["ğŸ“‹ EventDecoder<br/>(ABI è§£æ)"] 
    
    Transformer -->|æ¸…æ´—æ•°æ®| PgInsert["ğŸ’¾ PostgreSQL<br/>(Upsert)"] 
    EventDecoder -->|Entity| PgInsert
    
    PgInsert -->|æ›´æ–°æ¸¸æ ‡| Cursor[("ğŸ“ sync_cursor<br/>(æ–­ç‚¹ç»­ä¼ )")]
    
    PgInsert & EventDecoder -->|è§¦å‘å¤±æ•ˆ| CacheInvalidate["ğŸš« Cache Invalidation<br/>(Redis DEL)"]
    
    Frontend["ğŸ–¥ï¸ å‰ç«¯"] -->|GraphQL Query| GQLResolver["ğŸ” QueryResolver<br/>(BFF)"] 
    GQLResolver -->|SELECT| PgRead[("ğŸ“– PostgreSQL<br/>(è¯»æƒå¨æ•°æ®)")]
    
    CacheInvalidate -->|ç¼“å­˜é¢„çƒ­| RedisCache[("âš¡ Redis<br/>(çƒ­æ•°æ®ç¼“å­˜)")]
    GQLResolver -->|ç¼“å­˜æŸ¥è¯¢| RedisCache
```

---

### 4.2 æ•°æ®åº“æ¨¡å‹ï¼ˆå½“å‰å®ç°ï¼‰

> **æ›´æ–°æ—¥æœŸ**: 2025-12-03  
> **å®ç°çŠ¶æ€**: âœ… å·²å®ç°å¹¶éƒ¨ç½²  
> **Liquibase ç‰ˆæœ¬**: 001-init.xml, 003-subgraph-sync.xml

#### 4.2.0 åŒæ­¥æ¸¸æ ‡è¡¨ (`sync_cursor`) - æ ¸å¿ƒæ–­ç‚¹ç»­ä¼ æœºåˆ¶

**ç”¨é€”**: ä¸ºæ¯ä¸ªé“¾+æ•°æ®ç±»å‹ç»´æŠ¤åŒæ­¥è¿›åº¦,æ”¯æŒåŸºäºblockã€timestampã€idä¸‰ç§æ¸¸æ ‡æ¨¡å¼

```sql
CREATE TABLE sync_cursor (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64) NOT NULL,              -- é“¾æ ‡è¯† (å¦‚ 'sepolia', 'scroll-sepolia')
    data_type VARCHAR(64) NOT NULL,             -- æ•°æ®ç±»å‹ ('pair', 'token', 'vtoken', 'bridge_transfer')
    last_sync_block_number BIGINT DEFAULT 0,    -- æœ€ååŒæ­¥çš„åŒºå—å· (ç”¨äºæŒ‰blockåˆ†é¡µ)
    last_sync_timestamp BIGINT DEFAULT 0,       -- æœ€ååŒæ­¥çš„æ—¶é—´æˆ³ (ç”¨äºæŒ‰æ—¶é—´åˆ†é¡µ)
    last_synced_id VARCHAR(256),                -- æœ€ååŒæ­¥çš„ID (ç”¨äºæŒ‰IDåˆ†é¡µ)
    last_error_message TEXT,                    -- æœ€åé”™è¯¯ä¿¡æ¯
    error_count INT DEFAULT 0,                  -- è¿ç»­é”™è¯¯æ¬¡æ•°
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_sync_cursor_chain_type UNIQUE(chain_id, data_type)
);
```

**ç´¢å¼•ç­–ç•¥**:
- å”¯ä¸€çº¦æŸ `(chain_id, data_type)` ç¡®ä¿æ¯ä¸ªæ•°æ®æºåªæœ‰ä¸€ä¸ªæ¸¸æ ‡è®°å½•

**æ¸¸æ ‡æ¨¡å¼è¯´æ˜**:
1. **Timestampæ¸¸æ ‡** (ç”¨äºPairs): æŒ‰ `createdAtTimestamp` å¢é‡åŒæ­¥,è®°å½• `last_sync_timestamp`
2. **IDæ¸¸æ ‡** (ç”¨äºTokens/VTokens): æŒ‰å­—æ¯åºåˆ†é¡µ,è®°å½• `last_synced_id`
3. **Blockæ¸¸æ ‡** (ç”¨äºBridge): æŒ‰ `blockNumber` åˆ†é¡µ,è®°å½• `last_sync_block_number`

#### 4.2.1 Pair ç¼“å­˜è¡¨ (`pair_cache`) - Uniswapäº¤æ˜“å¯¹å¿«ç…§

**ç”¨é€”**: ç¼“å­˜æ‰€æœ‰Uniswap V2äº¤æ˜“å¯¹çš„å®æ—¶çŠ¶æ€(å‚¨å¤‡é‡ã€äº¤æ˜“é‡)

```sql
CREATE TABLE pair_cache (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- é“¾æ ‡è¯†
    address VARCHAR(66) NOT NULL,               -- Pairåˆçº¦åœ°å€ (å°å†™)
    token0_address VARCHAR(66),                 -- Token0åœ°å€ (å°å†™)
    token1_address VARCHAR(66),                 -- Token1åœ°å€ (å°å†™)
    reserve0 NUMERIC(78,0),                     -- Token0å‚¨å¤‡é‡ (Wei)
    reserve1 NUMERIC(78,0),                     -- Token1å‚¨å¤‡é‡ (Wei)
    liquidity NUMERIC(78,0),                    -- æµåŠ¨æ€§ä»£å¸æ€»é‡
    volume_token0 NUMERIC(78,0),                -- Token0ç´¯è®¡äº¤æ˜“é‡
    volume_token1 NUMERIC(78,0),                -- Token1ç´¯è®¡äº¤æ˜“é‡
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_pair_cache_chain_address ON pair_cache(chain_id, address);
CREATE INDEX idx_pair_cache_token0 ON pair_cache(token0_address);
CREATE INDEX idx_pair_cache_token1 ON pair_cache(token1_address);
```

**æ•°æ®æ¥æº**: Subgraph `pairs` æŸ¥è¯¢  
**æ›´æ–°ç­–ç•¥**: Upsert (æŒ‰ `chain_id + address`)

#### 4.2.2 Token å…ƒæ•°æ®è¡¨ (`token_meta`) - ERC20åŸºç¡€ä¿¡æ¯

**ç”¨é€”**: å­˜å‚¨å‚ä¸Uniswapæ± çš„æ‰€æœ‰TokenåŸºæœ¬ä¿¡æ¯

```sql
CREATE TABLE token_meta (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- é“¾æ ‡è¯†
    address VARCHAR(66) NOT NULL,               -- Tokenåˆçº¦åœ°å€ (å°å†™)
    symbol VARCHAR(64),                         -- ä»£å¸ç¬¦å· (å¦‚ 'USDT')
    name VARCHAR(128),                          -- ä»£å¸å…¨ç§°
    decimals INT,                               -- å°æ•°ä½æ•°
    total_supply NUMERIC(78,0),                 -- æ€»ä¾›åº”é‡
    synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_token_meta_chain_address ON token_meta(chain_id, address);
CREATE INDEX idx_token_meta_symbol ON token_meta(symbol);
```

**æ•°æ®æ¥æº**: Subgraph `tokens` æŸ¥è¯¢  
**æ›´æ–°ç­–ç•¥**: Upsert (æŒ‰ `chain_id + address`)  
**æ³¨æ„**: ä»…åŒ…å«å‚ä¸Uniswap Poolçš„Token,æœªå…¥æ± çš„Tokenä¸ä¼šå‡ºç°

#### 4.2.3 VToken çŠ¶æ€è¡¨ (`vtoken_state`) - è™šæ‹Ÿä»£å¸å…¨å±€çŠ¶æ€

**ç”¨é€”**: å­˜å‚¨DripSwapè‡ªå®šä¹‰vTokençš„çŠ¶æ€(å¦‚vSCRã€vETHç­‰)

```sql
CREATE TABLE vtoken_state (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- é“¾æ ‡è¯†
    address VARCHAR(66) NOT NULL,               -- VTokenåˆçº¦åœ°å€ (å°å†™)
    symbol VARCHAR(64),                         -- ä»£å¸ç¬¦å· (å¦‚ 'vSCR')
    name VARCHAR(128),                          -- ä»£å¸å…¨ç§°
    decimals INT,                               -- å°æ•°ä½æ•°
    total_supply NUMERIC(78,0),                 -- å½“å‰æ€»ä¾›åº”é‡
    total_minted NUMERIC(78,0),                 -- ç´¯è®¡é“¸é€ é‡
    total_burned NUMERIC(78,0),                 -- ç´¯è®¡é”€æ¯é‡
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_vtoken_state_chain_address ON vtoken_state(chain_id, address);
```

**æ•°æ®æ¥æº**: Subgraph `vtokens` æŸ¥è¯¢  
**æ›´æ–°ç­–ç•¥**: Upsert (æŒ‰ `chain_id + address`)  
**åŒºåˆ«**: ä¸ `token_meta` çš„åŒºåˆ«åœ¨äºåŒ…å«é“¸é€ /é”€æ¯ç»Ÿè®¡,ä¸”ä¸é™äºå…¥æ± Token

#### 4.2.4 Swap äº¤æ˜“è¡¨ (`swap_tx`) - äº¤æ˜“å†å²è®°å½•

**ç”¨é€”**: å­˜å‚¨æ‰€æœ‰Swapäº‹ä»¶çš„è¯¦ç»†è®°å½•

```sql
CREATE TABLE swap_tx (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- é“¾æ ‡è¯†
    tx_hash VARCHAR(128),                       -- äº¤æ˜“å“ˆå¸Œ
    pair_address VARCHAR(66),                   -- Pairåˆçº¦åœ°å€
    sender VARCHAR(66),                         -- å‘èµ·è€…åœ°å€
    amount0_in NUMERIC(78,0),                   -- Token0è¾“å…¥é‡
    amount1_in NUMERIC(78,0),                   -- Token1è¾“å…¥é‡
    amount0_out NUMERIC(78,0),                  -- Token0è¾“å‡ºé‡
    amount1_out NUMERIC(78,0),                  -- Token1è¾“å‡ºé‡
    to_address VARCHAR(66),                     -- æ¥æ”¶åœ°å€
    block_number BIGINT,                        -- åŒºå—å·
    block_timestamp BIGINT,                     -- åŒºå—æ—¶é—´æˆ³
    log_index INT,                              -- æ—¥å¿—ç´¢å¼•
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_swap_tx_chain_txhash_log ON swap_tx(chain_id, tx_hash, log_index);
CREATE INDEX idx_swap_tx_pair ON swap_tx(pair_address);
CREATE INDEX idx_swap_tx_block ON swap_tx(block_number);
```

**äº‹ä»¶ID**: `tx_hash + log_index` ç¡®ä¿å”¯ä¸€æ€§  
**æŸ¥è¯¢ä¼˜åŒ–**: æŒ‰ `pair_address` æˆ– `block_number` æŸ¥è¯¢å†å²äº¤æ˜“

#### 4.2.5 æµåŠ¨æ€§æ“ä½œè¡¨ (`liquidity_tx`) - æ·»åŠ /ç§»é™¤æµåŠ¨æ€§è®°å½•

**ç”¨é€”**: å­˜å‚¨Mint/Burnäº‹ä»¶(æ·»åŠ /ç§»é™¤æµåŠ¨æ€§)

```sql
CREATE TABLE liquidity_tx (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- é“¾æ ‡è¯†
    tx_hash VARCHAR(128),                       -- äº¤æ˜“å“ˆå¸Œ
    pair_address VARCHAR(66),                   -- Pairåˆçº¦åœ°å€
    sender VARCHAR(66),                         -- æ“ä½œè€…åœ°å€
    amount0 NUMERIC(78,0),                      -- Token0æ•°é‡
    amount1 NUMERIC(78,0),                      -- Token1æ•°é‡
    liquidity_amount NUMERIC(78,0),             -- LP Tokenæ•°é‡
    type VARCHAR(16),                           -- 'MINT' | 'BURN'
    block_number BIGINT,                        -- åŒºå—å·
    block_timestamp BIGINT,                     -- åŒºå—æ—¶é—´æˆ³
    log_index INT,                              -- æ—¥å¿—ç´¢å¼•
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_liquidity_tx_chain_txhash_log ON liquidity_tx(chain_id, tx_hash, log_index);
CREATE INDEX idx_liquidity_tx_pair ON liquidity_tx(pair_address);
```

**ç±»å‹è¯´æ˜**:
- `MINT`: æ·»åŠ æµåŠ¨æ€§
- `BURN`: ç§»é™¤æµåŠ¨æ€§

#### 4.2.6 Bridge å‘é€è®°å½•è¡¨ (`bridge_tx`) - è·¨é“¾å‘é€ä¸»è¡¨

**ç”¨é€”**: å­˜å‚¨Bridge.TransferInitiatedäº‹ä»¶(è·¨é“¾å‘é€çš„æƒå¨è®°å½•)

```sql
CREATE TABLE bridge_tx (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- æºé“¾æ ‡è¯†
    message_id VARCHAR(128) NOT NULL,           -- CCIP messageId (è·¨é“¾å”¯ä¸€æ ‡è¯†)
    sender VARCHAR(66),                         -- å‘é€è€…åœ°å€
    receiver VARCHAR(66),                       -- æ¥æ”¶è€…åœ°å€
    token VARCHAR(66),                          -- Tokenåœ°å€
    amount NUMERIC(78,0),                       -- é‡‘é¢
    pool VARCHAR(66),                           -- TokenPoolåœ°å€
    pay_in_link BOOLEAN,                        -- æ˜¯å¦ç”¨LINKæ”¯ä»˜è´¹ç”¨
    ccip_fee NUMERIC(78,0),                     -- CCIPåè®®è´¹ç”¨
    service_fee_paid NUMERIC(78,0),             -- æœåŠ¡è´¹
    status VARCHAR(32),                         -- çŠ¶æ€ ('Initiated')
    block_number BIGINT,                        -- åŒºå—å·
    block_timestamp BIGINT,                     -- åŒºå—æ—¶é—´æˆ³
    tx_hash VARCHAR(128),                       -- äº¤æ˜“å“ˆå¸Œ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_bridge_tx_chain_message ON bridge_tx(chain_id, message_id);
CREATE INDEX idx_bridge_tx_txhash ON bridge_tx(tx_hash);
```

**æƒå¨æ ‡è¯†**: `message_id` æ˜¯CCIPç”Ÿæˆçš„å…¨å±€å”¯ä¸€ID  
**çŠ¶æ€è¿½è¸ª**: ç›®å‰ä»…è®°å½• 'Initiated' çŠ¶æ€,æœªæ¥å¯æ‰©å±•ä¸ºå¤šçŠ¶æ€æµè½¬

#### 4.2.7 Bridge Poolæ“ä½œè¡¨ (`bridge_leg`) - è·¨é“¾æ± ä¾§è…¿è®°å½•

**ç”¨é€”**: å­˜å‚¨TokenPoolçš„Locked/Releasedäº‹ä»¶(ç‹¬ç«‹è®°å½•,ä¸å¼ºç»‘messageId)

```sql
CREATE TABLE bridge_leg (
    id BIGSERIAL PRIMARY KEY,
    chain_id VARCHAR(64),                       -- é“¾æ ‡è¯†
    tx_hash VARCHAR(128),                       -- äº¤æ˜“å“ˆå¸Œ
    log_index INT,                              -- æ—¥å¿—ç´¢å¼•
    pool VARCHAR(66),                           -- Poolåˆçº¦åœ°å€
    token VARCHAR(66),                          -- Tokenåœ°å€
    remote_chain_selector BIGINT,               -- è¿œç¨‹é“¾é€‰æ‹©å™¨
    sender VARCHAR(66),                         -- å‘é€è€… (Lockæ—¶æœ‰å€¼)
    recipient VARCHAR(66),                      -- æ¥æ”¶è€… (Releaseæ—¶æœ‰å€¼)
    amount NUMERIC(78,0),                       -- é‡‘é¢
    leg_type VARCHAR(32),                       -- 'LOCKED_OR_BURNED' | 'RELEASED_OR_MINTED'
    correlation_type VARCHAR(16),               -- 'Exact'|'Heuristic'|'None' (å…³è”å¯ä¿¡åº¦)
    message_id VARCHAR(128),                    -- å¯é€‰:ä»…å½“ä¸Šå±‚æ¨æ–­å…³è”æ—¶å¡«å……
    block_number BIGINT,                        -- åŒºå—å·
    block_timestamp BIGINT,                     -- åŒºå—æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_bridge_leg_chain_tx_log ON bridge_leg(chain_id, tx_hash, log_index);
CREATE INDEX idx_bridge_leg_pool ON bridge_leg(pool);
```

**å…³è”ç­–ç•¥è¯´æ˜**:
- Pooläº‹ä»¶æœ¬èº«ä¸å« `message_id`
- `correlation_type` é»˜è®¤ä¸º 'None'
- å¦‚éœ€å…³è”,å¯åœ¨BFFå±‚é€šè¿‡ `txHash` æ¨æ–­(æ ‡è®°ä¸º 'Heuristic')æˆ–é€šè¿‡å…¶ä»–é€»è¾‘ç¡®å®š(æ ‡è®°ä¸º 'Exact')

### 4.3 SubgraphåŒæ­¥é€»è¾‘è¯¦è§£ (SubgraphSyncService)

> **å®ç°æ–‡ä»¶**: `apps/bff/src/main/java/com/dripswap/bff/modules/subgraph/service/SubgraphSyncService.java`  
> **è°ƒåº¦é¢‘ç‡**: æ¯2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ (`@Scheduled(fixedDelayString = "${subgraph.sync-interval-ms:120000}")`)

#### 4.3.1 æ€»ä½“åŒæ­¥æµç¨‹

```java
@Scheduled(fixedDelayString = "${subgraph.sync-interval-ms:120000}")
public void syncAll() {
    // 1. éå†æ‰€æœ‰å¯ç”¨çš„é“¾é…ç½®
    subgraphProperties.getChains().stream()
        .filter(SubgraphProperties.ChainConfig::isEnabled)
        .forEach(chain -> {
            syncChain(chain);  // 2. é€é“¾åŒæ­¥
        });
}

private void syncChain(SubgraphProperties.ChainConfig chain) {
    syncPairs(chain);            // åŒæ­¥äº¤æ˜“å¯¹
    syncTokens(chain);           // åŒæ­¥Tokenå…ƒæ•°æ®
    syncVTokens(chain);          // åŒæ­¥VTokençŠ¶æ€
    syncBridgeTransfers(chain);  // åŒæ­¥è·¨é“¾è®°å½•
}
```

**é…ç½®ç¤ºä¾‹** (application.yaml):
```yaml
subgraph:
  sync-interval-ms: 120000      # 2åˆ†é’Ÿ
  batch-size: 500               # æ¯æ‰¹æ¬¡500æ¡
  retry-count: 3                # å¤±è´¥é‡è¯•3æ¬¡
  chains:
    - id: sepolia
      enabled: true
      endpoint: "https://api.studio.thegraph.com/query/1716244/sepolia/version/latest"
      start-block: 9573280
    - id: scroll-sepolia
      enabled: false              # æš‚æœªå¯ç”¨
```

#### 4.3.2 PairsåŒæ­¥é€»è¾‘ (åŸºäºTimestampæ¸¸æ ‡)

**GraphQLæŸ¥è¯¢**:
```graphql
query($skip:Int!, $first:Int!, $createdAfter:BigInt!) {
  pairs(
    skip: $skip,
    first: $first,
    orderBy: createdAtTimestamp,
    orderDirection: asc,
    where: { createdAtTimestamp_gte: $createdAfter }
  ) {
    id
    token0 { id }
    token1 { id }
    reserve0
    reserve1
    volumeToken0
    volumeToken1
    createdAtTimestamp
  }
}
```

**åŒæ­¥é€»è¾‘**:
```java
protected void syncPairs(SubgraphProperties.ChainConfig chain) {
    // 1. è·å–æ¸¸æ ‡,è¯»å–ä¸Šæ¬¡åŒæ­¥çš„æ—¶é—´æˆ³
    SyncCursorEntity cursor = getOrCreateCursor(chain.getId(), "pair");
    long lastTs = cursor.getLastSyncTimestamp() ?? 0;
    
    // 2. åˆ†é¡µå¾ªç¯æ‹‰å–
    boolean hasMore = true;
    while (hasMore) {
        Map<String, Object> vars = Map.of(
            "skip", 0,
            "first", 500,
            "createdAfter", lastTs
        );
        
        // 3. è¯·æ±‚Subgraph
        Optional<JsonNode> response = graphClient.query(chain.getId(), query, vars);
        JsonNode nodes = response.path("data").path("pairs");
        
        // 4. éå†ç»“æœ,Upsertåˆ°æ•°æ®åº“
        long maxTs = lastTs;
        for (JsonNode n : nodes) {
            PairCacheEntity entity = pairCacheRepository
                .findByChainIdAndAddress(chain.getId(), n.path("id").asText())
                .orElseGet(PairCacheEntity::new);
            
            entity.setChainId(chain.getId());
            entity.setAddress(toLower(n.path("id").asText()));
            entity.setToken0Address(toLower(n.path("token0").path("id").asText()));
            entity.setToken1Address(toLower(n.path("token1").path("id").asText()));
            entity.setReserve0(toBigDecimal(n.path("reserve0")));
            entity.setReserve1(toBigDecimal(n.path("reserve1")));
            entity.setVolumeToken0(toBigDecimal(n.path("volumeToken0")));
            entity.setVolumeToken1(toBigDecimal(n.path("volumeToken1")));
            
            pairCacheRepository.save(entity);
            maxTs = Math.max(maxTs, n.path("createdAtTimestamp").asLong());
        }
        
        // 5. æ›´æ–°æ¸¸æ ‡
        cursor.setLastSyncTimestamp(maxTs);
        syncCursorRepository.save(cursor);
        
        // 6. åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
        hasMore = nodes.size() >= 500;
    }
}
```

**å…³é”®ç‚¹**:
- **å¢é‡åŒæ­¥**: ä½¿ç”¨ `createdAtTimestamp_gte` è¿‡æ»¤,åªæ‹‰å–æ–°å¢æˆ–æ›´æ–°çš„æ•°æ®
- **æ¸¸æ ‡æ›´æ–°**: ä¿å­˜æ‰¹æ¬¡ä¸­æœ€å¤§çš„ `createdAtTimestamp`,ä¸‹æ¬¡ä»æ­¤ç»§ç»­
- **æ–­ç‚¹ç»­ä¼ **: æœåŠ¡é‡å¯åä» `sync_cursor` è¡¨è¯»å–ä¸Šæ¬¡ä½ç½®

#### 4.3.3 TokensåŒæ­¥é€»è¾‘ (åŸºäºIDæ¸¸æ ‡)

**GraphQLæŸ¥è¯¢**:
```graphql
query($first:Int!, $lastId:ID!) {
  tokens(
    first: $first,
    orderBy: id,
    orderDirection: asc,
    where: { id_gt: $lastId }
  ) {
    id
    symbol
    name
    decimals
    totalSupply
  }
}
```

**åŒæ­¥é€»è¾‘**:
```java
protected void syncTokens(SubgraphProperties.ChainConfig chain) {
    SyncCursorEntity cursor = getOrCreateCursor(chain.getId(), "token");
    String lastId = cursor.getLastSyncedId() ?? "";
    
    while (hasMore) {
        Map<String, Object> vars = Map.of(
            "first", 500,
            "lastId", lastId
        );
        
        // ... è¯·æ±‚Subgraphå¹¶å¤„ç†æ•°æ® ...
        
        for (JsonNode n : nodes) {
            String addr = toLower(n.path("id").asText());
            TokenMetaEntity entity = tokenMetaRepository
                .findByChainIdAndAddress(chain.getId(), addr)
                .orElseGet(TokenMetaEntity::new);
            
            entity.setAddress(addr);
            entity.setSymbol(n.path("symbol").asText());
            entity.setName(n.path("name").asText());
            entity.setDecimals(n.path("decimals").asInt());
            entity.setTotalSupply(toBigDecimal(n.path("totalSupply")));
            
            tokenMetaRepository.save(entity);
            lastId = addr;  // æ›´æ–°æ¸¸æ ‡ä¸ºå½“å‰åœ°å€
        }
        
        cursor.setLastSyncedId(lastId);
        syncCursorRepository.save(cursor);
        
        hasMore = nodes.size() >= 500;
    }
}
```

**IDæ¸¸æ ‡ç‰¹ç‚¹**:
- ä½¿ç”¨ `id_gt` è¿‡æ»¤,æŒ‰åœ°å€å­—æ¯åºåˆ†é¡µ
- é€‚ç”¨äºæ— æ—¶é—´æˆ³çš„å®ä½“(å¦‚Token/VToken)
- æ¸¸æ ‡å­˜å‚¨ä¸ºæœ€åå¤„ç†çš„åœ°å€

#### 4.3.4 VTokensåŒæ­¥é€»è¾‘ (åŒTokens,åŸºäºIDæ¸¸æ ‡)

**GraphQLæŸ¥è¯¢**:
```graphql
query($first:Int!, $lastId:ID!) {
  vtokens(
    first: $first,
    orderBy: id,
    orderDirection: asc,
    where: { id_gt: $lastId }
  ) {
    id
    symbol
    name
    decimals
    totalSupply
    totalMinted
    totalBurned
  }
}
```

**åŒæ­¥é€»è¾‘**: ä¸Tokensç±»ä¼¼,é¢å¤–ä¿å­˜ `totalMinted` å’Œ `totalBurned` å­—æ®µ

#### 4.3.5 Bridge TransfersåŒæ­¥é€»è¾‘ (åŸºäºBlockæ¸¸æ ‡)

**GraphQLæŸ¥è¯¢**:
```graphql
query($first:Int!, $lastBlock:BigInt!) {
  bridgeTransfers(
    first: $first,
    orderBy: blockNumber,
    orderDirection: asc,
    where: { blockNumber_gt: $lastBlock }
  ) {
    id
    messageId
    sender
    receiver
    token
    amount
    pool
    payInLink
    ccipFee
    serviceFeePaid
    status
    blockNumber
    timestamp
    transactionHash
  }
}
```

**åŒæ­¥é€»è¾‘** (æ ¹æ®statusåˆ†æµ):
```java
protected void syncBridgeTransfers(SubgraphProperties.ChainConfig chain) {
    SyncCursorEntity cursor = getOrCreateCursor(chain.getId(), "bridge_transfer");
    long lastBlock = cursor.getLastSyncBlockNumber() ?? chain.getStartBlock();
    
    while (hasMore) {
        // ... è¯·æ±‚Subgraph ...
        
        long maxBlock = lastBlock;
        for (JsonNode n : nodes) {
            String status = n.path("status").asText();
            long blockNumber = n.path("blockNumber").asLong();
            
            if ("Initiated".equalsIgnoreCase(status)) {
                // å†™å…¥ bridge_tx è¡¨ (å‘é€è®°å½•)
                BridgeTxEntity entity = new BridgeTxEntity();
                entity.setMessageId(n.path("messageId").asText());
                entity.setSender(toLower(n.path("sender").asText()));
                entity.setReceiver(toLower(n.path("receiver").asText()));
                entity.setToken(toLower(n.path("token").asText()));
                entity.setAmount(toBigDecimal(n.path("amount")));
                entity.setPool(toLower(n.path("pool").asText()));
                entity.setPayInLink(n.path("payInLink").asBoolean());
                entity.setCcipFee(toBigDecimal(n.path("ccipFee")));
                entity.setServiceFeePaid(toBigDecimal(n.path("serviceFeePaid")));
                entity.setStatus(status);
                bridgeTxRepository.save(entity);
            } else {
                // å†™å…¥ bridge_leg è¡¨ (Poolä¾§è…¿)
                BridgeLegEntity leg = new BridgeLegEntity();
                leg.setTxHash(n.path("transactionHash").asText());
                leg.setPool(toLower(n.path("pool").asText()));
                leg.setToken(toLower(n.path("token").asText()));
                leg.setAmount(toBigDecimal(n.path("amount")));
                leg.setLegType(status);  // 'LOCKED_OR_BURNED' / 'RELEASED_OR_MINTED'
                leg.setCorrelationType("None");  // é»˜è®¤ä¸å…³è”
                bridgeLegRepository.save(leg);
            }
            
            maxBlock = Math.max(maxBlock, blockNumber);
        }
        
        cursor.setLastSyncBlockNumber(maxBlock);
        syncCursorRepository.save(cursor);
        
        hasMore = nodes.size() >= 500;
    }
}
```

**åˆ†æµç­–ç•¥**:
- `status == 'Initiated'` â†’ å†™å…¥ `bridge_tx` (å«messageIdçš„æƒå¨è®°å½•)
- å…¶ä»–çŠ¶æ€ â†’ å†™å…¥ `bridge_leg` (Pooläº‹ä»¶,æ— messageId)

#### 4.3.6 å®¹é”™ä¸é‡è¯•æœºåˆ¶

**æ¸¸æ ‡åˆå§‹åŒ–**:
```java
private SyncCursorEntity getOrCreateCursor(String chainId, String dataType) {
    return syncCursorRepository.findByChainIdAndDataType(chainId, dataType)
        .orElseGet(() -> {
            SyncCursorEntity c = new SyncCursorEntity();
            c.setChainId(chainId);
            c.setDataType(dataType);
            c.setLastSyncBlockNumber(0L);
            c.setLastSyncTimestamp(0L);
            c.setErrorCount(0);
            return syncCursorRepository.save(c);
        });
}
```

**é”™è¯¯å¤„ç†**:
- Subgraphè¿”å›404/è¶…æ—¶ â†’ è®°å½• `last_error_message`,å¢åŠ  `error_count`
- è¾¾åˆ°é‡è¯•ä¸Šé™ â†’ è·³è¿‡æœ¬æ¬¡åŒæ­¥,ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦
- æ•°æ®éªŒè¯å¤±è´¥(å¦‚æ—  `data` å­—æ®µ) â†’ è®°å½•è­¦å‘Šæ—¥å¿—,ä¸­æ–­æœ¬è½®å¾ªç¯

**åœ°å€è§„èŒƒåŒ–**:
```java
private String toLower(String address) {
    return address == null ? null : address.toLowerCase();
}

private BigDecimal toBigDecimal(JsonNode node) {
    if (node == null || node.isMissingNode()) return BigDecimal.ZERO;
    try {
        return new BigDecimal(node.asText("0"));
    } catch (NumberFormatException e) {
        return BigDecimal.ZERO;
    }
}
```

#### 4.3.7 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æ‰¹é‡å¤„ç†**: æ¯æ‰¹500æ¡,å‡å°‘HTTPè¯·æ±‚æ¬¡æ•°
2. **æ¸¸æ ‡æŒä¹…åŒ–**: æ¯æ‰¹æ¬¡æˆåŠŸåç«‹å³æ›´æ–°æ¸¸æ ‡,é¿å…å¤§æ‰¹é‡æ•°æ®é‡å¤åŒæ­¥
3. **æŒ‰éœ€åŒæ­¥**: ä½¿ç”¨ `where` è¿‡æ»¤æ¡ä»¶,åªæ‹‰å–å¢é‡æ•°æ®
4. **äº‹åŠ¡ä¿æŠ¤**: æ¯ä¸ªåŒæ­¥æ–¹æ³•ä½¿ç”¨ `@Transactional` ç¡®ä¿åŸå­æ€§
5. **é“¾çº§éš”ç¦»**: å•é“¾å¤±è´¥ä¸å½±å“å…¶ä»–é“¾çš„åŒæ­¥

---

### 4.4 API è®¾è®¡ (GraphQL)

```graphql
type Query {
  # Swap æ¨¡å—
  mySwaps(address: String!, chainId: Int, page: Int, limit: Int): SwapConnection!
  
  # Liquidity æ¨¡å—
  myLiquidityHistory(address: String!, page: Int): LiquidityConnection!
  
  # Bridge æ¨¡å—
  myBridges(address: String!, page: Int): BridgeConnection!
  bridge(id: ID!): BridgeTransaction
  
  # Dashboard
  protocolStats: ProtocolStats! # TVL, Volume24h
}

type SwapConnection {
  items: [SwapTransaction!]!
  total: Int!
  page: Int!
}

type SwapTransaction {
  txHash: String!
  timestamp: String!
  tokenIn: TokenInfo!
  tokenOut: TokenInfo!
  amountIn: String!
  amountOut: String!
  status: TxStatus!
}

type BridgeConnection {
  items: [BridgeTransaction!]!
  total: Int!
  page: Int!
}

type BridgeTransaction {
  bridgeId: ID!
  fromChainId: Int!
  toChainId: Int!
  token: TokenInfo!
  amount: String!
  status: String!
  srcTxHash: String
  dstTxHash: String
  timestamp: String!
}
```

---

## 5. ä»»åŠ¡æ¸…å•

### 5.0 Subgraph åŒæ­¥ä»»åŠ¡ï¼ˆé‡æ„ç‰ˆï¼ŒPhase 1ï¼‰

#### 5.0.1 å‡†å¤‡ä¸æ ¡éªŒ
- [ ] ç¡®è®¤åœ°å€ç°¿ï¼š`apps/contracts/deployments/{chain}/address_book.md`ï¼ŒstartBlock å¯¹é½ã€‚  
- [ ] ç¡®è®¤å­å›¾ schema å·²åŒ…å«ç›®æ ‡å®ä½“ï¼ˆBridgeSend/BridgePoolLeg/VTokenState/TokenMeta ç­‰ï¼‰ã€‚  
- [ ] Graph Studio endpoint æ ¡éªŒï¼š`_meta { block { number } }` ç¡®è®¤å¯ç”¨ã€‚  
- [ ] ç”¨ GraphiQL é¢„è·‘å…³é”®æŸ¥è¯¢ï¼š`pairs/tokens`ï¼ˆUniswapï¼‰ã€`vtokens`ï¼ˆVTokenï¼‰ã€`bridgeSends`ã€`bridgePoolLegs`ã€`oracleFeedUpdates`ã€‚

#### 5.0.2 æ•°æ®åº“ä¸æ¨¡å‹
- [ ] åˆ›å»º/æ›´æ–°åŸºç¡€è¡¨ï¼š`pair_cache`ã€`token_meta`ã€`sync_cursor`ã€`swap_tx`ã€`liquidity_tx`ã€`bridge_tx`/`bridge_legs`ï¼ˆå¦‚æœ‰ï¼‰ã€‚  
- [ ] åœ°å€ç»Ÿä¸€å°å†™ï¼Œäº‹ä»¶å®ä½“ä¸»é”®æ¨è `tx_hash + log_index`ï¼›æ¸¸æ ‡è¡¨ç”¨äºæ–­ç‚¹ç»­ä¼ ã€‚  
- [ ] å¿…è¦ç´¢å¼•ï¼š`(chain_id, address)`ã€`(chain_id, data_type)`ã€`timestamp` ç›¸å…³ç´¢å¼•ã€‚

#### 5.0.3 SubgraphSyncServiceï¼ˆæŒ‰åŸŸæ‹†åˆ†ä»»åŠ¡ï¼‰
- [ ] DEX ä»»åŠ¡ï¼šæ‹‰å– `pairs/swaps/liquidity` â†’ Upsert `pair_cache`/`token_meta`/`swap_tx`/`liquidity_tx`ã€‚  
- [ ] VToken ä»»åŠ¡ï¼šæ‹‰å– `vtokens/vtokenTransfers/vtokenMints/vtokenBurns` â†’ Upsert `vtoken_state` + äº‹ä»¶è¡¨ï¼ˆå¦‚éœ€è¦ï¼‰ã€‚  
- [ ] Bridge ä»»åŠ¡ï¼š  
  - `BridgeSend`ï¼ˆTransferInitiatedï¼‰â†’ `bridge_tx`ï¼ˆå« messageId/ccipFee/serviceFee/payInLink/pool/statusï¼‰ã€‚  
  - `BridgePoolLeg`ï¼ˆLockedOrBurned/ReleasedOrMintedï¼‰â†’ `bridge_legs`ï¼Œä¸å¼ºç»‘ messageIdã€‚  
  - é…ç½®ç±» â†’ `bridge_config_events` / `pool_config_events`ã€‚  
- [ ] Oracle ä»»åŠ¡ï¼š`OracleFeedUpdate` â†’ `oracle_feed_updates`ã€‚  
- [ ] æ¯ä¸ªä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹æ¸¸æ ‡ï¼Œæ‰¹é‡åˆ†é¡µï¼ˆé»˜è®¤ 1000ï¼‰ï¼ŒæŒ‡æ•°é€€é¿é‡è¯•ï¼Œå¤±è´¥ä¸ä¸­æ–­å…¶ä»–ä»»åŠ¡ã€‚

#### 5.0.4 é…ç½®ä¸å®¹é”™
- [ ] `subgraph.endpoints.{chain}`ã€`sync-interval`ã€`batch-size`ã€`timeout`ã€`retry-count` é…ç½®åˆ° `application.yaml`ã€‚  
- [ ] å®¹é”™ï¼šé‡è¯• 3 æ¬¡ â†’ fallbackï¼ˆç¼“å­˜/æš‚å­˜ä¸Šæ¬¡æ¸¸æ ‡ï¼‰ï¼Œè®°å½• error_count/last_error_messageã€‚  
- [ ] å¯é€‰ WS å…œåº•ï¼šç›‘å¬å…³é”®äº‹ä»¶å†™ raw_eventsï¼Œå®šæœŸå›å¡«ã€‚  
- [ ] ç¼“å­˜å¤±æ•ˆï¼šåŒæ­¥åç²¾ç¡®åˆ é™¤ `pair:{id}:cache`ã€`token:{id}:meta` ç­‰ã€‚

#### 5.0.5 å•å…ƒä¸é›†æˆæµ‹è¯•
- [ ] Mock Subgraph å“åº”ï¼Œæµ‹è¯•åˆ†é¡µã€æ¸¸æ ‡æ¨è¿›ã€Upsert é€»è¾‘ã€‚  
- [ ] éªŒè¯å°å†™åŒ–ã€ID ç”Ÿæˆï¼ˆtxHash-logIndexï¼‰ã€æ•°å€¼æ ¡éªŒã€‚  
- [ ] å®¹é”™æµ‹è¯•ï¼šSubgraph å®•æœº/è¶…æ—¶ï¼Œé‡è¯•ä¸ fallback ä¸ä¸­æ–­ä»»åŠ¡ã€‚  
- [ ] æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡ 1000 æ¡åŒæ­¥è€—æ—¶ã€æ•°æ®åº“å†™å…¥å‹åŠ›ã€‚

#### 5.0.6 å‰åç«¯è”è°ƒ
- [ ] åœ¨æœ¬åœ° BFF GraphQLï¼ˆæˆ– RESTï¼‰æš´éœ²åŒæ­¥åçš„æŸ¥è¯¢æ¥å£ï¼ˆå¦‚ `myPairs/myBridges/myPortfolio`ï¼‰ã€‚  
- [ ] ç”¨ GraphiQL æˆ–å‰ç«¯é¡µé¢å¯¹æ¯” Subgraph åŸå§‹æ•°æ®ä¸ ETL åæ•°æ®çš„ä¸€è‡´æ€§ï¼ˆæ•°é‡ã€å­—æ®µå€¼ï¼‰ã€‚  
- [ ] å¦‚éœ€è·¨é“¾å…³è”æ˜¾ç¤ºï¼ˆBridgeSend vs PoolLegï¼‰ï¼Œåœ¨ BFF å±‚é€šè¿‡ `messageId`ï¼ˆæƒå¨ï¼‰æˆ– `txHash`ï¼ˆHeuristicï¼Œéœ€æ ‡è®°ï¼‰ç»„åˆï¼Œå‰ç«¯å±•ç¤ºæ—¶åŒºåˆ†æ¥æºã€‚

### 5.1 åŸºç¡€è®¾æ–½ (BFF Core)
- [ ] **WS è¿æ¥ç®¡ç†**ï¼šå®Œå–„ `WsConnectionManager`ï¼Œæ”¯æŒæ–­çº¿é‡è¿ã€‚
- [ ] **äº‹ä»¶è§£ç å™¨**ï¼šåŸºäº ABI è‡ªåŠ¨è§£æ Swap/Mint/Burn/Sync äº‹ä»¶ã€‚
- [ ] **æ•°æ®åº“è¿ç§»**ï¼šåˆ›å»º `swap_tx`, `liquidity_tx`, `token_meta`, `bridge_tx` è¡¨ã€‚

### 5.2 ä¸šåŠ¡å®ç°
- [ ] **Swap ETL**ï¼šç›‘å¬ Swap äº‹ä»¶ -> å…¥åº“ `swap_tx`ã€‚
- [ ] **Liquidity ETL**ï¼šç›‘å¬ Mint/Burn äº‹ä»¶ -> å…¥åº“ `liquidity_tx`ã€‚
- [ ] **Bridge ETL**ï¼šç›‘å¬ MessageSent/Mint äº‹ä»¶ -> å…¥åº“/æ›´æ–° `bridge_tx`ã€‚
- [ ] **Token Sync**ï¼šå¯åŠ¨æ—¶æˆ–å‘ç°æ–° Token æ—¶ï¼ŒåŒæ­¥ Token å…ƒæ•°æ®åˆ° DBã€‚
- [ ] **GraphQL Resolver**ï¼šå®ç° `mySwaps`, `myLiquidityHistory`, `myBridges` æ¥å£ã€‚

---

## 6. ä¾èµ–ä¸é£é™©

- **RPC ç¨³å®šæ€§**ï¼šWebSocket å¯èƒ½ä¼šæ¼äº‹ä»¶ã€‚
  - *ç¼“è§£*ï¼šå®šæœŸï¼ˆå¦‚æ¯ 10 åˆ†é’Ÿï¼‰ä½¿ç”¨ HTTP `getLogs` å›æº¯æ‰«æè¿‡å» N ä¸ªåŒºå—ï¼Œå¡«è¡¥ç©ºç¼ºã€‚
- **æ•°æ®ä¸€è‡´æ€§**ï¼šé‡ç»„ï¼ˆReorgï¼‰å¯èƒ½å¯¼è‡´å·²ç´¢å¼•çš„äº‹ä»¶å¤±æ•ˆã€‚
  - *ç¼“è§£*ï¼šä»…ç´¢å¼•ç¡®è®¤æ•° > N çš„åŒºå—ï¼Œæˆ–å¤„ç† Block Reorg é€»è¾‘ï¼ˆå›æ»š DBï¼‰ã€‚

---

## 7. äº¤ä»˜æ¸…å•

### åç«¯
- [ ] GraphQL Schema å®šä¹‰
- [ ] ETL Ingestion Service
- [ ] API Resolvers
- [ ] DB Schema Migration Scripts

### å‰ç«¯
- [ ] `HistoryTable` é€šç”¨ç»„ä»¶
- [ ] é›†æˆ `mySwaps` æŸ¥è¯¢åˆ° Activity é¡µé¢
- [ ] é›†æˆ `myBridges` æŸ¥è¯¢åˆ° Bridge History é¡µé¢
